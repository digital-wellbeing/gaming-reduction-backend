<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nick Ballou">
<meta name="dcterms.date" content="2025-09-09">

<title>4&nbsp; H3 - Effect of Abstention on Wellbeing – Gaming Reduction Experiment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../scripts/sim_sleepquality_report.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-fe31d7bd2deb2a321418d01dba375a64.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-f22e6b1ee40b1f8b08691e31e3ed3812.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-fe31d7bd2deb2a321418d01dba375a64.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-62394a134fb2c86b7932238ec4c4d7ad.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-9bdbdd4fd3c4ad511c920e18b6a60a5b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-62394a134fb2c86b7932238ec4c4d7ad.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>
<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    window.setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      window.setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    window.hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(darkModeDefault) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const darkModeDefault = false;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !window.hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
    };
    // Switch to dark mode if need be
    if (window.hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../scripts/sim_self_report.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">H3 - Effect of Abstention on Wellbeing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Gaming Reduction Experiment</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://digital-wellbeing.github.io/gaming-reduction-backend/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-git"></i></a>
    <a href="../Gaming-Reduction-Experiment.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simulation-based Power Analysis for Two-arm RCT with Linear and Compositional Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scripts/sim_comp_report.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">H1 - Effect of Abstention on Sendentary Activity</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scripts/sim_sleepquality_report.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">H2 - Effect of Abstention on Sleep Quality</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scripts/sim_self_report.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">H3 - Effect of Abstention on Wellbeing</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">4.1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#take-aways" id="toc-take-aways" class="nav-link" data-scroll-target="#take-aways"><span class="header-section-number">4.1.1</span> Take-aways</a></li>
  <li><a href="#load-libraries" id="toc-load-libraries" class="nav-link" data-scroll-target="#load-libraries"><span class="header-section-number">4.1.2</span> Load Libraries</a></li>
  <li><a href="#simulation-dropout-and-fitting-functions" id="toc-simulation-dropout-and-fitting-functions" class="nav-link" data-scroll-target="#simulation-dropout-and-fitting-functions"><span class="header-section-number">4.1.3</span> Simulation, Dropout, and Fitting Functions</a></li>
  </ul></li>
  <li><a href="#test-and-plot-one-simulated-study" id="toc-test-and-plot-one-simulated-study" class="nav-link" data-scroll-target="#test-and-plot-one-simulated-study"><span class="header-section-number">4.2</span> Test and Plot One Simulated Study</a>
  <ul class="collapse">
  <li><a href="#test-fit-h3a---intention-to-treat" id="toc-test-fit-h3a---intention-to-treat" class="nav-link" data-scroll-target="#test-fit-h3a---intention-to-treat"><span class="header-section-number">4.2.1</span> Test Fit (H3a - intention to treat)</a></li>
  <li><a href="#test-fit-h3b---per-protocol" id="toc-test-fit-h3b---per-protocol" class="nav-link" data-scroll-target="#test-fit-h3b---per-protocol"><span class="header-section-number">4.2.2</span> Test Fit (H3b - per-protocol)</a></li>
  </ul></li>
  <li><a href="#simulated-h3a-power-analysis" id="toc-simulated-h3a-power-analysis" class="nav-link" data-scroll-target="#simulated-h3a-power-analysis"><span class="header-section-number">4.3</span> Simulated H3a power analysis</a>
  <ul class="collapse">
  <li><a href="#minimum-detectable-effect-sizes-at-80-power" id="toc-minimum-detectable-effect-sizes-at-80-power" class="nav-link" data-scroll-target="#minimum-detectable-effect-sizes-at-80-power"><span class="header-section-number">4.3.1</span> Minimum Detectable Effect Sizes at 80% Power</a></li>
  </ul></li>
  <li><a href="#simulated-h3b-power-analysis" id="toc-simulated-h3b-power-analysis" class="nav-link" data-scroll-target="#simulated-h3b-power-analysis"><span class="header-section-number">4.4</span> Simulated H3b power analysis</a>
  <ul class="collapse">
  <li><a href="#minimum-detectable-effect-sizes-at-80-power-h3b---per-protocol" id="toc-minimum-detectable-effect-sizes-at-80-power-h3b---per-protocol" class="nav-link" data-scroll-target="#minimum-detectable-effect-sizes-at-80-power-h3b---per-protocol"><span class="header-section-number">4.4.1</span> Minimum Detectable Effect Sizes at 80% Power (H3b - Per-Protocol)</a></li>
  </ul></li>
  <li><a href="#recalculating-h3b-power-with-corrected-interpretation" id="toc-recalculating-h3b-power-with-corrected-interpretation" class="nav-link" data-scroll-target="#recalculating-h3b-power-with-corrected-interpretation"><span class="header-section-number">4.5</span> Recalculating H3b Power with Corrected Interpretation</a></li>
  <li><a href="#timing-summary" id="toc-timing-summary" class="nav-link" data-scroll-target="#timing-summary"><span class="header-section-number">4.6</span> Timing Summary</a></li>
  <li><a href="#planned-sensitivity-analyses" id="toc-planned-sensitivity-analyses" class="nav-link" data-scroll-target="#planned-sensitivity-analyses"><span class="header-section-number">4.7</span> Planned Sensitivity Analyses</a></li>
  </ul>
<div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="https://digital-wellbeing.github.io/oxford-gaming-study/"><i class="bi bi-link"></i>Participant FAQs</a></li><li><a href="https://github.com/digital-wellbeing/gaming-reduction-backend"><i class="bi bi-github"></i>GitHub Repository</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">H3 - Effect of Abstention on Wellbeing</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta column-body">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nick Ballou </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 9, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">4.1</span> Introduction</h2>
<p>This section demonstrates a complete workflow for generating synthetic data, introducing dropout, and fitting models (a GAM or MLM) to the data. The main focus is on the <code>sim_study</code> function, which orchestrates the data simulation, dropout process, and model fitting.</p>
<p>As an overview, we compare the following possible models for estimating the effect of gaming reduction, for both H3a (the intention-to-treat effect) and H3b (the per-protocol effect; i.e., the effect of actual gaming reduction relative to one’s own baseline). The models we compare are:</p>
<table class="caption-top table">
<caption>ITT = Intention-to-treat; PP = per-protocol</caption>
<colgroup>
<col style="width: 16%">
<col style="width: 30%">
<col style="width: 16%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Model Name</th>
<th>Syntax</th>
<th>Target Effect</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GAM</td>
<td><code>gam(wellbeing ~ condition:intervention_period + age + gender + s(id, bs = "re") + s(day, by = condition, bs = "tp"), correlation = corAR1(form = ~ day | id))</code></td>
<td>ITT</td>
<td></td>
</tr>
<tr class="even">
<td>GAM with no main effect)</td>
<td><code>gam(wellbeing ~         age + gender +         s(id, bs = "re") +         s(day, by = condition, bs = "tp"),       data = dat,       correlation = corCAR1(form = ~ day | id))</code></td>
<td>ITT</td>
<td>Here we do not estimate a parameter for the effect of the intervention directly; rather, we simply fit separate curves to each condition and calculate the average marginal effect using {emmeans}</td>
</tr>
<tr class="odd">
<td>MLM</td>
<td><code>lme(     fixed = wellbeing ~ condition*intervention_period + age + gender,     random = ~ 1|id,     correlation = corCAR1(form = ~ day | id),     method = "ML"   )</code></td>
<td>ITT</td>
<td>Multiple versions of this model failed when including random slopes; we therefore dropped these</td>
</tr>
<tr class="even">
<td>MLM Simple</td>
<td><code>lme(     fixed = wellbeing ~ baseline + condition + age + gender,     random = ~ 1 + condition|id,     correlation = corCAR1(form = ~ day | id),     method = "ML",   )</code></td>
<td>ITT</td>
<td>Here we do not model the baseline (pre-intervention period) itself—we model only the 14-day period when the intervention is active, using average wellbeing during baseline as a covariate</td>
</tr>
<tr class="odd">
<td>GLS (generalized least squares)</td>
<td><code>gls(     wellbeing ~ condition * intervention_period + age + gender,     correlation = corCAR1(form = ~ day | id),   )</code></td>
<td>ITT</td>
<td></td>
</tr>
<tr class="even">
<td>GLS Simple</td>
<td><code>gls(     wellbeing ~ condition + baseline + age + gender,     correlation = corAR1(form = ~ day | id),   )</code></td>
<td>ITT</td>
<td></td>
</tr>
<tr class="odd">
<td>GLS Splines</td>
<td><code>gls(     wellbeing ~ ns(day, df = 4) * intervention_period * condition,,     correlation = corCAR1(form = ~ day | id),     data = dat   )</code></td>
<td>ITT</td>
<td>In this version, we fit a GLS but allow non-linearity in the trajectory of wellbeing using splines</td>
</tr>
<tr class="even">
<td>MLM Reduction</td>
<td><code>lme(     fixed = wellbeing ~ intervention_active*reduction + age + gender,     random = ~ 1 + intervention_active*reduction | id,     correlation = corCAR1(form = ~ day | id)   )</code></td>
<td>PP</td>
<td>Here we test our intended model for the per-protocol effect; <code>reduction</code> is the number of hours played relative to that person’s mean playtime at baseline</td>
</tr>
<tr class="odd">
<td>MLM Reduction Robust</td>
<td><code>lme(     fixed = wellbeing ~ intervention_active*playtime + baseline_playtime + age + gender,     random = ~ 1 | id,     correlation = corCAR1(form = ~ day | id)   )</code></td>
<td>PP</td>
<td>Robust approach without change scores - tests if intervention effect varies by actual playtime levels, controlling for baseline playtime</td>
</tr>
</tbody>
</table>
<section id="take-aways" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="take-aways"><span class="header-section-number">4.1.1</span> Take-aways</h3>
<p>Our simulations show that several models perform well at parameter recovery for the ITT effect, but that the GAM model has the highest power for small effects—the type of effects we believe we are most likely to observed—and for non-linear trajectories over the 14 day period (e.g., an effect that slowly accumulates over a couple of days and then plateaus, or a temporary withdrawal followed by a later improvement). The GAM has approximately 50% power for a standardized effect of .2, and 80% power for a standardized effect of .3, but this varies based the shape of that effect over time.</p>
<p>The MLM Reduction model performs very well, and has &gt;95% power for standardized effects of approximately .2 or greater. The MLM Reduction Robust model provides an alternative approach that avoids potential issues with change scores by directly modeling the relationship between current playtime and outcomes while controlling for baseline differences.</p>
</section>
<section id="load-libraries" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="load-libraries"><span class="header-section-number">4.1.2</span> Load Libraries</h3>
<p>First we load packages with <code>pacman</code>, which is fully compatible with <code>renv</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code (load libraries)</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(tidyverse, qualtRics, lme4, mgcv, marginaleffects, broom, forestplot, broom.mixed, nlme, rms, emmeans, splines, furrr, extraDistr, kableExtra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace your current plan() line with:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">interactive</span>()) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(multisession, <span class="at">workers =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">10</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(multisession, <span class="at">workers =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">10</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostic information about parallel setup</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"=== PARALLEL PROCESSING SETUP ==="</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Total CPU cores detected: "</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of workers allocated: "</span>, <span class="fu">nbrOfWorkers</span>())</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Future plan: "</span>, <span class="fu">paste</span>(<span class="fu">class</span>(<span class="fu">plan</span>()), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"==================================="</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_update</span>(</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"black"</span>),</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="simulation-dropout-and-fitting-functions" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="simulation-dropout-and-fitting-functions"><span class="header-section-number">4.1.3</span> Simulation, Dropout, and Fitting Functions</h3>
<p>Here we define:</p>
<ul>
<li><code>sim_data</code>: Generates synthetic data with random intercepts/slopes and AR(1) errors.</li>
<li><code>sim_dropout</code>: Introduces missingness and dropout in the dataset.</li>
<li><code>fit_*</code>: Fits a statistical model to the simulated data (see table above)</li>
<li><code>sim_study</code>: Ties everything together—generates data, applies dropout, then fits the chosen model and returns a tidy summary.</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show code (sim functions)</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generate Synthetic Data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function simulates synthetic panel data for `n` participants over `n_days` time points,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' with an intervention effect, random intercepts and slopes, and AR(1)-correlated residuals.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of participants. Default is 80.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_days Number of time points per participant.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b Fixed effect of condition (if mediated == FALSE) or a 1-hour reduction in playtime.</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param phi AR(1) autocorrelation coefficient.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sigma AR(1) residual standard deviation.</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># effect parameters</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b =</span> <span class="fl">3.7</span>, <span class="co"># effect in unstandardized units</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu =</span> <span class="fl">78.5</span>, <span class="co"># grand mean of the outcome</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># random effects parameters</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tau_int =</span> <span class="fl">9.7</span>,   <span class="co"># Random intercept SD (between-person variance)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tau_slope =</span> .<span class="dv">05</span>,  <span class="co"># Random slope SD </span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">within_person_sd =</span> <span class="fl">11.8</span>, <span class="co"># Within-person SD</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># AR(1) parameters</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">phi =</span> <span class="fl">0.8</span>,     <span class="co"># Autocorrelation coefficient</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">effect_shape =</span> <span class="st">"grow"</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k =</span> .<span class="dv">5</span>, <span class="co"># affects how quickly the plateau effect plateaus</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mediated =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># playtime parameters</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                     <span class="at">playtime_grand_mean =</span> <span class="dv">1</span>,   <span class="co"># Average baseline playtime in hours</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                     <span class="at">playtime_grand_sd =</span> .<span class="dv">5</span>,   <span class="co"># SD for baseline playtime in log units (log-normal distribution)</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                     <span class="at">daily_play_sd =</span> <span class="fl">0.5</span>      <span class="co"># Daily noise in playtime</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># compliance_mean = 0.7,    # Average reduction (in hours) for intervention group during intervention period</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>)     </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">sample</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">36</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"man"</span>,<span class="st">"woman"</span>,<span class="st">"non-binary"</span>), n, <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">45</span>, .<span class="dv">45</span>, .<span class="dv">1</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">condition =</span> <span class="fu">factor</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"control"</span>, <span class="st">"intervention"</span>), n, <span class="at">replace =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">experimental_condition =</span> <span class="fu">ifelse</span>(condition <span class="sc">==</span> <span class="st">"intervention"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_wb =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, tau_int),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope_wb =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, tau_slope),</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_play =</span> <span class="fu">rlnorm</span>(n, <span class="fu">log</span>(playtime_grand_mean), playtime_grand_sd),</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expand to 28 waves per id</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">crossing</span>(</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span>n_days</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_period =</span> <span class="fu">as.numeric</span>(day <span class="sc">&gt;</span> <span class="dv">7</span> <span class="sc">&amp;</span> day <span class="sc">&lt;</span> <span class="dv">22</span>),</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_active =</span> intervention_period <span class="sc">&amp;</span> condition <span class="sc">==</span> <span class="st">"intervention"</span>,</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use fully-qualified name so the function works even if the extraDistr package</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>      <span class="co"># has not been attached in the worker’s search path.</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">compliance =</span> <span class="fu">ifelse</span>(intervention_active,</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>                          extraDistr<span class="sc">::</span><span class="fu">rkumar</span>(n <span class="sc">*</span> n_days, <span class="at">a =</span> .<span class="dv">05</span>, <span class="at">b =</span> .<span class="dv">1</span>),</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>                          <span class="dv">0</span>),</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>      <span class="co"># In the baseline period, play is just the subject’s baseline plus some day-to-day noise</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the intervention, experimental subjects reduce play by their compliance amount</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">playtime =</span> (<span class="dv">1</span> <span class="sc">-</span> compliance) <span class="sc">*</span> <span class="fu">rlnorm</span>(n, <span class="fu">log</span>(intercept_play), daily_play_sd),</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_time =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        effect_shape <span class="sc">==</span> <span class="st">"plateau"</span> <span class="sc">~</span> <span class="fu">if_else</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>, (b <span class="sc">+</span> slope_wb) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>k <span class="sc">*</span> (day <span class="sc">-</span> <span class="dv">7</span>))), <span class="dv">0</span>),</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        effect_shape <span class="sc">==</span> <span class="st">"grow"</span> <span class="sc">~</span> <span class="fu">if_else</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>, (day <span class="sc">-</span> <span class="dv">7</span>) <span class="sc">*</span> ((b <span class="sc">+</span> slope_wb)<span class="sc">/</span><span class="dv">7</span>), <span class="dv">0</span>),</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_playtime =</span> <span class="fu">mean</span>(playtime[day <span class="sc">&lt;=</span> <span class="dv">7</span>]),</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">reduction =</span> baseline_playtime <span class="sc">-</span> playtime, <span class="co"># The mediator: reduction in play relative to the baseline average</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">sigma =</span> within_person_sd <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>phi<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Generate AR(1) errors for each participant</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">e =</span> <span class="fu">as.numeric</span>(<span class="fu">arima.sim</span>(<span class="at">n =</span> n_days, </span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>                               <span class="at">model =</span> <span class="fu">list</span>(<span class="at">ar =</span> phi), </span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sd =</span> sigma)),</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add random effect + fixed effect + AR(1) error</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">wellbeing =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>        mediated <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">~</span> mu <span class="sc">+</span> </span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>                            intercept_wb <span class="sc">+</span> </span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>                            effect_time <span class="sc">*</span> reduction <span class="sc">+</span> </span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>                            .<span class="dv">01</span><span class="sc">*</span>(age<span class="dv">-18</span>) <span class="sc">+</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>                            <span class="sc">-</span>.<span class="dv">05</span><span class="sc">*</span>gender <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"women"</span>,<span class="st">"non-binary"</span>) <span class="sc">+</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>                            e,</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>        mediated <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">~</span> mu <span class="sc">+</span> </span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>                            intercept_wb <span class="sc">+</span> </span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>                            effect_time <span class="sc">*</span> experimental_condition <span class="sc">*</span> intervention_period <span class="sc">+</span> </span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>                            .<span class="dv">01</span><span class="sc">*</span>(age<span class="dv">-18</span>) <span class="sc">+</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>                            <span class="sc">-</span>.<span class="dv">05</span><span class="sc">*</span>gender <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"women"</span>,<span class="st">"non-binary"</span>) <span class="sc">+</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>                            e</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(., <span class="dv">3</span>)))</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  dat</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a><span class="co">#' Simulate Dropout</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a><span class="co">#' Introduces missingness and dropout into a dataset by randomly assigning records as missing</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a><span class="co">#' or dropped out. Once a participant is dropped out, all subsequent records become missing.</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dat A tibble generated by \code{sim_data()}.</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble of the same structure as \code{dat}, but with some \code{wellbeing} values set to NA.</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>sim_dropout <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>  dropout <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">missing =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">10</span>, .<span class="dv">90</span>)),</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">dropout =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">01</span>, .<span class="dv">99</span>))</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">missing =</span> <span class="fu">ifelse</span>(<span class="fu">cumsum</span>(dropout) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="cn">TRUE</span>, missing),</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> id</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">as.integer</span>(id), day) <span class="sc">|&gt;</span> </span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">wellbeing =</span> <span class="fu">ifelse</span>(missing, <span class="cn">NA</span>, wellbeing))</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>  dropout</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fit a Generalized Additive Model (GAM)</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fits a GAM model to the provided dataset using \code{mgcv::gam}, including an AR(1)</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a><span class="co">#' correlation structure and random intercept for each ID.</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dat A tibble of repeated-measures data (e.g., from \code{sim_data()} and \code{sim_dropout()}).</span></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An object of class \code{gam}, which is the fitted GAM model.</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>fit_gam <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(wellbeing <span class="sc">~</span> </span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>        condition<span class="sc">:</span>intervention_period <span class="sc">+</span> age <span class="sc">+</span> gender <span class="sc">+</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(id, <span class="at">bs =</span> <span class="st">"re"</span>) <span class="sc">+</span> </span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(day, <span class="at">by =</span> condition, <span class="at">bs =</span> <span class="st">"tp"</span>), </span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat,</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id))</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>fit_gam_no_main <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(wellbeing <span class="sc">~</span> </span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>        age <span class="sc">+</span> gender <span class="sc">+</span></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(id, <span class="at">bs =</span> <span class="st">"re"</span>) <span class="sc">+</span> </span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(day, <span class="at">by =</span> condition, <span class="at">bs =</span> <span class="st">"tp"</span>), </span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat,</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id))</span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fit a Multi-Level Model (MLM)</span></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fits a linear mixed-effects model (LME) with random intercept for each ID using \code{lme4::lmer}.</span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dat A tibble of repeated-measures data (e.g., from \code{sim_data()} and \code{sim_dropout()}).</span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An object of class \code{lmerMod}, which is the fitted MLM model.</span></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>fit_mlm <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lme</span>(</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> wellbeing <span class="sc">~</span> condition<span class="sc">*</span>intervention_period <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span><span class="sc">|</span>id,</span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> ctrl,</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>fit_mlm_simple <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># take the mean of days 1-7 </span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">baseline =</span> <span class="fu">mean</span>(wellbeing[day <span class="sc">&lt;</span> <span class="dv">8</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try full model first, then fallback to simpler random effects if needed</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> baseline <span class="sc">+</span> condition <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> condition<span class="sc">|</span>id,</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> tmp</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback: Use random intercept only</span></span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> baseline <span class="sc">+</span> condition <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span><span class="sc">|</span>id,</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> tmp</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>fit_gls <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gls</span>(</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>    wellbeing <span class="sc">~</span> condition <span class="sc">*</span> intervention_period <span class="sc">+</span> age <span class="sc">+</span> gender, </span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>fit_gls_simple <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># take the mean of days 1-7 </span></span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">baseline =</span> <span class="fu">mean</span>(wellbeing[day <span class="sc">&lt;</span> <span class="dv">8</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gls</span>(</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>    wellbeing <span class="sc">~</span> condition <span class="sc">+</span> baseline <span class="sc">+</span> age <span class="sc">+</span> gender, </span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tmp</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>fit_gls_spline <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gls</span>(</span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>    wellbeing <span class="sc">~</span> <span class="fu">ns</span>(day, <span class="at">df =</span> <span class="dv">4</span>) <span class="sc">*</span> intervention_period <span class="sc">*</span> condition,,  </span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat</span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a>fit_mlm_reduction <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try the full model first</span></span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender, </span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> intervention_active<span class="sc">*</span>reduction <span class="sc">|</span> id,</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback 1: Simplify random effects (remove correlation)</span></span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lme</span>(</span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a>        <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>        <span class="at">random =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="fu">pdBlocked</span>(<span class="fu">list</span>(<span class="sc">~</span> <span class="dv">1</span>, <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">-</span> <span class="dv">1</span>))),</span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>        <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> ctrl,</span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Fallback 2: Further simplify random effects</span></span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lme</span>(</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>          <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> intervention_active <span class="sc">|</span> id,</span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>          <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a>          <span class="at">control =</span> ctrl,</span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e3) {</span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback 3: Simplest model that still captures the effect</span></span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lme</span>(</span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>          <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>          <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>          <span class="at">control =</span> ctrl,</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>fit_mlm_reduction_robust <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean data and standardize variables to improve numerical stability</span></span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>  dat_clean <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing)) <span class="sc">|&gt;</span></span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Standardize continuous variables to help with convergence</span></span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>      <span class="at">playtime_std =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(playtime)),</span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_playtime_std =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(baseline_playtime)),</span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>      <span class="at">age_std =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(age))</span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try the full model first</span></span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>playtime_std <span class="sc">+</span> baseline_playtime_std <span class="sc">+</span> age_std <span class="sc">+</span> gender,</span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat_clean</span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback: Try without correlation structure if needed</span></span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lme</span>(</span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>        <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>playtime_std <span class="sc">+</span> baseline_playtime_std <span class="sc">+</span> age_std <span class="sc">+</span> gender,</span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a>        <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> ctrl,</span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dat_clean</span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb2-355"><a href="#cb2-355" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Final fallback: Use original (non-standardized) variables without correlation</span></span>
<span id="cb2-356"><a href="#cb2-356" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lme</span>(</span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a>        <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>playtime <span class="sc">+</span> baseline_playtime <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a>        <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> ctrl,</span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to extract the focal effect for GLS models</span></span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>extract_marginal_effect <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, dat, <span class="at">focal_term =</span> <span class="st">"conditionintervention"</span>) {</span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we assume your GLS model is specified with condition*intervention_period</span></span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and you want the effect of condition (e.g., intervention vs. control) during intervention.</span></span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We create a reference grid that fixes intervention_period at 1.</span></span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a>  rg <span class="ot">&lt;-</span> <span class="fu">ref_grid</span>(mod, <span class="at">data =</span> dat, <span class="at">at =</span> <span class="fu">list</span>(<span class="at">intervention_period =</span> <span class="dv">1</span>))</span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain estimated marginal means for each condition.</span></span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a>  emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(rg, <span class="sc">~</span> condition)</span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the pairwise contrast (e.g., intervention - control)</span></span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust names as needed. The contrast below returns a one-row summary.</span></span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a>  contr <span class="ot">&lt;-</span> emmeans<span class="sc">::</span><span class="fu">contrast</span>(emm, <span class="at">method =</span> <span class="fu">list</span>(<span class="st">"intervention - control"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)), <span class="at">adjust =</span> <span class="st">"none"</span>)</span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a>  contr_sum <span class="ot">&lt;-</span> <span class="fu">summary</span>(contr, <span class="at">infer =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct a one-row data frame with consistent column names.</span></span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If you have more than one contrast, you might need to filter for the one of interest.</span></span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">term =</span> focal_term,</span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> contr_sum<span class="sc">$</span>estimate,</span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">std.error =</span> contr_sum<span class="sc">$</span>SE,</span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.low =</span> contr_sum<span class="sc">$</span>lower.CL,</span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.high =</span> contr_sum<span class="sc">$</span>upper.CL,</span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">row.names =</span> <span class="cn">NULL</span></span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a><span class="co">#' Simulation Study Orchestrator</span></span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a><span class="co">#' A higher-level function that ties together data simulation, dropout, and model fitting,</span></span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a><span class="co">#' returning a tidy summary of the fitted model parameters.</span></span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param model_function A function to fit the model. Defaults to \code{fit_gam}.</span></span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of participants passed to \code{sim_data()}. Default is 1000.</span></span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_days Number of time points per participant passed to \code{sim_data()}. Default is 28.</span></span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b Fixed effect for the intervention slope passed to \code{sim_data()}. Default is 0.01.</span></span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param phi AR(1) autocorrelation coefficient passed to \code{sim_data()}. Default is 0.7.</span></span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sigma AR(1) residual standard deviation passed to \code{sim_data()}. Default is 0.6.</span></span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame (tibble) of model estimates from \code{broom::tidy(parametric = TRUE)}.</span></span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Updated simulation orchestrator that handles GLS models separately.</span></span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a>sim_study <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">model =</span> <span class="st">"fit_gam"</span>, <span class="at">focal_term =</span> <span class="st">"intervention_activeTRUE:reduction"</span>, ...) {</span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(sim_data, args)</span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a>  model_function <span class="ot">&lt;-</span> <span class="fu">get</span>(model)</span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">model_function</span>(dat)</span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (model <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"fit_gam_no_main"</span>,<span class="st">"fit_gls_spline"</span>)) {</span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the effect using our helper function.</span></span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(<span class="fu">extract_marginal_effect</span>(mod, </span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>                                                       dat, </span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">focal_term =</span> focal_term))</span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For models that work with broom, extract the focal parameter.</span></span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust the filtering term as needed.</span></span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(mod, <span class="at">parametric =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(term <span class="sc">==</span> focal_term) <span class="sc">|&gt;</span> </span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a>      <span class="co"># filter(</span></span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   term == "conditionintervention:intervention_period" | </span></span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a>      <span class="co">#     (model %in% c("fit_mlm_simple","fit_gls_simple") &amp; term == "conditionintervention")</span></span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a>      <span class="co"># ) |&gt; </span></span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> std.error,</span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> std.error</span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="test-and-plot-one-simulated-study" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="test-and-plot-one-simulated-study"><span class="header-section-number">4.2</span> Test and Plot One Simulated Study</h2>
<p>Below, we create a sample dataset using <code>sim_data()</code> and examine it with a line plots by day. We can also see whether the simulated SDs for wellbeing align with the target values in the simulation—luckily, they do.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code (descriptive plotting)</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(<span class="at">effect_shape =</span> <span class="st">"plateau"</span>, <span class="at">mediated =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>sds <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_value =</span> <span class="fu">mean</span>(wellbeing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd_within  =</span> <span class="fu">sd</span>(wellbeing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">between_sd   =</span> <span class="fu">sd</span>(mean_value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">avg_within_sd =</span> <span class="fu">mean</span>(sd_within, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot wellbeing by group</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(condition, day) <span class="sc">|&gt;</span> </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">wellbeing =</span> <span class="fu">mean</span>(wellbeing)) <span class="sc">|&gt;</span> </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> wellbeing, <span class="at">x =</span> day, <span class="at">color =</span> condition)) <span class="sc">+</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sim_self_report_files/figure-html/test-plot-descriptive-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="test-fit-h3a---intention-to-treat" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="test-fit-h3a---intention-to-treat"><span class="header-section-number">4.2.1</span> Test Fit (H3a - intention to treat)</h3>
<p>We fit various models to the newly simulated data to make sure each appears to be working properly, and also test the full <code>sim_study</code> pipeline.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of participants passed to \code{sim_data()}. Default is 1000.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(<span class="at">mediated =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm_simple</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gls</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gls_simple</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gls_spline</span>(dat) <span class="sc">|&gt;</span> <span class="fu">extract_marginal_effect</span>()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gam</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gam_no_main</span>(dat) <span class="sc">|&gt;</span> <span class="fu">extract_marginal_effect</span>()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">sim_study</span>(<span class="at">model =</span> <span class="st">"fit_gam_no_main"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sim_study</span>(<span class="at">model =</span> <span class="st">"fit_gls_spline"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Since some models (e.g., <code>fit_gam_no_main</code>) do not have a parameter that represents the average difference-in-difference between groups during the intervention period, we need to calculate this ourselves by marginalize across the 14-day intervention period.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code (test emmeans)</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>emm_day <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_gls_spline</span>(dat), </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  pairwise <span class="sc">~</span> condition <span class="sc">|</span> day, </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(<span class="at">day =</span> <span class="dv">8</span><span class="sc">:</span><span class="dv">21</span>), </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">condition =</span> <span class="fu">c</span>(<span class="st">"control"</span>, <span class="st">"intervention"</span>), </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">condition =</span> <span class="fu">factor</span>(condition, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"intervention"</span>, <span class="st">"control"</span>)))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(emm_day<span class="sc">$</span>contrasts, <span class="at">infer =</span> <span class="cn">TRUE</span>, <span class="at">level =</span> .<span class="dv">95</span>, <span class="at">by =</span> <span class="cn">NULL</span>, <span class="at">adjust =</span> <span class="st">"none"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># and then integrated over the 14 day intervention period</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>rg <span class="ot">&lt;-</span> <span class="fu">ref_grid</span>(<span class="fu">fit_gls_spline</span>(dat),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">at =</span> <span class="fu">list</span>(<span class="at">intervention_period =</span> <span class="dv">1</span>),</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">cov.reduce =</span> <span class="fu">list</span>(<span class="at">day =</span> mean),</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">condition =</span> <span class="fu">factor</span>(condition, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"control"</span>,<span class="st">"intervention"</span>))))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(rg, <span class="sc">~</span> condition)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>(contrast_result <span class="ot">&lt;-</span> <span class="fu">contrast</span>(emm, <span class="at">method =</span> <span class="fu">list</span>(<span class="st">"intervention - control"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)), <span class="at">adjust =</span> <span class="st">"none"</span>))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">summary</span>(emm)<span class="sc">$</span>emmean</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(means) <span class="ot">&lt;-</span> <span class="fu">summary</span>(emm)<span class="sc">$</span>condition</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>(diff_manual <span class="ot">&lt;-</span> means[<span class="st">"intervention"</span>] <span class="sc">-</span> means[<span class="st">"control"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="test-fit-h3b---per-protocol" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="test-fit-h3b---per-protocol"><span class="header-section-number">4.2.2</span> Test Fit (H3b - per-protocol)</h3>
<p>Another quick test of our <code>fit_mlm_reduction</code> model, to make sure the alternative simulation whereby the effect of the intervention is mediated by a reduction in playtime is also functioning properly.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code (test fit h3b)</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(<span class="at">mediated =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm_reduction</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm_reduction_robust</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="simulated-h3a-power-analysis" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="simulated-h3a-power-analysis"><span class="header-section-number">4.3</span> Simulated H3a power analysis</h2>
<p>To assess power/sensitivity, we run multiple simulations (controlled by <code>n_sims</code>) and gather the parameter estimates for a particular term (e.g., <code>conditionintervention:intervention_periodTRUE</code>, or for our marginalized effect <code>conditionintervention</code>). Each iteration calls <code>sim_study</code>, which does the data generation, dropout, and fitting.</p>
<p>As this is quite slow, we both use parallel processing with <code>furrr</code> cache the results.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code (simulate power h3a)</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tictoc for timing if not already loaded</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(tictoc, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"tictoc"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tictoc)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cached results exist</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>cache_file_h3a <span class="ot">&lt;-</span> <span class="st">"cache/h3a_simulation_results.rds"</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>cache_summary_h3a <span class="ot">&lt;-</span> <span class="st">"cache/h3a_simulation_summary.rds"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>cache_params_h3a <span class="ot">&lt;-</span> <span class="st">"cache/h3a_simulation_params.rds"</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key parameters that would invalidate cache</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>current_params_h3a <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_sims =</span> <span class="dv">500</span>,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_int =</span> <span class="fl">9.7</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_slope =</span> <span class="fl">0.8</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">within_person_sd =</span> <span class="fl">11.8</span>,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">phi =</span> <span class="fl">0.7</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>, <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gls_spline"</span>),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shapes =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare job specifications irrespective of cache status</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures that variables such as `specs_h3a`, `all_jobs_h3a`, and</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># related helpers are available even when we load results from cache,</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co"># avoiding downstream errors (e.g., `all_jobs_h3a` not found).</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>specs_h3a <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>, <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gls_spline"</span>),  <span class="co"># model names as strings</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shape =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">focal_term =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"fit_mlm_simple"</span>,<span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gam_no_main"</span>) <span class="sc">~</span> <span class="st">"conditionintervention"</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"fit_gam"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_spline"</span>) <span class="sc">~</span> <span class="st">"conditionintervention:intervention_period"</span>,</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"conditionintervention:intervention_period"</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  (<span class="cf">function</span>(d) { d<span class="sc">$</span>row_id <span class="ot">&lt;-</span> <span class="fu">pmap_chr</span>(d, <span class="sc">~</span> <span class="fu">paste0</span>(<span class="fu">names</span>(<span class="fu">list</span>(...)), <span class="st">"="</span>, <span class="fu">c</span>(...), <span class="at">collapse =</span> <span class="st">"_"</span>)); d })() <span class="sc">|&gt;</span> </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">row_number</span>())</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Create all spec-simulation combinations for better parallelization</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>all_jobs_h3a <span class="ot">&lt;-</span> specs_h3a <span class="sc">|&gt;</span> </span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(<span class="at">sim =</span> <span class="dv">1</span><span class="sc">:</span>n_sims) <span class="sc">|&gt;</span> </span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job_id =</span> <span class="fu">row_number</span>())</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cache exists and parameters match</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>cache_valid_h3a <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(cache_file_h3a) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_summary_h3a) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_params_h3a)) {</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  cached_params_h3a <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_params_h3a)</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  cache_valid_h3a <span class="ot">&lt;-</span> <span class="fu">identical</span>(current_params_h3a, cached_params_h3a)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (cache_valid_h3a) {</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Loading cached H3a simulation results..."</span>)</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>  results_h3a <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_file_h3a)</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3a <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_summary_h3a)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Cached H3a results loaded successfully!"</span>)</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No cached H3a results found or parameters changed. Running H3a simulations..."</span>)</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create cache directory if it doesn't exist</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"cache"</span>)) {</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="st">"cache"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start timing</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>(<span class="st">"H3a simulation total time"</span>)</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n_sims is already defined above</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Running "</span>, <span class="fu">nrow</span>(all_jobs_h3a), <span class="st">" simulations across "</span>, <span class="fu">nbrOfWorkers</span>(), <span class="st">" cores..."</span>)</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run all simulations in parallel</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  results_h3a <span class="ot">&lt;-</span> <span class="fu">future_map_dfr</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(all_jobs_h3a), <span class="cf">function</span>(job_idx) {</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load required libraries in each worker</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tidyverse)</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(nlme)</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(mgcv)</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(broom.mixed)</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(emmeans)</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get job parameters</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>    job <span class="ot">&lt;-</span> all_jobs_h3a[job_idx, ]</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">sim_study</span>(</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">focal_term =</span> job<span class="sc">$</span>focal_term,</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># effect parameters</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b, <span class="co"># effect in unstandardized units</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu =</span> <span class="fl">78.5</span>, <span class="co"># grand mean of the outcome</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape,</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>        <span class="at">k =</span> .<span class="dv">5</span>,</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># random effects parameters</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_int =</span> <span class="fl">9.7</span>,   <span class="co"># Random intercept SD (between-person variance)</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_slope =</span> .<span class="dv">8</span>,  <span class="co"># Random slope SD </span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">within_person_sd =</span> <span class="fl">11.8</span>, <span class="co"># Within-person SD</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># AR(1) parameters</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>        <span class="at">phi =</span> <span class="fl">0.7</span>,     <span class="co"># Autocorrelation coefficient</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">mediated =</span> <span class="cn">FALSE</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>          <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>          <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>          <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>          <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(result)</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Only show debug messages if debug mode is enabled and in interactive mode</span></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"debug_mode"</span>, <span class="cn">FALSE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">interactive</span>()) {</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Job "</span>, job_idx, <span class="st">" (spec row: "</span>, job<span class="sc">$</span>i, <span class="st">", sim: "</span>, job<span class="sc">$</span>sim, <span class="st">") failed: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">term =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">std.error =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.low =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.high =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>        <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options =</span> <span class="fu">furrr_options</span>(</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">globals =</span> <span class="fu">c</span>(<span class="st">"all_jobs_h3a"</span>, <span class="st">"sim_study"</span>, <span class="st">"sim_data"</span>, </span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>,</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>,</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>,</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gls_spline"</span>, </span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>                <span class="st">"extract_marginal_effect"</span>),</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">TRUE</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3a <span class="ot">&lt;-</span> results_h3a <span class="sc">|&gt;</span> </span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(row_id) <span class="sc">|&gt;</span> </span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">first</span>(model),</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">first</span>(b),</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_shape =</span> <span class="fu">first</span>(effect_shape),</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_effect =</span> <span class="fu">mean</span>(estimate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.low =</span> <span class="fu">mean</span>(conf.low, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.high =</span> <span class="fu">mean</span>(conf.high, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>      <span class="at">power =</span> <span class="fu">sum</span>(conf.low <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.low))</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stop timing and display results</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>  h3a_time <span class="ot">&lt;-</span> <span class="fu">toc</span>()</span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save results to cache</span></span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_h3a, cache_file_h3a)</span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(sim_summary_h3a, cache_summary_h3a)</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(current_params_h3a, cache_params_h3a)</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"H3a simulation results saved to cache!"</span>)</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End of else block for cached results</span></span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Also print some summary statistics about the simulation</span></span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"=== SIMULATION SUMMARY ==="</span>)</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Total number of jobs: "</span>, <span class="fu">nrow</span>(all_jobs_h3a))</span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of successful results: "</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3a<span class="sc">$</span>estimate)))</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of failed jobs: "</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(results_h3a<span class="sc">$</span>estimate)))</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Success rate: "</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3a<span class="sc">$</span>estimate)) <span class="sc">/</span> <span class="fu">nrow</span>(results_h3a), <span class="dv">1</span>), <span class="st">"%"</span>)</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"============================"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code (visualize power h3a)</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated effect vs. true effect (b)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3a, <span class="fu">aes</span>(<span class="at">x =</span> b, <span class="at">y =</span> mean_effect, <span class="at">color =</span> model, <span class="at">alpha =</span> model <span class="sc">==</span> <span class="st">"fit_gam"</span>)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean_conf.low, <span class="at">ymax =</span> mean_conf.high), <span class="at">width =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect (unstandardized b)"</span>, <span class="at">y =</span> <span class="st">"Estimated Effect"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Estimated vs. True Effects by Model and Effect Shape"</span>) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect (b/12)"</span>)) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.3</span>), <span class="at">guide =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sim_self_report_files/figure-html/visualize-power-h3a-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3a)</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Power vs. true effect (b)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3a, <span class="fu">aes</span>(<span class="at">x =</span> b, <span class="at">y =</span> power, <span class="at">color =</span> model, <span class="at">alpha =</span> model <span class="sc">==</span> <span class="st">"fit_gam"</span>)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect (unstandardized b)"</span>, <span class="at">y =</span> <span class="st">"Power"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Power by Model and Effect Shape"</span>) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect (b/12)"</span>)) <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.3</span>), <span class="at">guide =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sim_self_report_files/figure-html/visualize-power-h3a-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3a)</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># results |&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   forestplot(mean = estimate,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#              lower = conf.low,</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              upper = conf.high,</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#              labeltext = term)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="minimum-detectable-effect-sizes-at-80-power" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="minimum-detectable-effect-sizes-at-80-power"><span class="header-section-number">4.3.1</span> Minimum Detectable Effect Sizes at 80% Power</h3>
<div class="cell">
<details class="code-fold">
<summary>Show code (minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to interpolate minimum detectable effect at 80% power</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>find_mde_80 <span class="ot">&lt;-</span> <span class="cf">function</span>(power_data) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we already have 80% power or higher at the smallest effect, return that</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">min</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;=</span> <span class="fl">0.8</span>) {</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">min</span>(power_data<span class="sc">$</span>b, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we never reach 80% power, return NA</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&lt;</span> <span class="fl">0.8</span>) {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear interpolation to find effect size at 80% power</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">approx</span>(<span class="at">x =</span> power_data<span class="sc">$</span>power, <span class="at">y =</span> power_data<span class="sc">$</span>b, <span class="at">xout =</span> <span class="fl">0.8</span>)<span class="sc">$</span>y</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate minimum detectable effects for each model and effect shape</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>mde_table <span class="ot">&lt;-</span> sim_summary_h3a <span class="sc">|&gt;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_unstandardized =</span> <span class="fu">find_mde_80</span>(<span class="fu">cur_data</span>()),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized =</span> mde_80_unstandardized <span class="sc">/</span> <span class="dv">12</span>,  <span class="co"># Convert to standardized units</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power =</span> <span class="fu">max</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(effect_shape, mde_80_standardized) <span class="sc">|&gt;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up model names for presentation</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gam"</span> <span class="sc">~</span> <span class="st">"GAM"</span>,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gam_no_main"</span> <span class="sc">~</span> <span class="st">"GAM (no main effect)"</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm"</span> <span class="sc">~</span> <span class="st">"MLM"</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_simple"</span> <span class="sc">~</span> <span class="st">"MLM Simple"</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gls"</span> <span class="sc">~</span> <span class="st">"GLS"</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gls_simple"</span> <span class="sc">~</span> <span class="st">"GLS Simple"</span>, </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gls_spline"</span> <span class="sc">~</span> <span class="st">"GLS Splines"</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> model</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format effect sizes for display</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_unstandardized_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_unstandardized), </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"&gt;6.0"</span>, </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">"%.1f"</span>, mde_80_unstandardized)),</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_standardized), </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"&gt;0.50"</span>, </span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, mde_80_standardized)),</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power_fmt =</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, max_power <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Create formatted table</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>mde_table <span class="sc">|&gt;</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Effect Shape</span><span class="st">`</span> <span class="ot">=</span> effect_shape,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Model</span><span class="st">`</span> <span class="ot">=</span> model_clean,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Unstandardized)</span><span class="st">`</span> <span class="ot">=</span> mde_80_unstandardized_fmt,</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Standardized)</span><span class="st">`</span> <span class="ot">=</span> mde_80_standardized_fmt,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Max Power Achieved</span><span class="st">`</span> <span class="ot">=</span> max_power_fmt</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Minimum Detectable Effect Sizes at 80% Power by Model and Effect Shape"</span>,</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>),</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"left"</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Growing Effect"</span>, <span class="dv">1</span>, <span class="fu">sum</span>(mde_table<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Plateau Effect"</span>, <span class="fu">sum</span>(mde_table<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">nrow</span>(mde_table)) <span class="sc">|&gt;</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">footnote</span>(</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">general =</span> <span class="fu">c</span>(</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>      <span class="st">"MDE = Minimum Detectable Effect size at 80% power"</span>,</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Standardized effects calculated as unstandardized effect / 12"</span>,</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Models ordered by sensitivity (smallest MDE first) within each effect shape"</span>,</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>      <span class="st">"'&gt;6.0' and '&gt;0.50' indicate models that did not achieve 80% power at largest tested effect size"</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">general_title =</span> <span class="st">"Notes:"</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<caption>Minimum Detectable Effect Sizes at 80% Power by Model and Effect Shape</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Effect Shape</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MDE (Unstandardized)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MDE (Standardized)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Max Power Achieved</th>
</tr>
</thead>
<tbody>
<tr class="odd" data-grouplength="7">
<td colspan="5" style="border-bottom: 1px solid"><strong>Growing Effect</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">GLS Splines</td>
<td style="text-align: right;">1.2</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-Inf%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">MLM</td>
<td style="text-align: right;">3.4</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">99.8%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">GLS</td>
<td style="text-align: right;">3.8</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">99.8%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">GAM</td>
<td style="text-align: right;">4.5</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">90.2%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">GLS Simple</td>
<td style="text-align: right;">4.8</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">93.0%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">MLM Simple</td>
<td style="text-align: right;">4.9</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">93.6%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">GAM (no main effect)</td>
<td style="text-align: right;">&gt;6.0</td>
<td style="text-align: right;">&gt;0.50</td>
<td style="text-align: right;">72.0%</td>
</tr>
<tr class="odd" data-grouplength="7">
<td colspan="5" style="border-bottom: 1px solid"><strong>Plateau Effect</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">GLS Splines</td>
<td style="text-align: right;">1.2</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-Inf%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">GAM</td>
<td style="text-align: right;">4.6</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">86.2%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">GAM (no main effect)</td>
<td style="text-align: right;">5.2</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">85.2%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">MLM</td>
<td style="text-align: right;">5.2</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">94.2%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">GLS</td>
<td style="text-align: right;">5.4</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">88.0%</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">GLS Simple</td>
<td style="text-align: right;">6.0</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">80.6%</td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">MLM Simple</td>
<td style="text-align: right;">&gt;6.0</td>
<td style="text-align: right;">&gt;0.50</td>
<td style="text-align: right;">77.8%</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="padding: 0"><span style="font-style: italic;">Notes:</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td style="padding: 0"><sup></sup> MDE = Minimum Detectable Effect size at 80% power</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td style="padding: 0"><sup></sup> Standardized effects calculated as unstandardized effect / 12</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td style="padding: 0"><sup></sup> Models ordered by sensitivity (smallest MDE first) within each effect shape</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td style="padding: 0"><sup></sup> '&gt;6.0' and '&gt;0.50' indicate models that did not achieve 80% power at largest tested effect size</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tfoot>

</table>
</div>
<details class="code-fold">
<summary>Show code (minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== SUMMARY OF MODEL PERFORMANCE ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== SUMMARY OF MODEL PERFORMANCE ===</code></pre>
</div>
<details class="code-fold">
<summary>Show code (minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>best_models <span class="ot">&lt;-</span> mde_table <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(mde_80_standardized, <span class="at">na_rm =</span> <span class="cn">TRUE</span>, <span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (shape <span class="cf">in</span> <span class="fu">unique</span>(best_models<span class="sc">$</span>effect_shape)) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">%s effects - Top 3 most sensitive models:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">str_to_title</span>(shape)))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  shape_models <span class="ot">&lt;-</span> best_models <span class="sc">|&gt;</span> <span class="fu">filter</span>(effect_shape <span class="sc">==</span> shape)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(shape_models)) {</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %d. %s: %.2f standardized effect</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                i, shape_models<span class="sc">$</span>model_clean[i], shape_models<span class="sc">$</span>mde_80_standardized[i]))</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Grow effects - Top 3 most sensitive models:
  1. GLS Splines: 0.10 standardized effect
  2. MLM: 0.29 standardized effect
  3. GLS: 0.31 standardized effect

Plateau effects - Top 3 most sensitive models:
  1. GLS Splines: 0.10 standardized effect
  2. GAM: 0.38 standardized effect
  3. GAM (no main effect): 0.43 standardized effect</code></pre>
</div>
<details class="code-fold">
<summary>Show code (minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall best model</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>overall_best <span class="ot">&lt;-</span> mde_table <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mde_80_standardized)) <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(mde_80_standardized, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Overall most sensitive model: %s (%s effects)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            overall_best<span class="sc">$</span>model_clean, overall_best<span class="sc">$</span>effect_shape))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Overall most sensitive model: GLS Splines (grow effects)
 
Overall most sensitive model: GLS Splines (plateau effects)</code></pre>
</div>
<details class="code-fold">
<summary>Show code (minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"MDE at 80%% power: %.2f standardized effect (%.1f unstandardized)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>            overall_best<span class="sc">$</span>mde_80_standardized, overall_best<span class="sc">$</span>mde_80_unstandardized))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MDE at 80% power: 0.10 standardized effect (1.2 unstandardized)
 MDE at 80% power: 0.10 standardized effect (1.2 unstandardized)</code></pre>
</div>
<details class="code-fold">
<summary>Show code (minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=====================================</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=====================================</code></pre>
</div>
</div>
</section>
</section>
<section id="simulated-h3b-power-analysis" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="simulated-h3b-power-analysis"><span class="header-section-number">4.4</span> Simulated H3b power analysis</h2>
<p>Same thing as above, but now looking at power for our per-protocol model.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code (sim study h3b)</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cached results exist</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>cache_file_h3b <span class="ot">&lt;-</span> <span class="st">"cache/h3b_simulation_results.rds"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>cache_summary_h3b <span class="ot">&lt;-</span> <span class="st">"cache/h3b_simulation_summary.rds"</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>cache_params_h3b <span class="ot">&lt;-</span> <span class="st">"cache/h3b_simulation_params.rds"</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key parameters that would invalidate cache</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>current_params_h3b <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_sims =</span> <span class="dv">500</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_int =</span> <span class="fl">9.7</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_slope =</span> <span class="fl">0.8</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">within_person_sd =</span> <span class="fl">11.8</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">phi =</span> <span class="fl">0.7</span>,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span>, <span class="st">"fit_mlm_reduction_robust"</span>),</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shapes =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>),</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">mediated =</span> <span class="cn">TRUE</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare job specifications irrespective of cache status</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures that variables such as `specs_h3b`, `all_jobs_h3b`, and</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co"># related helpers are available even when we load results from cache,</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co"># avoiding downstream errors (e.g., `all_jobs_h3b` not found).</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: With two per-protocol models, this simulation will take approximately </span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co"># twice as long as the original version with just the change score approach</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Note: Running two per-protocol models - simulation time will be longer"</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>specs_h3b <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span>, <span class="st">"fit_mlm_reduction_robust"</span>),  <span class="co"># model names as strings</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>),</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shape =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the mean of the Kumaraswamy distribution - the expected effect size of the mediated version is b * average compliance</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">focal_term =</span> <span class="fu">case_when</span>(</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span> <span class="sc">~</span> <span class="st">"intervention_activeTRUE:reduction"</span>,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span> <span class="sc">~</span> <span class="st">"intervention_activeTRUE:playtime"</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected_effect =</span> b <span class="sc">*</span> .<span class="dv">1</span><span class="sc">*</span><span class="fu">beta</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>.<span class="dv">05</span>, .<span class="dv">1</span>),</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  (\(d) { d<span class="sc">$</span>row_id <span class="ot">&lt;-</span> <span class="fu">pmap_chr</span>(d, <span class="sc">~</span> <span class="fu">paste0</span>(<span class="fu">names</span>(<span class="fu">list</span>(...)), <span class="st">"="</span>, <span class="fu">c</span>(...), <span class="at">collapse =</span> <span class="st">"_"</span>)); d })() <span class="sc">|&gt;</span> </span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">row_number</span>())</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Create all spec-simulation combinations for better parallelization</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>all_jobs_h3b <span class="ot">&lt;-</span> specs_h3b <span class="sc">|&gt;</span> </span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(<span class="at">sim =</span> <span class="dv">1</span><span class="sc">:</span>n_sims) <span class="sc">|&gt;</span> </span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job_id =</span> <span class="fu">row_number</span>())</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cache exists and parameters match</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>cache_valid_h3b <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(cache_file_h3b) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_summary_h3b) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_params_h3b)) {</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  cached_params_h3b <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_params_h3b)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>  cache_valid_h3b <span class="ot">&lt;-</span> <span class="fu">identical</span>(current_params_h3b, cached_params_h3b)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (cache_valid_h3b) {</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Loading cached H3b simulation results..."</span>)</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>  results_h3b <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_file_h3b)</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3b <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_summary_h3b)</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Cached H3b results loaded successfully!"</span>)</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No cached H3b results found or parameters changed. Running H3b simulations..."</span>)</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create cache directory if it doesn't exist</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"cache"</span>)) {</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="st">"cache"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start timing</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>(<span class="st">"H3b simulation total time"</span>)</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n_sims is already defined above</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Running "</span>, <span class="fu">nrow</span>(all_jobs_h3b), <span class="st">" simulations across "</span>, <span class="fu">nbrOfWorkers</span>(), <span class="st">" cores..."</span>)</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run all simulations in parallel</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>  results_h3b <span class="ot">&lt;-</span> <span class="fu">future_map_dfr</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(all_jobs_h3b), <span class="cf">function</span>(job_idx) {</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load required libraries in each worker</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tidyverse)</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(nlme)</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(broom.mixed)</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(extraDistr)</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(rms)</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get job parameters</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>    job <span class="ot">&lt;-</span> all_jobs_h3b[job_idx, ]</span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">sim_study</span>(</span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">focal_term =</span> job<span class="sc">$</span>focal_term,</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># effect parameters</span></span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b, <span class="co"># effect in unstandardized units</span></span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu =</span> <span class="fl">78.5</span>, <span class="co"># grand mean of the outcome</span></span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape,</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>        <span class="at">k =</span> .<span class="dv">5</span>,</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># random effects parameters</span></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_int =</span> <span class="fl">9.7</span>,   <span class="co"># Random intercept SD (between-person variance)</span></span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_slope =</span> .<span class="dv">8</span>,  <span class="co"># Random slope SD </span></span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">within_person_sd =</span> <span class="fl">11.8</span>, <span class="co"># Within-person SD</span></span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># AR(1) parameters</span></span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a>        <span class="at">phi =</span> <span class="fl">0.7</span>,     <span class="co"># Autocorrelation coefficient</span></span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">mediated =</span> <span class="cn">TRUE</span></span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a>          <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a>          <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a>          <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a>          <span class="at">expected_effect =</span> job<span class="sc">$</span>expected_effect,</span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a>          <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(result)</span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Only show debug messages if debug mode is enabled and in interactive mode</span></span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"debug_mode"</span>, <span class="cn">FALSE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">interactive</span>()) {</span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Job "</span>, job_idx, <span class="st">" (spec row: "</span>, job<span class="sc">$</span>i, <span class="st">", sim: "</span>, job<span class="sc">$</span>sim, <span class="st">") failed: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">term =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a>        <span class="at">std.error =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.low =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.high =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a>        <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a>        <span class="at">expected_effect =</span> job<span class="sc">$</span>expected_effect,</span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options =</span> <span class="fu">furrr_options</span>(</span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">globals =</span> <span class="fu">c</span>(<span class="st">"all_jobs_h3b"</span>, <span class="st">"sim_study"</span>, <span class="st">"sim_data"</span>, <span class="st">"fit_mlm_reduction"</span>, <span class="st">"fit_mlm_reduction_robust"</span>,</span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sim_dropout"</span>,</span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>, </span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gls_spline"</span>, <span class="st">"extract_marginal_effect"</span>),</span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">TRUE</span></span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3b <span class="ot">&lt;-</span> results_h3b <span class="sc">|&gt;</span> </span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(row_id) <span class="sc">|&gt;</span> </span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">first</span>(model),</span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">first</span>(b),</span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">expected_effect =</span> <span class="fu">first</span>(expected_effect),</span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_shape =</span> <span class="fu">first</span>(effect_shape),</span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_effect =</span> <span class="fu">mean</span>(estimate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.low =</span> <span class="fu">mean</span>(conf.low, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.high =</span> <span class="fu">mean</span>(conf.high, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Correct power calculation based on model type</span></span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a>      <span class="at">power =</span> <span class="fu">if_else</span>(</span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a>        <span class="fu">first</span>(model) <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>,</span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.high <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.high)),  <span class="co"># Robust expects negative</span></span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.low <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.low))     <span class="co"># Change score expects positive</span></span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stop timing and display results</span></span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a>  h3b_time <span class="ot">&lt;-</span> <span class="fu">toc</span>()</span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save results to cache</span></span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_h3b, cache_file_h3b)</span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(sim_summary_h3b, cache_summary_h3b)</span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(current_params_h3b, cache_params_h3b)</span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"H3b simulation results saved to cache!"</span>)</span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End of else block for cached results</span></span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Also print some summary statistics about the simulation</span></span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"=== H3B SIMULATION SUMMARY ==="</span>)</span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Total number of jobs: "</span>, <span class="fu">nrow</span>(all_jobs_h3b))</span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of successful results: "</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3b<span class="sc">$</span>estimate)))</span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of failed jobs: "</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(results_h3b<span class="sc">$</span>estimate)))</span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Success rate: "</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3b<span class="sc">$</span>estimate)) <span class="sc">/</span> <span class="fu">nrow</span>(results_h3b), <span class="dv">1</span>), <span class="st">"%"</span>)</span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"==============================="</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated effect vs. true effect (b)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3b, <span class="fu">aes</span>(<span class="at">x =</span> expected_effect, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">y =</span> <span class="fu">ifelse</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="sc">-</span>mean_effect, mean_effect), </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">color =</span> model, <span class="at">shape =</span> model)) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="fu">ifelse</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>, </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">-</span>mean_conf.high, mean_conf.low), </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax =</span> <span class="fu">ifelse</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>, </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">-</span>mean_conf.low, mean_conf.high)), </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.01</span>) <span class="sc">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect Magnitude (expected effect)"</span>, </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated Effect Magnitude"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Estimated vs. True Effects by Per-Protocol Model and Effect Shape"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Effects shown as absolute magnitudes for comparison"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Per-Protocol Model"</span>, <span class="at">shape =</span> <span class="st">"Per-Protocol Model"</span>) <span class="sc">+</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>),</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect"</span>)) <span class="sc">+</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"#2E8B57"</span>, </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"#FF6347"</span>),</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>)) <span class="sc">+</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="dv">16</span>, </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="dv">17</span>),</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sim_self_report_files/figure-html/visualize-power-h3b-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Power vs. true effect (b)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3b, <span class="fu">aes</span>(<span class="at">x =</span> expected_effect, <span class="at">y =</span> power, </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">color =</span> model, <span class="at">shape =</span> model, <span class="at">linetype =</span> model)) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect (expected effect)"</span>, <span class="at">y =</span> <span class="st">"Power"</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Power by Per-Protocol Model and Effect Shape"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Per-Protocol Model"</span>, <span class="at">shape =</span> <span class="st">"Per-Protocol Model"</span>, <span class="at">linetype =</span> <span class="st">"Per-Protocol Model"</span>) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect"</span>)) <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"#2E8B57"</span>, </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"#FF6347"</span>),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>)) <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="dv">16</span>, </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="dv">17</span>),</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>)) <span class="sc">+</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"solid"</span>, </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"dashed"</span>),</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="sim_self_report_files/figure-html/visualize-power-h3b-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics comparing the two per-protocol approaches</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>protocol_comparison <span class="ot">&lt;-</span> sim_summary_h3b <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_power =</span> <span class="fu">mean</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power =</span> <span class="fu">max</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_power =</span> <span class="fu">min</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_bias =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(mean_effect <span class="sc">-</span> expected_effect), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_name =</span> <span class="fu">case_when</span>(</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span> <span class="sc">~</span> <span class="st">"Change Score Approach"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span> <span class="sc">~</span> <span class="st">"Robust Approach"</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Display comparison table</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  protocol_comparison,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Comparison of Per-Protocol Approaches for Wellbeing Analysis"</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Effect Shape"</span>, <span class="st">"Mean Power"</span>, <span class="st">"Max Power"</span>, <span class="st">"Min Power"</span>, <span class="st">"Mean Bias"</span>, <span class="st">"Model Name"</span>),</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">3</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Comparison of Per-Protocol Approaches for Wellbeing Analysis</caption>
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: left;">Effect Shape</th>
<th style="text-align: right;">Mean Power</th>
<th style="text-align: right;">Max Power</th>
<th style="text-align: right;">Min Power</th>
<th style="text-align: right;">Mean Bias</th>
<th style="text-align: left;">Model Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fit_mlm_reduction</td>
<td style="text-align: left;">grow</td>
<td style="text-align: right;">0.778</td>
<td style="text-align: right;">0.991</td>
<td style="text-align: right;">0.345</td>
<td style="text-align: right;">0.182</td>
<td style="text-align: left;">Change Score Approach</td>
</tr>
<tr class="even">
<td style="text-align: left;">fit_mlm_reduction</td>
<td style="text-align: left;">plateau</td>
<td style="text-align: right;">0.705</td>
<td style="text-align: right;">0.964</td>
<td style="text-align: right;">0.277</td>
<td style="text-align: right;">0.288</td>
<td style="text-align: left;">Change Score Approach</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary comparison</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== PER-PROTOCOL APPROACH COMPARISON ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== PER-PROTOCOL APPROACH COMPARISON ===</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>change_score_power <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_summary_h3b<span class="sc">$</span>power[sim_summary_h3b<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>robust_power <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_summary_h3b<span class="sc">$</span>power[sim_summary_h3b<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Change Score Approach - Mean Power: %.3f</span><span class="sc">\n</span><span class="st">"</span>, change_score_power))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Change Score Approach - Mean Power: 0.741</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Robust Approach - Mean Power: %.3f</span><span class="sc">\n</span><span class="st">"</span>, robust_power))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Robust Approach - Mean Power: NaN</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Difference: %.3f (robust approach is %.1f%% %s)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>            robust_power <span class="sc">-</span> change_score_power,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">abs</span>(robust_power <span class="sc">-</span> change_score_power) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(robust_power <span class="sc">&gt;</span> change_score_power, <span class="st">"higher"</span>, <span class="st">"lower"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Difference: NaN (robust approach is NaN% NA)</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== IMPORTANT NOTE ON INTERPRETATION ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== IMPORTANT NOTE ON INTERPRETATION ===</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The two per-protocol models test subtly different hypotheses:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The two per-protocol models test subtly different hypotheses:</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Change Score Model: Tests if reduction in playtime improves wellbeing (positive coefficient expected)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>- Change Score Model: Tests if reduction in playtime improves wellbeing (positive coefficient expected)</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Robust Model: Tests if lower playtime is associated with better wellbeing during intervention (negative coefficient expected)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>- Robust Model: Tests if lower playtime is associated with better wellbeing during intervention (negative coefficient expected)</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Both approaches test the same underlying phenomenon but from different angles.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Both approaches test the same underlying phenomenon but from different angles.</code></pre>
</div>
<details class="code-fold">
<summary>Show code (visualize power h3b)</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=========================================</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=========================================</code></pre>
</div>
</div>
<section id="minimum-detectable-effect-sizes-at-80-power-h3b---per-protocol" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="minimum-detectable-effect-sizes-at-80-power-h3b---per-protocol"><span class="header-section-number">4.4.1</span> Minimum Detectable Effect Sizes at 80% Power (H3b - Per-Protocol)</h3>
<div class="cell">
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to interpolate minimum detectable effect at 80% power for H3b</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>find_mde_80_h3b <span class="ot">&lt;-</span> <span class="cf">function</span>(power_data) {</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we already have 80% power or higher at the smallest effect, return that</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">min</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;=</span> <span class="fl">0.8</span>) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">min</span>(power_data<span class="sc">$</span>expected_effect, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we never reach 80% power, return NA</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&lt;</span> <span class="fl">0.8</span>) {</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear interpolation to find effect size at 80% power</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">approx</span>(<span class="at">x =</span> power_data<span class="sc">$</span>power, <span class="at">y =</span> power_data<span class="sc">$</span>expected_effect, <span class="at">xout =</span> <span class="fl">0.8</span>)<span class="sc">$</span>y</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate minimum detectable effects for each H3b model and effect shape</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>mde_table_h3b <span class="ot">&lt;-</span> sim_summary_h3b <span class="sc">|&gt;</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_expected =</span> <span class="fu">find_mde_80_h3b</span>(<span class="fu">cur_data</span>()),</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized =</span> mde_80_expected <span class="sc">/</span> <span class="dv">12</span>,  <span class="co"># Convert to standardized units</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power =</span> <span class="fu">max</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_power =</span> <span class="fu">mean</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(effect_shape, mde_80_standardized) <span class="sc">|&gt;</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up model names for presentation</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span> <span class="sc">~</span> <span class="st">"MLM Reduction (Change Score)"</span>,</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span> <span class="sc">~</span> <span class="st">"MLM Reduction (Robust)"</span>,</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> model</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format effect sizes for display</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_expected_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_expected), </span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"&gt;0.50"</span>, </span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, mde_80_expected)),</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_standardized), </span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"&gt;0.042"</span>, </span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, mde_80_standardized)),</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power_fmt =</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, max_power <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_power_fmt =</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, mean_power <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Create formatted table for H3b</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>mde_table_h3b <span class="sc">|&gt;</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Effect Shape</span><span class="st">`</span> <span class="ot">=</span> effect_shape,</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Model</span><span class="st">`</span> <span class="ot">=</span> model_clean,</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Expected Effect)</span><span class="st">`</span> <span class="ot">=</span> mde_80_expected_fmt,</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Standardized)</span><span class="st">`</span> <span class="ot">=</span> mde_80_standardized_fmt,</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Mean Power</span><span class="st">`</span> <span class="ot">=</span> mean_power_fmt,</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Max Power Achieved</span><span class="st">`</span> <span class="ot">=</span> max_power_fmt</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Minimum Detectable Effect Sizes at 80% Power - H3b Per-Protocol Models"</span>,</span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>)</span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>),</span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"left"</span></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Growing Effect"</span>, <span class="dv">1</span>, <span class="fu">sum</span>(mde_table_h3b<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Plateau Effect"</span>, <span class="fu">sum</span>(mde_table_h3b<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">nrow</span>(mde_table_h3b)) <span class="sc">|&gt;</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">footnote</span>(</span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">general =</span> <span class="fu">c</span>(</span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>      <span class="st">"MDE = Minimum Detectable Effect size at 80% power"</span>,</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Expected Effect = b × average compliance (accounting for Kumaraswamy distribution)"</span>, </span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Standardized effects calculated as expected effect / 12"</span>,</span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Change Score Model tests if reduction improves wellbeing (positive effect)"</span>,</span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Robust Model tests if lower playtime improves wellbeing (negative effect)"</span>,</span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Both models are testing the same underlying hypothesis from different angles"</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">general_title =</span> <span class="st">"Notes:"</span></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<caption>Minimum Detectable Effect Sizes at 80% Power - H3b Per-Protocol Models</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Effect Shape</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MDE (Expected Effect)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MDE (Standardized)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Mean Power</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Max Power Achieved</th>
</tr>
</thead>
<tbody>
<tr class="odd" data-grouplength="1">
<td colspan="6" style="border-bottom: 1px solid"><strong>Growing Effect</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">grow</td>
<td style="text-align: left;">MLM Reduction (Change Score)</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">0.139</td>
<td style="text-align: right;">77.8%</td>
<td style="text-align: right;">99.1%</td>
</tr>
<tr class="odd" data-grouplength="1">
<td colspan="6" style="border-bottom: 1px solid"><strong>Plateau Effect</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding-left: 2em;" data-indentlevel="1">plateau</td>
<td style="text-align: left;">MLM Reduction (Change Score)</td>
<td style="text-align: right;">2.15</td>
<td style="text-align: right;">0.179</td>
<td style="text-align: right;">70.5%</td>
<td style="text-align: right;">96.4%</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="padding: 0"><span style="font-style: italic;">Notes:</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td style="padding: 0"><sup></sup> MDE = Minimum Detectable Effect size at 80% power</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td style="padding: 0"><sup></sup> Expected Effect = b × average compliance (accounting for Kumaraswamy distribution)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td style="padding: 0"><sup></sup> Standardized effects calculated as expected effect / 12</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td style="padding: 0"><sup></sup> Change Score Model tests if reduction improves wellbeing (positive effect)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td style="padding: 0"><sup></sup> Robust Model tests if lower playtime improves wellbeing (negative effect)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td style="padding: 0"><sup></sup> Both models are testing the same underlying hypothesis from different angles</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tfoot>

</table>
</div>
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics for H3b</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== H3B MODEL SENSITIVITY COMPARISON ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== H3B MODEL SENSITIVITY COMPARISON ===</code></pre>
</div>
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare models within each effect shape</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (shape <span class="cf">in</span> <span class="fu">unique</span>(mde_table_h3b<span class="sc">$</span>effect_shape)) {</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">%s effects:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">str_to_title</span>(shape)))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  shape_models <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span> <span class="fu">filter</span>(effect_shape <span class="sc">==</span> shape)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(shape_models)) {</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(shape_models<span class="sc">$</span>mde_80_standardized[i])) {</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %s: %.3f standardized effect (%.1f%% mean power)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>model_clean[i], </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>mde_80_standardized[i],</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>mean_power[i] <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %s: &gt;0.042 standardized effect (%.1f%% max power achieved)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>model_clean[i],</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>max_power[i] <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Grow effects:
  MLM Reduction (Change Score): 0.139 standardized effect (77.8% mean power)

Plateau effects:
  MLM Reduction (Change Score): 0.179 standardized effect (70.5% mean power)</code></pre>
</div>
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall comparison</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>overall_best_h3b <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mde_80_standardized)) <span class="sc">|&gt;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(mde_80_standardized, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(overall_best_h3b) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Most sensitive H3b model: %s (%s effects)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>              overall_best_h3b<span class="sc">$</span>model_clean, overall_best_h3b<span class="sc">$</span>effect_shape))</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"MDE at 80%% power: %.3f standardized effect (%.2f expected effect)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>              overall_best_h3b<span class="sc">$</span>mde_80_standardized, overall_best_h3b<span class="sc">$</span>mde_80_expected))</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Note: No H3b models achieved 80% power within the tested effect range.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"All models have high sensitivity for detecting per-protocol effects.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Most sensitive H3b model: MLM Reduction (Change Score) (grow effects)
MDE at 80% power: 0.139 standardized effect (1.66 expected effect)</code></pre>
</div>
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Power comparison between approaches</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>change_score_data <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>robust_data <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Approach Comparison (averaged across effect shapes):</span><span class="sc">\n</span><span class="st">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Approach Comparison (averaged across effect shapes):</code></pre>
</div>
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Change Score Approach - Mean Power: %.1f%%, Max Power: %.1f%%</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(change_score_data<span class="sc">$</span>mean_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(change_score_data<span class="sc">$</span>max_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Change Score Approach - Mean Power: 74.1%, Max Power: 97.7%</code></pre>
</div>
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Robust Approach - Mean Power: %.1f%%, Max Power: %.1f%%</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(robust_data<span class="sc">$</span>mean_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(robust_data<span class="sc">$</span>max_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Robust Approach - Mean Power: NaN%, Max Power: NaN%</code></pre>
</div>
<details class="code-fold">
<summary>Show code (H3b minimum detectable effects table)</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"==========================================</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>==========================================</code></pre>
</div>
</div>
</section>
</section>
<section id="recalculating-h3b-power-with-corrected-interpretation" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="recalculating-h3b-power-with-corrected-interpretation"><span class="header-section-number">4.5</span> Recalculating H3b Power with Corrected Interpretation</h2>
<p>If you have already run the simulations and need to recalculate the power with the correct interpretation:</p>
<div class="cell">
<details class="code-fold">
<summary>Recalculate H3b power with corrected interpretation</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If you already have results_h3b from a previous simulation run:</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"results_h3b"</span>)) {</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3b_corrected <span class="ot">&lt;-</span> results_h3b <span class="sc">|&gt;</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(row_id) <span class="sc">|&gt;</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">first</span>(model),</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">first</span>(b),</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">expected_effect =</span> <span class="fu">first</span>(expected_effect),</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_shape =</span> <span class="fu">first</span>(effect_shape),</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_effect =</span> <span class="fu">mean</span>(estimate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.low =</span> <span class="fu">mean</span>(conf.low, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.high =</span> <span class="fu">mean</span>(conf.high, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Correct power calculation based on model type</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">power =</span> <span class="fu">if_else</span>(</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">first</span>(model) <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>,</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.high <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.high)),  <span class="co"># Robust expects negative</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.low <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.low))     <span class="co"># Change score expects positive</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Recalculated H3b summary with corrected power calculation"</span>)</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Change Score Approach - Mean Power: "</span>, </span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">round</span>(<span class="fu">mean</span>(sim_summary_h3b_corrected<span class="sc">$</span>power[sim_summary_h3b_corrected<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>))</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Robust Approach - Mean Power: "</span>, </span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>          <span class="fu">round</span>(<span class="fu">mean</span>(sim_summary_h3b_corrected<span class="sc">$</span>power[sim_summary_h3b_corrected<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>))</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="timing-summary" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="timing-summary"><span class="header-section-number">4.6</span> Timing Summary</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code (timing summary)</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print timing summary if timing objects exist from tictoc</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"h3a_time"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"h3b_time"</span>)) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== SIMULATION TIMING SUMMARY ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"H3a simulations took: %.2f minutes</span><span class="sc">\n</span><span class="st">"</span>, (h3a_time<span class="sc">$</span>toc <span class="sc">-</span> h3a_time<span class="sc">$</span>tic) <span class="sc">/</span> <span class="dv">60</span>))</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"H3b simulations took: %.2f minutes</span><span class="sc">\n</span><span class="st">"</span>, (h3b_time<span class="sc">$</span>toc <span class="sc">-</span> h3b_time<span class="sc">$</span>tic) <span class="sc">/</span> <span class="dv">60</span>))</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Total simulation time: %.2f minutes</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>              ((h3a_time<span class="sc">$</span>toc <span class="sc">-</span> h3a_time<span class="sc">$</span>tic) <span class="sc">+</span> (h3b_time<span class="sc">$</span>toc <span class="sc">-</span> h3b_time<span class="sc">$</span>tic)) <span class="sc">/</span> <span class="dv">60</span>))</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"================================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="planned-sensitivity-analyses" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="planned-sensitivity-analyses"><span class="header-section-number">4.7</span> Planned Sensitivity Analyses</h2>
<p>We have preregistered several sensitivity analyses to test the robustness of any effects we find. These include:</p>
<ul>
<li><em>Day 21 only:</em> We will estimate the effect of the intervention on day 21 only, to see what the difference between groups is at the end of the intervention period</li>
<li><em>Marginal means:</em> In H3a, we will use the <code>emmeans</code> package to calculate marginal means for each condition and produce a single parameter by integrating across the 14-day period</li>
<li><em>Multilevel model:</em> We will fit the MLM as defined in Table 1 above, as the second-highest performing model in the simulations (having higher power for linear effects, but lower for non-linear)</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    window.setColorSchemeToggle(window.hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../scripts/sim_sleepquality_report.html" class="pagination-link" aria-label="H2 - Effect of Abstention on Sleep Quality">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">H2 - Effect of Abstention on Sleep Quality</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb63" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "H3 - Effect of Abstention on Wellbeing"</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Show code"</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="an">execute-dir:</span><span class="co"> project</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Nick Ballou"</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>This section demonstrates a complete workflow for generating synthetic data, introducing dropout, and fitting models (a GAM or MLM) to the data. The main focus is on the <span class="in">`sim_study`</span> function, which orchestrates the data simulation, dropout process, and model fitting.</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>As an overview, we compare the following possible models for estimating the effect of gaming reduction, for both H3a (the intention-to-treat effect) and H3b (the per-protocol effect; i.e., the effect of actual gaming reduction relative to one's own baseline). The models we compare are:</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Model Name <span class="pp">|</span> Syntax <span class="pp">|</span> Target Effect <span class="pp">|</span> Notes <span class="pp">|</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------|----------------------|------------|---------------------------|</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GAM <span class="pp">|</span> <span class="in">`gam(wellbeing ~ condition:intervention_period + age + gender + s(id, bs = "re") + s(day, by = condition, bs = "tp"), correlation = corAR1(form = ~ day | id))`</span> <span class="pp">|</span> ITT <span class="pp">|</span>  <span class="pp">|</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GAM with no main effect) <span class="pp">|</span> <span class="in">`gam(wellbeing ~         age + gender +         s(id, bs = "re") +         s(day, by = condition, bs = "tp"),       data = dat,       correlation = corCAR1(form = ~ day | id))`</span> <span class="pp">|</span> ITT <span class="pp">|</span> Here we do not estimate a parameter for the effect of the intervention directly; rather, we simply fit separate curves to each condition and calculate the average marginal effect using {emmeans} <span class="pp">|</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> MLM <span class="pp">|</span> <span class="in">`lme(     fixed = wellbeing ~ condition*intervention_period + age + gender,     random = ~ 1|id,     correlation = corCAR1(form = ~ day | id),     method = "ML"   )`</span> <span class="pp">|</span> ITT <span class="pp">|</span> Multiple versions of this model failed when including random slopes; we therefore dropped these <span class="pp">|</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> MLM Simple <span class="pp">|</span> <span class="in">`lme(     fixed = wellbeing ~ baseline + condition + age + gender,     random = ~ 1 + condition|id,     correlation = corCAR1(form = ~ day | id),     method = "ML",   )`</span> <span class="pp">|</span> ITT <span class="pp">|</span> Here we do not model the baseline (pre-intervention period) itself—we model only the 14-day period when the intervention is active, using average wellbeing during baseline as a covariate <span class="pp">|</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GLS (generalized least squares) <span class="pp">|</span> <span class="in">`gls(     wellbeing ~ condition * intervention_period + age + gender,     correlation = corCAR1(form = ~ day | id),   )`</span> <span class="pp">|</span> ITT <span class="pp">|</span>  <span class="pp">|</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GLS Simple <span class="pp">|</span> <span class="in">`gls(     wellbeing ~ condition + baseline + age + gender,     correlation = corAR1(form = ~ day | id),   )`</span> <span class="pp">|</span> ITT <span class="pp">|</span>  <span class="pp">|</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GLS Splines <span class="pp">|</span> <span class="in">`gls(     wellbeing ~ ns(day, df = 4) * intervention_period * condition,,     correlation = corCAR1(form = ~ day | id),     data = dat   )`</span> <span class="pp">|</span> ITT <span class="pp">|</span> In this version, we fit a GLS but allow non-linearity in the trajectory of wellbeing using splines <span class="pp">|</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> MLM Reduction <span class="pp">|</span> <span class="in">`lme(     fixed = wellbeing ~ intervention_active*reduction + age + gender,     random = ~ 1 + intervention_active*reduction | id,     correlation = corCAR1(form = ~ day | id)   )`</span> <span class="pp">|</span> PP <span class="pp">|</span> Here we test our intended model for the per-protocol effect; <span class="in">`reduction`</span> is the number of hours played relative to that person's mean playtime at baseline <span class="pp">|</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> MLM Reduction Robust <span class="pp">|</span> <span class="in">`lme(     fixed = wellbeing ~ intervention_active*playtime + baseline_playtime + age + gender,     random = ~ 1 | id,     correlation = corCAR1(form = ~ day | id)   )`</span> <span class="pp">|</span> PP <span class="pp">|</span> Robust approach without change scores - tests if intervention effect varies by actual playtime levels, controlling for baseline playtime <span class="pp">|</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>: ITT = Intention-to-treat; PP = per-protocol</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="fu">### Take-aways</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>Our simulations show that several models perform well at parameter recovery for the ITT effect, but that the GAM model has the highest power for small effects---the type of effects we believe we are most likely to observed---and for non-linear trajectories over the 14 day period (e.g., an effect that slowly accumulates over a couple of days and then plateaus, or a temporary withdrawal followed by a later improvement). The GAM has approximately 50% power for a standardized effect of .2, and 80% power for a standardized effect of .3, but this varies based the shape of that effect over time. </span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>The MLM Reduction model performs very well, and has &gt;95% power for standardized effects of approximately .2 or greater. The MLM Reduction Robust model provides an alternative approach that avoids potential issues with change scores by directly modeling the relationship between current playtime and outcomes while controlling for baseline differences.</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load Libraries</span></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>First we load packages with <span class="in">`pacman`</span>, which is fully compatible with <span class="in">`renv`</span>.</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-libraries</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (load libraries)"</span></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman)</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="fu">p_load</span>(tidyverse, qualtRics, lme4, mgcv, marginaleffects, broom, forestplot, broom.mixed, nlme, rms, emmeans, splines, furrr, extraDistr, kableExtra)</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace your current plan() line with:</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">interactive</span>()) {</span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(multisession, <span class="at">workers =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">10</span>)</span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(multisession, <span class="at">workers =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">10</span>)</span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostic information about parallel setup</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"=== PARALLEL PROCESSING SETUP ==="</span>)</span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Total CPU cores detected: "</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of workers allocated: "</span>, <span class="fu">nbrOfWorkers</span>())</span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Future plan: "</span>, <span class="fu">paste</span>(<span class="fu">class</span>(<span class="fu">plan</span>()), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"==================================="</span>)</span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_update</span>(</span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"black"</span>),</span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="dv">1</span>),</span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulation, Dropout, and Fitting Functions</span></span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>Here we define:</span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sim_data`</span>: Generates synthetic data with random intercepts/slopes and AR(1) errors.</span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sim_dropout`</span>: Introduces missingness and dropout in the dataset.</span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`fit_*`</span>: Fits a statistical model to the simulated data (see table above)</span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sim_study`</span>: Ties everything together—generates data, applies dropout, then fits the chosen model and returns a tidy summary.</span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sim-functions</span></span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (sim functions)"</span></span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generate Synthetic Data</span></span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function simulates synthetic panel data for `n` participants over `n_days` time points,</span></span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a><span class="co">#' with an intervention effect, random intercepts and slopes, and AR(1)-correlated residuals.</span></span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of participants. Default is 80.</span></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_days Number of time points per participant.</span></span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b Fixed effect of condition (if mediated == FALSE) or a 1-hour reduction in playtime.</span></span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param phi AR(1) autocorrelation coefficient.</span></span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sigma AR(1) residual standard deviation.</span></span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a>                     <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># effect parameters</span></span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b =</span> <span class="fl">3.7</span>, <span class="co"># effect in unstandardized units</span></span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu =</span> <span class="fl">78.5</span>, <span class="co"># grand mean of the outcome</span></span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># random effects parameters</span></span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tau_int =</span> <span class="fl">9.7</span>,   <span class="co"># Random intercept SD (between-person variance)</span></span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tau_slope =</span> .<span class="dv">05</span>,  <span class="co"># Random slope SD </span></span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a>                     <span class="at">within_person_sd =</span> <span class="fl">11.8</span>, <span class="co"># Within-person SD</span></span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># AR(1) parameters</span></span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a>                     <span class="at">phi =</span> <span class="fl">0.8</span>,     <span class="co"># Autocorrelation coefficient</span></span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a>                     <span class="at">effect_shape =</span> <span class="st">"grow"</span>,</span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k =</span> .<span class="dv">5</span>, <span class="co"># affects how quickly the plateau effect plateaus</span></span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mediated =</span> <span class="cn">FALSE</span>,</span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb63-125"><a href="#cb63-125" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># playtime parameters</span></span>
<span id="cb63-126"><a href="#cb63-126" aria-hidden="true" tabindex="-1"></a>                     <span class="at">playtime_grand_mean =</span> <span class="dv">1</span>,   <span class="co"># Average baseline playtime in hours</span></span>
<span id="cb63-127"><a href="#cb63-127" aria-hidden="true" tabindex="-1"></a>                     <span class="at">playtime_grand_sd =</span> .<span class="dv">5</span>,   <span class="co"># SD for baseline playtime in log units (log-normal distribution)</span></span>
<span id="cb63-128"><a href="#cb63-128" aria-hidden="true" tabindex="-1"></a>                     <span class="at">daily_play_sd =</span> <span class="fl">0.5</span>      <span class="co"># Daily noise in playtime</span></span>
<span id="cb63-129"><a href="#cb63-129" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># compliance_mean = 0.7,    # Average reduction (in hours) for intervention group during intervention period</span></span>
<span id="cb63-130"><a href="#cb63-130" aria-hidden="true" tabindex="-1"></a>)     </span>
<span id="cb63-131"><a href="#cb63-131" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb63-132"><a href="#cb63-132" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb63-133"><a href="#cb63-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb63-134"><a href="#cb63-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">sample</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">36</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-135"><a href="#cb63-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"man"</span>,<span class="st">"woman"</span>,<span class="st">"non-binary"</span>), n, <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">45</span>, .<span class="dv">45</span>, .<span class="dv">1</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-136"><a href="#cb63-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">condition =</span> <span class="fu">factor</span>(<span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"control"</span>, <span class="st">"intervention"</span>), n, <span class="at">replace =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb63-137"><a href="#cb63-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">experimental_condition =</span> <span class="fu">ifelse</span>(condition <span class="sc">==</span> <span class="st">"intervention"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb63-138"><a href="#cb63-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_wb =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, tau_int),</span>
<span id="cb63-139"><a href="#cb63-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope_wb =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, tau_slope),</span>
<span id="cb63-140"><a href="#cb63-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_play =</span> <span class="fu">rlnorm</span>(n, <span class="fu">log</span>(playtime_grand_mean), playtime_grand_sd),</span>
<span id="cb63-141"><a href="#cb63-141" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb63-142"><a href="#cb63-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expand to 28 waves per id</span></span>
<span id="cb63-143"><a href="#cb63-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">crossing</span>(</span>
<span id="cb63-144"><a href="#cb63-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span>n_days</span>
<span id="cb63-145"><a href="#cb63-145" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb63-146"><a href="#cb63-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb63-147"><a href="#cb63-147" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_period =</span> <span class="fu">as.numeric</span>(day <span class="sc">&gt;</span> <span class="dv">7</span> <span class="sc">&amp;</span> day <span class="sc">&lt;</span> <span class="dv">22</span>),</span>
<span id="cb63-148"><a href="#cb63-148" aria-hidden="true" tabindex="-1"></a>      <span class="at">intervention_active =</span> intervention_period <span class="sc">&amp;</span> condition <span class="sc">==</span> <span class="st">"intervention"</span>,</span>
<span id="cb63-149"><a href="#cb63-149" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use fully-qualified name so the function works even if the extraDistr package</span></span>
<span id="cb63-150"><a href="#cb63-150" aria-hidden="true" tabindex="-1"></a>      <span class="co"># has not been attached in the worker’s search path.</span></span>
<span id="cb63-151"><a href="#cb63-151" aria-hidden="true" tabindex="-1"></a>      <span class="at">compliance =</span> <span class="fu">ifelse</span>(intervention_active,</span>
<span id="cb63-152"><a href="#cb63-152" aria-hidden="true" tabindex="-1"></a>                          extraDistr<span class="sc">::</span><span class="fu">rkumar</span>(n <span class="sc">*</span> n_days, <span class="at">a =</span> .<span class="dv">05</span>, <span class="at">b =</span> .<span class="dv">1</span>),</span>
<span id="cb63-153"><a href="#cb63-153" aria-hidden="true" tabindex="-1"></a>                          <span class="dv">0</span>),</span>
<span id="cb63-154"><a href="#cb63-154" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb63-155"><a href="#cb63-155" aria-hidden="true" tabindex="-1"></a>      <span class="co"># In the baseline period, play is just the subject’s baseline plus some day-to-day noise</span></span>
<span id="cb63-156"><a href="#cb63-156" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the intervention, experimental subjects reduce play by their compliance amount</span></span>
<span id="cb63-157"><a href="#cb63-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">playtime =</span> (<span class="dv">1</span> <span class="sc">-</span> compliance) <span class="sc">*</span> <span class="fu">rlnorm</span>(n, <span class="fu">log</span>(intercept_play), daily_play_sd),</span>
<span id="cb63-158"><a href="#cb63-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_time =</span> <span class="fu">case_when</span>(</span>
<span id="cb63-159"><a href="#cb63-159" aria-hidden="true" tabindex="-1"></a>        effect_shape <span class="sc">==</span> <span class="st">"plateau"</span> <span class="sc">~</span> <span class="fu">if_else</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>, (b <span class="sc">+</span> slope_wb) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>k <span class="sc">*</span> (day <span class="sc">-</span> <span class="dv">7</span>))), <span class="dv">0</span>),</span>
<span id="cb63-160"><a href="#cb63-160" aria-hidden="true" tabindex="-1"></a>        effect_shape <span class="sc">==</span> <span class="st">"grow"</span> <span class="sc">~</span> <span class="fu">if_else</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>, (day <span class="sc">-</span> <span class="dv">7</span>) <span class="sc">*</span> ((b <span class="sc">+</span> slope_wb)<span class="sc">/</span><span class="dv">7</span>), <span class="dv">0</span>),</span>
<span id="cb63-161"><a href="#cb63-161" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb63-162"><a href="#cb63-162" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb63-163"><a href="#cb63-163" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb63-164"><a href="#cb63-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb63-165"><a href="#cb63-165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb63-166"><a href="#cb63-166" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb63-167"><a href="#cb63-167" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_playtime =</span> <span class="fu">mean</span>(playtime[day <span class="sc">&lt;=</span> <span class="dv">7</span>]),</span>
<span id="cb63-168"><a href="#cb63-168" aria-hidden="true" tabindex="-1"></a>      <span class="at">reduction =</span> baseline_playtime <span class="sc">-</span> playtime, <span class="co"># The mediator: reduction in play relative to the baseline average</span></span>
<span id="cb63-169"><a href="#cb63-169" aria-hidden="true" tabindex="-1"></a>      <span class="at">sigma =</span> within_person_sd <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>phi<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb63-170"><a href="#cb63-170" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Generate AR(1) errors for each participant</span></span>
<span id="cb63-171"><a href="#cb63-171" aria-hidden="true" tabindex="-1"></a>      <span class="at">e =</span> <span class="fu">as.numeric</span>(<span class="fu">arima.sim</span>(<span class="at">n =</span> n_days, </span>
<span id="cb63-172"><a href="#cb63-172" aria-hidden="true" tabindex="-1"></a>                               <span class="at">model =</span> <span class="fu">list</span>(<span class="at">ar =</span> phi), </span>
<span id="cb63-173"><a href="#cb63-173" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sd =</span> sigma)),</span>
<span id="cb63-174"><a href="#cb63-174" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add random effect + fixed effect + AR(1) error</span></span>
<span id="cb63-175"><a href="#cb63-175" aria-hidden="true" tabindex="-1"></a>      <span class="at">wellbeing =</span> <span class="fu">case_when</span>(</span>
<span id="cb63-176"><a href="#cb63-176" aria-hidden="true" tabindex="-1"></a>        mediated <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">~</span> mu <span class="sc">+</span> </span>
<span id="cb63-177"><a href="#cb63-177" aria-hidden="true" tabindex="-1"></a>                            intercept_wb <span class="sc">+</span> </span>
<span id="cb63-178"><a href="#cb63-178" aria-hidden="true" tabindex="-1"></a>                            effect_time <span class="sc">*</span> reduction <span class="sc">+</span> </span>
<span id="cb63-179"><a href="#cb63-179" aria-hidden="true" tabindex="-1"></a>                            .<span class="dv">01</span><span class="sc">*</span>(age<span class="dv">-18</span>) <span class="sc">+</span></span>
<span id="cb63-180"><a href="#cb63-180" aria-hidden="true" tabindex="-1"></a>                            <span class="sc">-</span>.<span class="dv">05</span><span class="sc">*</span>gender <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"women"</span>,<span class="st">"non-binary"</span>) <span class="sc">+</span></span>
<span id="cb63-181"><a href="#cb63-181" aria-hidden="true" tabindex="-1"></a>                            e,</span>
<span id="cb63-182"><a href="#cb63-182" aria-hidden="true" tabindex="-1"></a>        mediated <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">~</span> mu <span class="sc">+</span> </span>
<span id="cb63-183"><a href="#cb63-183" aria-hidden="true" tabindex="-1"></a>                            intercept_wb <span class="sc">+</span> </span>
<span id="cb63-184"><a href="#cb63-184" aria-hidden="true" tabindex="-1"></a>                            effect_time <span class="sc">*</span> experimental_condition <span class="sc">*</span> intervention_period <span class="sc">+</span> </span>
<span id="cb63-185"><a href="#cb63-185" aria-hidden="true" tabindex="-1"></a>                            .<span class="dv">01</span><span class="sc">*</span>(age<span class="dv">-18</span>) <span class="sc">+</span></span>
<span id="cb63-186"><a href="#cb63-186" aria-hidden="true" tabindex="-1"></a>                            <span class="sc">-</span>.<span class="dv">05</span><span class="sc">*</span>gender <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"women"</span>,<span class="st">"non-binary"</span>) <span class="sc">+</span></span>
<span id="cb63-187"><a href="#cb63-187" aria-hidden="true" tabindex="-1"></a>                            e</span>
<span id="cb63-188"><a href="#cb63-188" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-189"><a href="#cb63-189" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb63-190"><a href="#cb63-190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb63-191"><a href="#cb63-191" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(., <span class="dv">3</span>)))</span>
<span id="cb63-192"><a href="#cb63-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-193"><a href="#cb63-193" aria-hidden="true" tabindex="-1"></a>  dat</span>
<span id="cb63-194"><a href="#cb63-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-195"><a href="#cb63-195" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-196"><a href="#cb63-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-197"><a href="#cb63-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-198"><a href="#cb63-198" aria-hidden="true" tabindex="-1"></a><span class="co">#' Simulate Dropout</span></span>
<span id="cb63-199"><a href="#cb63-199" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-200"><a href="#cb63-200" aria-hidden="true" tabindex="-1"></a><span class="co">#' Introduces missingness and dropout into a dataset by randomly assigning records as missing</span></span>
<span id="cb63-201"><a href="#cb63-201" aria-hidden="true" tabindex="-1"></a><span class="co">#' or dropped out. Once a participant is dropped out, all subsequent records become missing.</span></span>
<span id="cb63-202"><a href="#cb63-202" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-203"><a href="#cb63-203" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dat A tibble generated by \code{sim_data()}.</span></span>
<span id="cb63-204"><a href="#cb63-204" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-205"><a href="#cb63-205" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble of the same structure as \code{dat}, but with some \code{wellbeing} values set to NA.</span></span>
<span id="cb63-206"><a href="#cb63-206" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-207"><a href="#cb63-207" aria-hidden="true" tabindex="-1"></a>sim_dropout <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-208"><a href="#cb63-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-209"><a href="#cb63-209" aria-hidden="true" tabindex="-1"></a>  dropout <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb63-210"><a href="#cb63-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb63-211"><a href="#cb63-211" aria-hidden="true" tabindex="-1"></a>      <span class="at">missing =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">10</span>, .<span class="dv">90</span>)),</span>
<span id="cb63-212"><a href="#cb63-212" aria-hidden="true" tabindex="-1"></a>      <span class="at">dropout =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">01</span>, .<span class="dv">99</span>))</span>
<span id="cb63-213"><a href="#cb63-213" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb63-214"><a href="#cb63-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb63-215"><a href="#cb63-215" aria-hidden="true" tabindex="-1"></a>      <span class="at">missing =</span> <span class="fu">ifelse</span>(<span class="fu">cumsum</span>(dropout) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="cn">TRUE</span>, missing),</span>
<span id="cb63-216"><a href="#cb63-216" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> id</span>
<span id="cb63-217"><a href="#cb63-217" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb63-218"><a href="#cb63-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">as.integer</span>(id), day) <span class="sc">|&gt;</span> </span>
<span id="cb63-219"><a href="#cb63-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">wellbeing =</span> <span class="fu">ifelse</span>(missing, <span class="cn">NA</span>, wellbeing))</span>
<span id="cb63-220"><a href="#cb63-220" aria-hidden="true" tabindex="-1"></a>  dropout</span>
<span id="cb63-221"><a href="#cb63-221" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-222"><a href="#cb63-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-223"><a href="#cb63-223" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fit a Generalized Additive Model (GAM)</span></span>
<span id="cb63-224"><a href="#cb63-224" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-225"><a href="#cb63-225" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fits a GAM model to the provided dataset using \code{mgcv::gam}, including an AR(1)</span></span>
<span id="cb63-226"><a href="#cb63-226" aria-hidden="true" tabindex="-1"></a><span class="co">#' correlation structure and random intercept for each ID.</span></span>
<span id="cb63-227"><a href="#cb63-227" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-228"><a href="#cb63-228" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dat A tibble of repeated-measures data (e.g., from \code{sim_data()} and \code{sim_dropout()}).</span></span>
<span id="cb63-229"><a href="#cb63-229" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-230"><a href="#cb63-230" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An object of class \code{gam}, which is the fitted GAM model.</span></span>
<span id="cb63-231"><a href="#cb63-231" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-232"><a href="#cb63-232" aria-hidden="true" tabindex="-1"></a>fit_gam <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-233"><a href="#cb63-233" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-234"><a href="#cb63-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(wellbeing <span class="sc">~</span> </span>
<span id="cb63-235"><a href="#cb63-235" aria-hidden="true" tabindex="-1"></a>        condition<span class="sc">:</span>intervention_period <span class="sc">+</span> age <span class="sc">+</span> gender <span class="sc">+</span></span>
<span id="cb63-236"><a href="#cb63-236" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(id, <span class="at">bs =</span> <span class="st">"re"</span>) <span class="sc">+</span> </span>
<span id="cb63-237"><a href="#cb63-237" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(day, <span class="at">by =</span> condition, <span class="at">bs =</span> <span class="st">"tp"</span>), </span>
<span id="cb63-238"><a href="#cb63-238" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat,</span>
<span id="cb63-239"><a href="#cb63-239" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id))</span>
<span id="cb63-240"><a href="#cb63-240" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-241"><a href="#cb63-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-242"><a href="#cb63-242" aria-hidden="true" tabindex="-1"></a>fit_gam_no_main <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-243"><a href="#cb63-243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-244"><a href="#cb63-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(wellbeing <span class="sc">~</span> </span>
<span id="cb63-245"><a href="#cb63-245" aria-hidden="true" tabindex="-1"></a>        age <span class="sc">+</span> gender <span class="sc">+</span></span>
<span id="cb63-246"><a href="#cb63-246" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(id, <span class="at">bs =</span> <span class="st">"re"</span>) <span class="sc">+</span> </span>
<span id="cb63-247"><a href="#cb63-247" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(day, <span class="at">by =</span> condition, <span class="at">bs =</span> <span class="st">"tp"</span>), </span>
<span id="cb63-248"><a href="#cb63-248" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat,</span>
<span id="cb63-249"><a href="#cb63-249" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id))</span>
<span id="cb63-250"><a href="#cb63-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-251"><a href="#cb63-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-252"><a href="#cb63-252" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fit a Multi-Level Model (MLM)</span></span>
<span id="cb63-253"><a href="#cb63-253" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-254"><a href="#cb63-254" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fits a linear mixed-effects model (LME) with random intercept for each ID using \code{lme4::lmer}.</span></span>
<span id="cb63-255"><a href="#cb63-255" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-256"><a href="#cb63-256" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param dat A tibble of repeated-measures data (e.g., from \code{sim_data()} and \code{sim_dropout()}).</span></span>
<span id="cb63-257"><a href="#cb63-257" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-258"><a href="#cb63-258" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An object of class \code{lmerMod}, which is the fitted MLM model.</span></span>
<span id="cb63-259"><a href="#cb63-259" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-260"><a href="#cb63-260" aria-hidden="true" tabindex="-1"></a>fit_mlm <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-261"><a href="#cb63-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb63-262"><a href="#cb63-262" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb63-263"><a href="#cb63-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-264"><a href="#cb63-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-265"><a href="#cb63-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb63-266"><a href="#cb63-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb63-267"><a href="#cb63-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb63-268"><a href="#cb63-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb63-269"><a href="#cb63-269" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-270"><a href="#cb63-270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-271"><a href="#cb63-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lme</span>(</span>
<span id="cb63-272"><a href="#cb63-272" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> wellbeing <span class="sc">~</span> condition<span class="sc">*</span>intervention_period <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb63-273"><a href="#cb63-273" aria-hidden="true" tabindex="-1"></a>    <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span><span class="sc">|</span>id,</span>
<span id="cb63-274"><a href="#cb63-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-275"><a href="#cb63-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb63-276"><a href="#cb63-276" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> ctrl,</span>
<span id="cb63-277"><a href="#cb63-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-278"><a href="#cb63-278" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-279"><a href="#cb63-279" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-280"><a href="#cb63-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-281"><a href="#cb63-281" aria-hidden="true" tabindex="-1"></a>fit_mlm_simple <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-282"><a href="#cb63-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb63-283"><a href="#cb63-283" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb63-284"><a href="#cb63-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-285"><a href="#cb63-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-286"><a href="#cb63-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb63-287"><a href="#cb63-287" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb63-288"><a href="#cb63-288" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb63-289"><a href="#cb63-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb63-290"><a href="#cb63-290" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-291"><a href="#cb63-291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-292"><a href="#cb63-292" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb63-293"><a href="#cb63-293" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb63-294"><a href="#cb63-294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># take the mean of days 1-7 </span></span>
<span id="cb63-295"><a href="#cb63-295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">baseline =</span> <span class="fu">mean</span>(wellbeing[day <span class="sc">&lt;</span> <span class="dv">8</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb63-296"><a href="#cb63-296" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-297"><a href="#cb63-297" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-298"><a href="#cb63-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-299"><a href="#cb63-299" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try full model first, then fallback to simpler random effects if needed</span></span>
<span id="cb63-300"><a href="#cb63-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb63-301"><a href="#cb63-301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb63-302"><a href="#cb63-302" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> baseline <span class="sc">+</span> condition <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb63-303"><a href="#cb63-303" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> condition<span class="sc">|</span>id,</span>
<span id="cb63-304"><a href="#cb63-304" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-305"><a href="#cb63-305" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb63-306"><a href="#cb63-306" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb63-307"><a href="#cb63-307" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> tmp</span>
<span id="cb63-308"><a href="#cb63-308" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-309"><a href="#cb63-309" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb63-310"><a href="#cb63-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback: Use random intercept only</span></span>
<span id="cb63-311"><a href="#cb63-311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb63-312"><a href="#cb63-312" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> baseline <span class="sc">+</span> condition <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb63-313"><a href="#cb63-313" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span><span class="sc">|</span>id,</span>
<span id="cb63-314"><a href="#cb63-314" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-315"><a href="#cb63-315" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb63-316"><a href="#cb63-316" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb63-317"><a href="#cb63-317" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> tmp</span>
<span id="cb63-318"><a href="#cb63-318" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-319"><a href="#cb63-319" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb63-320"><a href="#cb63-320" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-321"><a href="#cb63-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-322"><a href="#cb63-322" aria-hidden="true" tabindex="-1"></a>fit_gls <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-323"><a href="#cb63-323" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-324"><a href="#cb63-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gls</span>(</span>
<span id="cb63-325"><a href="#cb63-325" aria-hidden="true" tabindex="-1"></a>    wellbeing <span class="sc">~</span> condition <span class="sc">*</span> intervention_period <span class="sc">+</span> age <span class="sc">+</span> gender, </span>
<span id="cb63-326"><a href="#cb63-326" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-327"><a href="#cb63-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-328"><a href="#cb63-328" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-329"><a href="#cb63-329" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-330"><a href="#cb63-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-331"><a href="#cb63-331" aria-hidden="true" tabindex="-1"></a>fit_gls_simple <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-332"><a href="#cb63-332" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-333"><a href="#cb63-333" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb63-334"><a href="#cb63-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb63-335"><a href="#cb63-335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># take the mean of days 1-7 </span></span>
<span id="cb63-336"><a href="#cb63-336" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">baseline =</span> <span class="fu">mean</span>(wellbeing[day <span class="sc">&lt;</span> <span class="dv">8</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb63-337"><a href="#cb63-337" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(intervention_period <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-338"><a href="#cb63-338" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-339"><a href="#cb63-339" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-340"><a href="#cb63-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gls</span>(</span>
<span id="cb63-341"><a href="#cb63-341" aria-hidden="true" tabindex="-1"></a>    wellbeing <span class="sc">~</span> condition <span class="sc">+</span> baseline <span class="sc">+</span> age <span class="sc">+</span> gender, </span>
<span id="cb63-342"><a href="#cb63-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-343"><a href="#cb63-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tmp</span>
<span id="cb63-344"><a href="#cb63-344" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-345"><a href="#cb63-345" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-346"><a href="#cb63-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-347"><a href="#cb63-347" aria-hidden="true" tabindex="-1"></a>fit_gls_spline <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-348"><a href="#cb63-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gls</span>(</span>
<span id="cb63-349"><a href="#cb63-349" aria-hidden="true" tabindex="-1"></a>    wellbeing <span class="sc">~</span> <span class="fu">ns</span>(day, <span class="at">df =</span> <span class="dv">4</span>) <span class="sc">*</span> intervention_period <span class="sc">*</span> condition,,  </span>
<span id="cb63-350"><a href="#cb63-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-351"><a href="#cb63-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat</span>
<span id="cb63-352"><a href="#cb63-352" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-353"><a href="#cb63-353" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-354"><a href="#cb63-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-355"><a href="#cb63-355" aria-hidden="true" tabindex="-1"></a>fit_mlm_reduction <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-356"><a href="#cb63-356" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb63-357"><a href="#cb63-357" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb63-358"><a href="#cb63-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-359"><a href="#cb63-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-360"><a href="#cb63-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb63-361"><a href="#cb63-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb63-362"><a href="#cb63-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb63-363"><a href="#cb63-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb63-364"><a href="#cb63-364" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-365"><a href="#cb63-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-366"><a href="#cb63-366" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try the full model first</span></span>
<span id="cb63-367"><a href="#cb63-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb63-368"><a href="#cb63-368" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb63-369"><a href="#cb63-369" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender, </span>
<span id="cb63-370"><a href="#cb63-370" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> intervention_active<span class="sc">*</span>reduction <span class="sc">|</span> id,</span>
<span id="cb63-371"><a href="#cb63-371" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-372"><a href="#cb63-372" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb63-373"><a href="#cb63-373" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-374"><a href="#cb63-374" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-375"><a href="#cb63-375" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb63-376"><a href="#cb63-376" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback 1: Simplify random effects (remove correlation)</span></span>
<span id="cb63-377"><a href="#cb63-377" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb63-378"><a href="#cb63-378" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lme</span>(</span>
<span id="cb63-379"><a href="#cb63-379" aria-hidden="true" tabindex="-1"></a>        <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb63-380"><a href="#cb63-380" aria-hidden="true" tabindex="-1"></a>        <span class="at">random =</span> <span class="fu">list</span>(<span class="at">id =</span> <span class="fu">pdBlocked</span>(<span class="fu">list</span>(<span class="sc">~</span> <span class="dv">1</span>, <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">-</span> <span class="dv">1</span>))),</span>
<span id="cb63-381"><a href="#cb63-381" aria-hidden="true" tabindex="-1"></a>        <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-382"><a href="#cb63-382" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> ctrl,</span>
<span id="cb63-383"><a href="#cb63-383" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-384"><a href="#cb63-384" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-385"><a href="#cb63-385" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb63-386"><a href="#cb63-386" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Fallback 2: Further simplify random effects</span></span>
<span id="cb63-387"><a href="#cb63-387" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb63-388"><a href="#cb63-388" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lme</span>(</span>
<span id="cb63-389"><a href="#cb63-389" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb63-390"><a href="#cb63-390" aria-hidden="true" tabindex="-1"></a>          <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> intervention_active <span class="sc">|</span> id,</span>
<span id="cb63-391"><a href="#cb63-391" aria-hidden="true" tabindex="-1"></a>          <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-392"><a href="#cb63-392" aria-hidden="true" tabindex="-1"></a>          <span class="at">control =</span> ctrl,</span>
<span id="cb63-393"><a href="#cb63-393" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-394"><a href="#cb63-394" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb63-395"><a href="#cb63-395" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e3) {</span>
<span id="cb63-396"><a href="#cb63-396" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback 3: Simplest model that still captures the effect</span></span>
<span id="cb63-397"><a href="#cb63-397" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lme</span>(</span>
<span id="cb63-398"><a href="#cb63-398" aria-hidden="true" tabindex="-1"></a>          <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>reduction <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb63-399"><a href="#cb63-399" aria-hidden="true" tabindex="-1"></a>          <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb63-400"><a href="#cb63-400" aria-hidden="true" tabindex="-1"></a>          <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-401"><a href="#cb63-401" aria-hidden="true" tabindex="-1"></a>          <span class="at">control =</span> ctrl,</span>
<span id="cb63-402"><a href="#cb63-402" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-403"><a href="#cb63-403" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb63-404"><a href="#cb63-404" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb63-405"><a href="#cb63-405" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-406"><a href="#cb63-406" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb63-407"><a href="#cb63-407" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-408"><a href="#cb63-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-409"><a href="#cb63-409" aria-hidden="true" tabindex="-1"></a>fit_mlm_reduction_robust <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb63-410"><a href="#cb63-410" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control parameters for better convergence</span></span>
<span id="cb63-411"><a href="#cb63-411" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(</span>
<span id="cb63-412"><a href="#cb63-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-413"><a href="#cb63-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxIter =</span> <span class="dv">200</span>,</span>
<span id="cb63-414"><a href="#cb63-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolerance =</span> <span class="fl">1e-6</span>,</span>
<span id="cb63-415"><a href="#cb63-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">niterEM =</span> <span class="dv">50</span>,</span>
<span id="cb63-416"><a href="#cb63-416" aria-hidden="true" tabindex="-1"></a>    <span class="at">msMaxEval =</span> <span class="dv">400</span>,</span>
<span id="cb63-417"><a href="#cb63-417" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimMethod =</span> <span class="st">"L-BFGS-B"</span></span>
<span id="cb63-418"><a href="#cb63-418" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-419"><a href="#cb63-419" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-420"><a href="#cb63-420" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean data and standardize variables to improve numerical stability</span></span>
<span id="cb63-421"><a href="#cb63-421" aria-hidden="true" tabindex="-1"></a>  dat_clean <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb63-422"><a href="#cb63-422" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing)) <span class="sc">|&gt;</span></span>
<span id="cb63-423"><a href="#cb63-423" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb63-424"><a href="#cb63-424" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Standardize continuous variables to help with convergence</span></span>
<span id="cb63-425"><a href="#cb63-425" aria-hidden="true" tabindex="-1"></a>      <span class="at">playtime_std =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(playtime)),</span>
<span id="cb63-426"><a href="#cb63-426" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline_playtime_std =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(baseline_playtime)),</span>
<span id="cb63-427"><a href="#cb63-427" aria-hidden="true" tabindex="-1"></a>      <span class="at">age_std =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(age))</span>
<span id="cb63-428"><a href="#cb63-428" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-429"><a href="#cb63-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-430"><a href="#cb63-430" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try the full model first</span></span>
<span id="cb63-431"><a href="#cb63-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb63-432"><a href="#cb63-432" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lme</span>(</span>
<span id="cb63-433"><a href="#cb63-433" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>playtime_std <span class="sc">+</span> baseline_playtime_std <span class="sc">+</span> age_std <span class="sc">+</span> gender,</span>
<span id="cb63-434"><a href="#cb63-434" aria-hidden="true" tabindex="-1"></a>      <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb63-435"><a href="#cb63-435" aria-hidden="true" tabindex="-1"></a>      <span class="at">correlation =</span> <span class="fu">corCAR1</span>(<span class="at">form =</span> <span class="sc">~</span> day <span class="sc">|</span> id),</span>
<span id="cb63-436"><a href="#cb63-436" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> ctrl,</span>
<span id="cb63-437"><a href="#cb63-437" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> dat_clean</span>
<span id="cb63-438"><a href="#cb63-438" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-439"><a href="#cb63-439" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb63-440"><a href="#cb63-440" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback: Try without correlation structure if needed</span></span>
<span id="cb63-441"><a href="#cb63-441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb63-442"><a href="#cb63-442" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lme</span>(</span>
<span id="cb63-443"><a href="#cb63-443" aria-hidden="true" tabindex="-1"></a>        <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>playtime_std <span class="sc">+</span> baseline_playtime_std <span class="sc">+</span> age_std <span class="sc">+</span> gender,</span>
<span id="cb63-444"><a href="#cb63-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb63-445"><a href="#cb63-445" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> ctrl,</span>
<span id="cb63-446"><a href="#cb63-446" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dat_clean</span>
<span id="cb63-447"><a href="#cb63-447" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-448"><a href="#cb63-448" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb63-449"><a href="#cb63-449" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Final fallback: Use original (non-standardized) variables without correlation</span></span>
<span id="cb63-450"><a href="#cb63-450" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lme</span>(</span>
<span id="cb63-451"><a href="#cb63-451" aria-hidden="true" tabindex="-1"></a>        <span class="at">fixed =</span> wellbeing <span class="sc">~</span> intervention_active<span class="sc">*</span>playtime <span class="sc">+</span> baseline_playtime <span class="sc">+</span> age <span class="sc">+</span> gender,</span>
<span id="cb63-452"><a href="#cb63-452" aria-hidden="true" tabindex="-1"></a>        <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> id,</span>
<span id="cb63-453"><a href="#cb63-453" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> ctrl,</span>
<span id="cb63-454"><a href="#cb63-454" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(wellbeing))</span>
<span id="cb63-455"><a href="#cb63-455" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-456"><a href="#cb63-456" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-457"><a href="#cb63-457" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb63-458"><a href="#cb63-458" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-459"><a href="#cb63-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-460"><a href="#cb63-460" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to extract the focal effect for GLS models</span></span>
<span id="cb63-461"><a href="#cb63-461" aria-hidden="true" tabindex="-1"></a>extract_marginal_effect <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, dat, <span class="at">focal_term =</span> <span class="st">"conditionintervention"</span>) {</span>
<span id="cb63-462"><a href="#cb63-462" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we assume your GLS model is specified with condition*intervention_period</span></span>
<span id="cb63-463"><a href="#cb63-463" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and you want the effect of condition (e.g., intervention vs. control) during intervention.</span></span>
<span id="cb63-464"><a href="#cb63-464" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We create a reference grid that fixes intervention_period at 1.</span></span>
<span id="cb63-465"><a href="#cb63-465" aria-hidden="true" tabindex="-1"></a>  rg <span class="ot">&lt;-</span> <span class="fu">ref_grid</span>(mod, <span class="at">data =</span> dat, <span class="at">at =</span> <span class="fu">list</span>(<span class="at">intervention_period =</span> <span class="dv">1</span>))</span>
<span id="cb63-466"><a href="#cb63-466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-467"><a href="#cb63-467" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain estimated marginal means for each condition.</span></span>
<span id="cb63-468"><a href="#cb63-468" aria-hidden="true" tabindex="-1"></a>  emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(rg, <span class="sc">~</span> condition)</span>
<span id="cb63-469"><a href="#cb63-469" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-470"><a href="#cb63-470" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the pairwise contrast (e.g., intervention - control)</span></span>
<span id="cb63-471"><a href="#cb63-471" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust names as needed. The contrast below returns a one-row summary.</span></span>
<span id="cb63-472"><a href="#cb63-472" aria-hidden="true" tabindex="-1"></a>  contr <span class="ot">&lt;-</span> emmeans<span class="sc">::</span><span class="fu">contrast</span>(emm, <span class="at">method =</span> <span class="fu">list</span>(<span class="st">"intervention - control"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)), <span class="at">adjust =</span> <span class="st">"none"</span>)</span>
<span id="cb63-473"><a href="#cb63-473" aria-hidden="true" tabindex="-1"></a>  contr_sum <span class="ot">&lt;-</span> <span class="fu">summary</span>(contr, <span class="at">infer =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-474"><a href="#cb63-474" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-475"><a href="#cb63-475" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct a one-row data frame with consistent column names.</span></span>
<span id="cb63-476"><a href="#cb63-476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If you have more than one contrast, you might need to filter for the one of interest.</span></span>
<span id="cb63-477"><a href="#cb63-477" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb63-478"><a href="#cb63-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">term =</span> focal_term,</span>
<span id="cb63-479"><a href="#cb63-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> contr_sum<span class="sc">$</span>estimate,</span>
<span id="cb63-480"><a href="#cb63-480" aria-hidden="true" tabindex="-1"></a>    <span class="at">std.error =</span> contr_sum<span class="sc">$</span>SE,</span>
<span id="cb63-481"><a href="#cb63-481" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.low =</span> contr_sum<span class="sc">$</span>lower.CL,</span>
<span id="cb63-482"><a href="#cb63-482" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.high =</span> contr_sum<span class="sc">$</span>upper.CL,</span>
<span id="cb63-483"><a href="#cb63-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">row.names =</span> <span class="cn">NULL</span></span>
<span id="cb63-484"><a href="#cb63-484" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-485"><a href="#cb63-485" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-486"><a href="#cb63-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb63-487"><a href="#cb63-487" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-488"><a href="#cb63-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-489"><a href="#cb63-489" aria-hidden="true" tabindex="-1"></a><span class="co">#' Simulation Study Orchestrator</span></span>
<span id="cb63-490"><a href="#cb63-490" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-491"><a href="#cb63-491" aria-hidden="true" tabindex="-1"></a><span class="co">#' A higher-level function that ties together data simulation, dropout, and model fitting,</span></span>
<span id="cb63-492"><a href="#cb63-492" aria-hidden="true" tabindex="-1"></a><span class="co">#' returning a tidy summary of the fitted model parameters.</span></span>
<span id="cb63-493"><a href="#cb63-493" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-494"><a href="#cb63-494" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param model_function A function to fit the model. Defaults to \code{fit_gam}.</span></span>
<span id="cb63-495"><a href="#cb63-495" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of participants passed to \code{sim_data()}. Default is 1000.</span></span>
<span id="cb63-496"><a href="#cb63-496" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_days Number of time points per participant passed to \code{sim_data()}. Default is 28.</span></span>
<span id="cb63-497"><a href="#cb63-497" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b Fixed effect for the intervention slope passed to \code{sim_data()}. Default is 0.01.</span></span>
<span id="cb63-498"><a href="#cb63-498" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param phi AR(1) autocorrelation coefficient passed to \code{sim_data()}. Default is 0.7.</span></span>
<span id="cb63-499"><a href="#cb63-499" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sigma AR(1) residual standard deviation passed to \code{sim_data()}. Default is 0.6.</span></span>
<span id="cb63-500"><a href="#cb63-500" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-501"><a href="#cb63-501" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame (tibble) of model estimates from \code{broom::tidy(parametric = TRUE)}.</span></span>
<span id="cb63-502"><a href="#cb63-502" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb63-503"><a href="#cb63-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-504"><a href="#cb63-504" aria-hidden="true" tabindex="-1"></a><span class="co"># Updated simulation orchestrator that handles GLS models separately.</span></span>
<span id="cb63-505"><a href="#cb63-505" aria-hidden="true" tabindex="-1"></a>sim_study <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">model =</span> <span class="st">"fit_gam"</span>, <span class="at">focal_term =</span> <span class="st">"intervention_activeTRUE:reduction"</span>, ...) {</span>
<span id="cb63-506"><a href="#cb63-506" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb63-507"><a href="#cb63-507" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(sim_data, args)</span>
<span id="cb63-508"><a href="#cb63-508" aria-hidden="true" tabindex="-1"></a>  model_function <span class="ot">&lt;-</span> <span class="fu">get</span>(model)</span>
<span id="cb63-509"><a href="#cb63-509" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-510"><a href="#cb63-510" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">model_function</span>(dat)</span>
<span id="cb63-511"><a href="#cb63-511" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-512"><a href="#cb63-512" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (model <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"fit_gam_no_main"</span>,<span class="st">"fit_gls_spline"</span>)) {</span>
<span id="cb63-513"><a href="#cb63-513" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the effect using our helper function.</span></span>
<span id="cb63-514"><a href="#cb63-514" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(<span class="fu">extract_marginal_effect</span>(mod, </span>
<span id="cb63-515"><a href="#cb63-515" aria-hidden="true" tabindex="-1"></a>                                                       dat, </span>
<span id="cb63-516"><a href="#cb63-516" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">focal_term =</span> focal_term))</span>
<span id="cb63-517"><a href="#cb63-517" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb63-518"><a href="#cb63-518" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For models that work with broom, extract the focal parameter.</span></span>
<span id="cb63-519"><a href="#cb63-519" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust the filtering term as needed.</span></span>
<span id="cb63-520"><a href="#cb63-520" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(mod, <span class="at">parametric =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-521"><a href="#cb63-521" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(term <span class="sc">==</span> focal_term) <span class="sc">|&gt;</span> </span>
<span id="cb63-522"><a href="#cb63-522" aria-hidden="true" tabindex="-1"></a>      <span class="co"># filter(</span></span>
<span id="cb63-523"><a href="#cb63-523" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   term == "conditionintervention:intervention_period" | </span></span>
<span id="cb63-524"><a href="#cb63-524" aria-hidden="true" tabindex="-1"></a>      <span class="co">#     (model %in% c("fit_mlm_simple","fit_gls_simple") &amp; term == "conditionintervention")</span></span>
<span id="cb63-525"><a href="#cb63-525" aria-hidden="true" tabindex="-1"></a>      <span class="co"># ) |&gt; </span></span>
<span id="cb63-526"><a href="#cb63-526" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb63-527"><a href="#cb63-527" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> std.error,</span>
<span id="cb63-528"><a href="#cb63-528" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> std.error</span>
<span id="cb63-529"><a href="#cb63-529" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-530"><a href="#cb63-530" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-531"><a href="#cb63-531" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb63-532"><a href="#cb63-532" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-533"><a href="#cb63-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-534"><a href="#cb63-534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-535"><a href="#cb63-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-536"><a href="#cb63-536" aria-hidden="true" tabindex="-1"></a><span class="fu">## Test and Plot One Simulated Study</span></span>
<span id="cb63-537"><a href="#cb63-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-538"><a href="#cb63-538" aria-hidden="true" tabindex="-1"></a>Below, we create a sample dataset using <span class="in">`sim_data()`</span> and examine it with a line plots by day. We can also see whether the simulated SDs for wellbeing align with the target values in the simulation---luckily, they do.</span>
<span id="cb63-539"><a href="#cb63-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-542"><a href="#cb63-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-543"><a href="#cb63-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test-plot-descriptive</span></span>
<span id="cb63-544"><a href="#cb63-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (descriptive plotting)"</span></span>
<span id="cb63-545"><a href="#cb63-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-546"><a href="#cb63-546" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(<span class="at">effect_shape =</span> <span class="st">"plateau"</span>, <span class="at">mediated =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-547"><a href="#cb63-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-548"><a href="#cb63-548" aria-hidden="true" tabindex="-1"></a>sds <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb63-549"><a href="#cb63-549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb63-550"><a href="#cb63-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_value =</span> <span class="fu">mean</span>(wellbeing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-551"><a href="#cb63-551" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd_within  =</span> <span class="fu">sd</span>(wellbeing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb63-552"><a href="#cb63-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">between_sd   =</span> <span class="fu">sd</span>(mean_value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-553"><a href="#cb63-553" aria-hidden="true" tabindex="-1"></a>            <span class="at">avg_within_sd =</span> <span class="fu">mean</span>(sd_within, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb63-554"><a href="#cb63-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-555"><a href="#cb63-555" aria-hidden="true" tabindex="-1"></a><span class="co"># plot wellbeing by group</span></span>
<span id="cb63-556"><a href="#cb63-556" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb63-557"><a href="#cb63-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(condition, day) <span class="sc">|&gt;</span> </span>
<span id="cb63-558"><a href="#cb63-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">wellbeing =</span> <span class="fu">mean</span>(wellbeing)) <span class="sc">|&gt;</span> </span>
<span id="cb63-559"><a href="#cb63-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> wellbeing, <span class="at">x =</span> day, <span class="at">color =</span> condition)) <span class="sc">+</span></span>
<span id="cb63-560"><a href="#cb63-560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb63-561"><a href="#cb63-561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb63-562"><a href="#cb63-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">100</span>))</span>
<span id="cb63-563"><a href="#cb63-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-564"><a href="#cb63-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-565"><a href="#cb63-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-566"><a href="#cb63-566" aria-hidden="true" tabindex="-1"></a><span class="fu">### Test Fit (H3a - intention to treat)</span></span>
<span id="cb63-567"><a href="#cb63-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-568"><a href="#cb63-568" aria-hidden="true" tabindex="-1"></a>We fit various models to the newly simulated data to make sure each appears to be working properly, and also test the full <span class="in">`sim_study`</span> pipeline.</span>
<span id="cb63-569"><a href="#cb63-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-572"><a href="#cb63-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-573"><a href="#cb63-573" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test-fit-h3a</span></span>
<span id="cb63-574"><a href="#cb63-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb63-575"><a href="#cb63-575" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of participants passed to \code{sim_data()}. Default is 1000.</span></span>
<span id="cb63-576"><a href="#cb63-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-577"><a href="#cb63-577" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(<span class="at">mediated =</span> <span class="cn">FALSE</span>)</span>
<span id="cb63-578"><a href="#cb63-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-579"><a href="#cb63-579" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb63-580"><a href="#cb63-580" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm_simple</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb63-581"><a href="#cb63-581" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gls</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb63-582"><a href="#cb63-582" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gls_simple</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb63-583"><a href="#cb63-583" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gls_spline</span>(dat) <span class="sc">|&gt;</span> <span class="fu">extract_marginal_effect</span>()</span>
<span id="cb63-584"><a href="#cb63-584" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gam</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb63-585"><a href="#cb63-585" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_gam_no_main</span>(dat) <span class="sc">|&gt;</span> <span class="fu">extract_marginal_effect</span>()</span>
<span id="cb63-586"><a href="#cb63-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-587"><a href="#cb63-587" aria-hidden="true" tabindex="-1"></a><span class="fu">sim_study</span>(<span class="at">model =</span> <span class="st">"fit_gam_no_main"</span>)</span>
<span id="cb63-588"><a href="#cb63-588" aria-hidden="true" tabindex="-1"></a><span class="fu">sim_study</span>(<span class="at">model =</span> <span class="st">"fit_gls_spline"</span>)</span>
<span id="cb63-589"><a href="#cb63-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-590"><a href="#cb63-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-591"><a href="#cb63-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-592"><a href="#cb63-592" aria-hidden="true" tabindex="-1"></a>Since some models (e.g., <span class="in">`fit_gam_no_main`</span>) do not have a parameter that represents the average difference-in-difference between groups during the intervention period, we need to calculate this ourselves by marginalize across the 14-day intervention period.</span>
<span id="cb63-593"><a href="#cb63-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-596"><a href="#cb63-596" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-597"><a href="#cb63-597" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test-emmeans</span></span>
<span id="cb63-598"><a href="#cb63-598" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb63-599"><a href="#cb63-599" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (test emmeans)"</span></span>
<span id="cb63-600"><a href="#cb63-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-601"><a href="#cb63-601" aria-hidden="true" tabindex="-1"></a>emm_day <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(</span>
<span id="cb63-602"><a href="#cb63-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_gls_spline</span>(dat), </span>
<span id="cb63-603"><a href="#cb63-603" aria-hidden="true" tabindex="-1"></a>  pairwise <span class="sc">~</span> condition <span class="sc">|</span> day, </span>
<span id="cb63-604"><a href="#cb63-604" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(<span class="at">day =</span> <span class="dv">8</span><span class="sc">:</span><span class="dv">21</span>), </span>
<span id="cb63-605"><a href="#cb63-605" aria-hidden="true" tabindex="-1"></a>  <span class="at">condition =</span> <span class="fu">c</span>(<span class="st">"control"</span>, <span class="st">"intervention"</span>), </span>
<span id="cb63-606"><a href="#cb63-606" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">condition =</span> <span class="fu">factor</span>(condition, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"intervention"</span>, <span class="st">"control"</span>)))</span>
<span id="cb63-607"><a href="#cb63-607" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-608"><a href="#cb63-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-609"><a href="#cb63-609" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(emm_day<span class="sc">$</span>contrasts, <span class="at">infer =</span> <span class="cn">TRUE</span>, <span class="at">level =</span> .<span class="dv">95</span>, <span class="at">by =</span> <span class="cn">NULL</span>, <span class="at">adjust =</span> <span class="st">"none"</span>)</span>
<span id="cb63-610"><a href="#cb63-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-611"><a href="#cb63-611" aria-hidden="true" tabindex="-1"></a><span class="co"># and then integrated over the 14 day intervention period</span></span>
<span id="cb63-612"><a href="#cb63-612" aria-hidden="true" tabindex="-1"></a>rg <span class="ot">&lt;-</span> <span class="fu">ref_grid</span>(<span class="fu">fit_gls_spline</span>(dat),</span>
<span id="cb63-613"><a href="#cb63-613" aria-hidden="true" tabindex="-1"></a>               <span class="at">at =</span> <span class="fu">list</span>(<span class="at">intervention_period =</span> <span class="dv">1</span>),</span>
<span id="cb63-614"><a href="#cb63-614" aria-hidden="true" tabindex="-1"></a>               <span class="at">cov.reduce =</span> <span class="fu">list</span>(<span class="at">day =</span> mean),</span>
<span id="cb63-615"><a href="#cb63-615" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">condition =</span> <span class="fu">factor</span>(condition, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"control"</span>,<span class="st">"intervention"</span>))))</span>
<span id="cb63-616"><a href="#cb63-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-617"><a href="#cb63-617" aria-hidden="true" tabindex="-1"></a>emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(rg, <span class="sc">~</span> condition)</span>
<span id="cb63-618"><a href="#cb63-618" aria-hidden="true" tabindex="-1"></a>(contrast_result <span class="ot">&lt;-</span> <span class="fu">contrast</span>(emm, <span class="at">method =</span> <span class="fu">list</span>(<span class="st">"intervention - control"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)), <span class="at">adjust =</span> <span class="st">"none"</span>))</span>
<span id="cb63-619"><a href="#cb63-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-620"><a href="#cb63-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-621"><a href="#cb63-621" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">summary</span>(emm)<span class="sc">$</span>emmean</span>
<span id="cb63-622"><a href="#cb63-622" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(means) <span class="ot">&lt;-</span> <span class="fu">summary</span>(emm)<span class="sc">$</span>condition</span>
<span id="cb63-623"><a href="#cb63-623" aria-hidden="true" tabindex="-1"></a>(diff_manual <span class="ot">&lt;-</span> means[<span class="st">"intervention"</span>] <span class="sc">-</span> means[<span class="st">"control"</span>])</span>
<span id="cb63-624"><a href="#cb63-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-625"><a href="#cb63-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-626"><a href="#cb63-626" aria-hidden="true" tabindex="-1"></a><span class="fu">### Test Fit (H3b - per-protocol)</span></span>
<span id="cb63-627"><a href="#cb63-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-628"><a href="#cb63-628" aria-hidden="true" tabindex="-1"></a>Another quick test of our <span class="in">`fit_mlm_reduction`</span> model, to make sure the alternative simulation whereby the effect of the intervention is mediated by a reduction in playtime is also functioning properly.</span>
<span id="cb63-629"><a href="#cb63-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-632"><a href="#cb63-632" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-633"><a href="#cb63-633" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test-fit-h3b-pp</span></span>
<span id="cb63-634"><a href="#cb63-634" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb63-635"><a href="#cb63-635" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (test fit h3b)"</span></span>
<span id="cb63-636"><a href="#cb63-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-637"><a href="#cb63-637" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_data</span>(<span class="at">mediated =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-638"><a href="#cb63-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-639"><a href="#cb63-639" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm_reduction</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb63-640"><a href="#cb63-640" aria-hidden="true" tabindex="-1"></a><span class="fu">fit_mlm_reduction_robust</span>(dat) <span class="sc">|&gt;</span> <span class="fu">summary</span>()</span>
<span id="cb63-641"><a href="#cb63-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-642"><a href="#cb63-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-643"><a href="#cb63-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-644"><a href="#cb63-644" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulated H3a power analysis</span></span>
<span id="cb63-645"><a href="#cb63-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-646"><a href="#cb63-646" aria-hidden="true" tabindex="-1"></a>To assess power/sensitivity, we run multiple simulations (controlled by <span class="in">`n_sims`</span>) and gather the parameter estimates for a particular term (e.g., <span class="in">`conditionintervention:intervention_periodTRUE`</span>, or for our marginalized effect <span class="in">`conditionintervention`</span>). Each iteration calls <span class="in">`sim_study`</span>, which does the data generation, dropout, and fitting.</span>
<span id="cb63-647"><a href="#cb63-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-648"><a href="#cb63-648" aria-hidden="true" tabindex="-1"></a>As this is quite slow, we both use parallel processing with <span class="in">`furrr`</span> cache the results.</span>
<span id="cb63-649"><a href="#cb63-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-652"><a href="#cb63-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-653"><a href="#cb63-653" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sim-study-h3a</span></span>
<span id="cb63-654"><a href="#cb63-654" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (simulate power h3a)"</span></span>
<span id="cb63-655"><a href="#cb63-655" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb63-656"><a href="#cb63-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-657"><a href="#cb63-657" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tictoc for timing if not already loaded</span></span>
<span id="cb63-658"><a href="#cb63-658" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(tictoc, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb63-659"><a href="#cb63-659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"tictoc"</span>)</span>
<span id="cb63-660"><a href="#cb63-660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tictoc)</span>
<span id="cb63-661"><a href="#cb63-661" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-662"><a href="#cb63-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-663"><a href="#cb63-663" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cached results exist</span></span>
<span id="cb63-664"><a href="#cb63-664" aria-hidden="true" tabindex="-1"></a>cache_file_h3a <span class="ot">&lt;-</span> <span class="st">"cache/h3a_simulation_results.rds"</span></span>
<span id="cb63-665"><a href="#cb63-665" aria-hidden="true" tabindex="-1"></a>cache_summary_h3a <span class="ot">&lt;-</span> <span class="st">"cache/h3a_simulation_summary.rds"</span></span>
<span id="cb63-666"><a href="#cb63-666" aria-hidden="true" tabindex="-1"></a>cache_params_h3a <span class="ot">&lt;-</span> <span class="st">"cache/h3a_simulation_params.rds"</span></span>
<span id="cb63-667"><a href="#cb63-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-668"><a href="#cb63-668" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key parameters that would invalidate cache</span></span>
<span id="cb63-669"><a href="#cb63-669" aria-hidden="true" tabindex="-1"></a>current_params_h3a <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb63-670"><a href="#cb63-670" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_sims =</span> <span class="dv">500</span>,</span>
<span id="cb63-671"><a href="#cb63-671" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb63-672"><a href="#cb63-672" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb63-673"><a href="#cb63-673" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_int =</span> <span class="fl">9.7</span>,</span>
<span id="cb63-674"><a href="#cb63-674" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_slope =</span> <span class="fl">0.8</span>,</span>
<span id="cb63-675"><a href="#cb63-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">within_person_sd =</span> <span class="fl">11.8</span>,</span>
<span id="cb63-676"><a href="#cb63-676" aria-hidden="true" tabindex="-1"></a>  <span class="at">phi =</span> <span class="fl">0.7</span>,</span>
<span id="cb63-677"><a href="#cb63-677" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>, <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gls_spline"</span>),</span>
<span id="cb63-678"><a href="#cb63-678" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb63-679"><a href="#cb63-679" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shapes =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>)</span>
<span id="cb63-680"><a href="#cb63-680" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-681"><a href="#cb63-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-682"><a href="#cb63-682" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb63-683"><a href="#cb63-683" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare job specifications irrespective of cache status</span></span>
<span id="cb63-684"><a href="#cb63-684" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures that variables such as `specs_h3a`, `all_jobs_h3a`, and</span></span>
<span id="cb63-685"><a href="#cb63-685" aria-hidden="true" tabindex="-1"></a><span class="co"># related helpers are available even when we load results from cache,</span></span>
<span id="cb63-686"><a href="#cb63-686" aria-hidden="true" tabindex="-1"></a><span class="co"># avoiding downstream errors (e.g., `all_jobs_h3a` not found).</span></span>
<span id="cb63-687"><a href="#cb63-687" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb63-688"><a href="#cb63-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-689"><a href="#cb63-689" aria-hidden="true" tabindex="-1"></a>specs_h3a <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb63-690"><a href="#cb63-690" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>, <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gls_spline"</span>),  <span class="co"># model names as strings</span></span>
<span id="cb63-691"><a href="#cb63-691" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb63-692"><a href="#cb63-692" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shape =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>)</span>
<span id="cb63-693"><a href="#cb63-693" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb63-694"><a href="#cb63-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-695"><a href="#cb63-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">focal_term =</span> <span class="fu">case_when</span>(</span>
<span id="cb63-696"><a href="#cb63-696" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"fit_mlm_simple"</span>,<span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gam_no_main"</span>) <span class="sc">~</span> <span class="st">"conditionintervention"</span>,</span>
<span id="cb63-697"><a href="#cb63-697" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"fit_gam"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_spline"</span>) <span class="sc">~</span> <span class="st">"conditionintervention:intervention_period"</span>,</span>
<span id="cb63-698"><a href="#cb63-698" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"conditionintervention:intervention_period"</span></span>
<span id="cb63-699"><a href="#cb63-699" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-700"><a href="#cb63-700" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb63-701"><a href="#cb63-701" aria-hidden="true" tabindex="-1"></a>  (<span class="cf">function</span>(d) { d<span class="sc">$</span>row_id <span class="ot">&lt;-</span> <span class="fu">pmap_chr</span>(d, <span class="sc">~</span> <span class="fu">paste0</span>(<span class="fu">names</span>(<span class="fu">list</span>(...)), <span class="st">"="</span>, <span class="fu">c</span>(...), <span class="at">collapse =</span> <span class="st">"_"</span>)); d })() <span class="sc">|&gt;</span> </span>
<span id="cb63-702"><a href="#cb63-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">row_number</span>())</span>
<span id="cb63-703"><a href="#cb63-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-704"><a href="#cb63-704" aria-hidden="true" tabindex="-1"></a><span class="co"># Create all spec-simulation combinations for better parallelization</span></span>
<span id="cb63-705"><a href="#cb63-705" aria-hidden="true" tabindex="-1"></a>all_jobs_h3a <span class="ot">&lt;-</span> specs_h3a <span class="sc">|&gt;</span> </span>
<span id="cb63-706"><a href="#cb63-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(<span class="at">sim =</span> <span class="dv">1</span><span class="sc">:</span>n_sims) <span class="sc">|&gt;</span> </span>
<span id="cb63-707"><a href="#cb63-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job_id =</span> <span class="fu">row_number</span>())</span>
<span id="cb63-708"><a href="#cb63-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-709"><a href="#cb63-709" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cache exists and parameters match</span></span>
<span id="cb63-710"><a href="#cb63-710" aria-hidden="true" tabindex="-1"></a>cache_valid_h3a <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb63-711"><a href="#cb63-711" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(cache_file_h3a) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_summary_h3a) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_params_h3a)) {</span>
<span id="cb63-712"><a href="#cb63-712" aria-hidden="true" tabindex="-1"></a>  cached_params_h3a <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_params_h3a)</span>
<span id="cb63-713"><a href="#cb63-713" aria-hidden="true" tabindex="-1"></a>  cache_valid_h3a <span class="ot">&lt;-</span> <span class="fu">identical</span>(current_params_h3a, cached_params_h3a)</span>
<span id="cb63-714"><a href="#cb63-714" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-715"><a href="#cb63-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-716"><a href="#cb63-716" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (cache_valid_h3a) {</span>
<span id="cb63-717"><a href="#cb63-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Loading cached H3a simulation results..."</span>)</span>
<span id="cb63-718"><a href="#cb63-718" aria-hidden="true" tabindex="-1"></a>  results_h3a <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_file_h3a)</span>
<span id="cb63-719"><a href="#cb63-719" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3a <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_summary_h3a)</span>
<span id="cb63-720"><a href="#cb63-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Cached H3a results loaded successfully!"</span>)</span>
<span id="cb63-721"><a href="#cb63-721" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb63-722"><a href="#cb63-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No cached H3a results found or parameters changed. Running H3a simulations..."</span>)</span>
<span id="cb63-723"><a href="#cb63-723" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-724"><a href="#cb63-724" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create cache directory if it doesn't exist</span></span>
<span id="cb63-725"><a href="#cb63-725" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"cache"</span>)) {</span>
<span id="cb63-726"><a href="#cb63-726" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="st">"cache"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-727"><a href="#cb63-727" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-728"><a href="#cb63-728" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-729"><a href="#cb63-729" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start timing</span></span>
<span id="cb63-730"><a href="#cb63-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>(<span class="st">"H3a simulation total time"</span>)</span>
<span id="cb63-731"><a href="#cb63-731" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-732"><a href="#cb63-732" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n_sims is already defined above</span></span>
<span id="cb63-733"><a href="#cb63-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-734"><a href="#cb63-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Running "</span>, <span class="fu">nrow</span>(all_jobs_h3a), <span class="st">" simulations across "</span>, <span class="fu">nbrOfWorkers</span>(), <span class="st">" cores..."</span>)</span>
<span id="cb63-735"><a href="#cb63-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-736"><a href="#cb63-736" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run all simulations in parallel</span></span>
<span id="cb63-737"><a href="#cb63-737" aria-hidden="true" tabindex="-1"></a>  results_h3a <span class="ot">&lt;-</span> <span class="fu">future_map_dfr</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(all_jobs_h3a), <span class="cf">function</span>(job_idx) {</span>
<span id="cb63-738"><a href="#cb63-738" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load required libraries in each worker</span></span>
<span id="cb63-739"><a href="#cb63-739" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tidyverse)</span>
<span id="cb63-740"><a href="#cb63-740" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(nlme)</span>
<span id="cb63-741"><a href="#cb63-741" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(mgcv)</span>
<span id="cb63-742"><a href="#cb63-742" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(broom.mixed)</span>
<span id="cb63-743"><a href="#cb63-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(emmeans)</span>
<span id="cb63-744"><a href="#cb63-744" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-745"><a href="#cb63-745" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get job parameters</span></span>
<span id="cb63-746"><a href="#cb63-746" aria-hidden="true" tabindex="-1"></a>    job <span class="ot">&lt;-</span> all_jobs_h3a[job_idx, ]</span>
<span id="cb63-747"><a href="#cb63-747" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-748"><a href="#cb63-748" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb63-749"><a href="#cb63-749" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">sim_study</span>(</span>
<span id="cb63-750"><a href="#cb63-750" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb63-751"><a href="#cb63-751" aria-hidden="true" tabindex="-1"></a>        <span class="at">focal_term =</span> job<span class="sc">$</span>focal_term,</span>
<span id="cb63-752"><a href="#cb63-752" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb63-753"><a href="#cb63-753" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb63-754"><a href="#cb63-754" aria-hidden="true" tabindex="-1"></a>        <span class="co"># effect parameters</span></span>
<span id="cb63-755"><a href="#cb63-755" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b, <span class="co"># effect in unstandardized units</span></span>
<span id="cb63-756"><a href="#cb63-756" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu =</span> <span class="fl">78.5</span>, <span class="co"># grand mean of the outcome</span></span>
<span id="cb63-757"><a href="#cb63-757" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape,</span>
<span id="cb63-758"><a href="#cb63-758" aria-hidden="true" tabindex="-1"></a>        <span class="at">k =</span> .<span class="dv">5</span>,</span>
<span id="cb63-759"><a href="#cb63-759" aria-hidden="true" tabindex="-1"></a>        <span class="co"># random effects parameters</span></span>
<span id="cb63-760"><a href="#cb63-760" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_int =</span> <span class="fl">9.7</span>,   <span class="co"># Random intercept SD (between-person variance)</span></span>
<span id="cb63-761"><a href="#cb63-761" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_slope =</span> .<span class="dv">8</span>,  <span class="co"># Random slope SD </span></span>
<span id="cb63-762"><a href="#cb63-762" aria-hidden="true" tabindex="-1"></a>        <span class="at">within_person_sd =</span> <span class="fl">11.8</span>, <span class="co"># Within-person SD</span></span>
<span id="cb63-763"><a href="#cb63-763" aria-hidden="true" tabindex="-1"></a>        <span class="co"># AR(1) parameters</span></span>
<span id="cb63-764"><a href="#cb63-764" aria-hidden="true" tabindex="-1"></a>        <span class="at">phi =</span> <span class="fl">0.7</span>,     <span class="co"># Autocorrelation coefficient</span></span>
<span id="cb63-765"><a href="#cb63-765" aria-hidden="true" tabindex="-1"></a>        <span class="at">mediated =</span> <span class="cn">FALSE</span></span>
<span id="cb63-766"><a href="#cb63-766" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb63-767"><a href="#cb63-767" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb63-768"><a href="#cb63-768" aria-hidden="true" tabindex="-1"></a>          <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb63-769"><a href="#cb63-769" aria-hidden="true" tabindex="-1"></a>          <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb63-770"><a href="#cb63-770" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb63-771"><a href="#cb63-771" aria-hidden="true" tabindex="-1"></a>          <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb63-772"><a href="#cb63-772" aria-hidden="true" tabindex="-1"></a>          <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb63-773"><a href="#cb63-773" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb63-774"><a href="#cb63-774" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb63-775"><a href="#cb63-775" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(result)</span>
<span id="cb63-776"><a href="#cb63-776" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb63-777"><a href="#cb63-777" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Only show debug messages if debug mode is enabled and in interactive mode</span></span>
<span id="cb63-778"><a href="#cb63-778" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"debug_mode"</span>, <span class="cn">FALSE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">interactive</span>()) {</span>
<span id="cb63-779"><a href="#cb63-779" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Job "</span>, job_idx, <span class="st">" (spec row: "</span>, job<span class="sc">$</span>i, <span class="st">", sim: "</span>, job<span class="sc">$</span>sim, <span class="st">") failed: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb63-780"><a href="#cb63-780" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb63-781"><a href="#cb63-781" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb63-782"><a href="#cb63-782" aria-hidden="true" tabindex="-1"></a>        <span class="at">term =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb63-783"><a href="#cb63-783" aria-hidden="true" tabindex="-1"></a>        <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-784"><a href="#cb63-784" aria-hidden="true" tabindex="-1"></a>        <span class="at">std.error =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-785"><a href="#cb63-785" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.low =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-786"><a href="#cb63-786" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.high =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-787"><a href="#cb63-787" aria-hidden="true" tabindex="-1"></a>        <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb63-788"><a href="#cb63-788" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb63-789"><a href="#cb63-789" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb63-790"><a href="#cb63-790" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb63-791"><a href="#cb63-791" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb63-792"><a href="#cb63-792" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-793"><a href="#cb63-793" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-794"><a href="#cb63-794" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb63-795"><a href="#cb63-795" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options =</span> <span class="fu">furrr_options</span>(</span>
<span id="cb63-796"><a href="#cb63-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">globals =</span> <span class="fu">c</span>(<span class="st">"all_jobs_h3a"</span>, <span class="st">"sim_study"</span>, <span class="st">"sim_data"</span>, </span>
<span id="cb63-797"><a href="#cb63-797" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>,</span>
<span id="cb63-798"><a href="#cb63-798" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>,</span>
<span id="cb63-799"><a href="#cb63-799" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>,</span>
<span id="cb63-800"><a href="#cb63-800" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gls_spline"</span>, </span>
<span id="cb63-801"><a href="#cb63-801" aria-hidden="true" tabindex="-1"></a>                <span class="st">"extract_marginal_effect"</span>),</span>
<span id="cb63-802"><a href="#cb63-802" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">TRUE</span></span>
<span id="cb63-803"><a href="#cb63-803" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb63-804"><a href="#cb63-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-805"><a href="#cb63-805" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3a <span class="ot">&lt;-</span> results_h3a <span class="sc">|&gt;</span> </span>
<span id="cb63-806"><a href="#cb63-806" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(row_id) <span class="sc">|&gt;</span> </span>
<span id="cb63-807"><a href="#cb63-807" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb63-808"><a href="#cb63-808" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">first</span>(model),</span>
<span id="cb63-809"><a href="#cb63-809" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">first</span>(b),</span>
<span id="cb63-810"><a href="#cb63-810" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_shape =</span> <span class="fu">first</span>(effect_shape),</span>
<span id="cb63-811"><a href="#cb63-811" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_effect =</span> <span class="fu">mean</span>(estimate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-812"><a href="#cb63-812" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-813"><a href="#cb63-813" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.low =</span> <span class="fu">mean</span>(conf.low, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-814"><a href="#cb63-814" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.high =</span> <span class="fu">mean</span>(conf.high, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-815"><a href="#cb63-815" aria-hidden="true" tabindex="-1"></a>      <span class="at">power =</span> <span class="fu">sum</span>(conf.low <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.low))</span>
<span id="cb63-816"><a href="#cb63-816" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-817"><a href="#cb63-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-818"><a href="#cb63-818" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stop timing and display results</span></span>
<span id="cb63-819"><a href="#cb63-819" aria-hidden="true" tabindex="-1"></a>  h3a_time <span class="ot">&lt;-</span> <span class="fu">toc</span>()</span>
<span id="cb63-820"><a href="#cb63-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-821"><a href="#cb63-821" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save results to cache</span></span>
<span id="cb63-822"><a href="#cb63-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_h3a, cache_file_h3a)</span>
<span id="cb63-823"><a href="#cb63-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(sim_summary_h3a, cache_summary_h3a)</span>
<span id="cb63-824"><a href="#cb63-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(current_params_h3a, cache_params_h3a)</span>
<span id="cb63-825"><a href="#cb63-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"H3a simulation results saved to cache!"</span>)</span>
<span id="cb63-826"><a href="#cb63-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-827"><a href="#cb63-827" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End of else block for cached results</span></span>
<span id="cb63-828"><a href="#cb63-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-829"><a href="#cb63-829" aria-hidden="true" tabindex="-1"></a><span class="co"># Also print some summary statistics about the simulation</span></span>
<span id="cb63-830"><a href="#cb63-830" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"=== SIMULATION SUMMARY ==="</span>)</span>
<span id="cb63-831"><a href="#cb63-831" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Total number of jobs: "</span>, <span class="fu">nrow</span>(all_jobs_h3a))</span>
<span id="cb63-832"><a href="#cb63-832" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of successful results: "</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3a<span class="sc">$</span>estimate)))</span>
<span id="cb63-833"><a href="#cb63-833" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of failed jobs: "</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(results_h3a<span class="sc">$</span>estimate)))</span>
<span id="cb63-834"><a href="#cb63-834" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Success rate: "</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3a<span class="sc">$</span>estimate)) <span class="sc">/</span> <span class="fu">nrow</span>(results_h3a), <span class="dv">1</span>), <span class="st">"%"</span>)</span>
<span id="cb63-835"><a href="#cb63-835" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"============================"</span>)</span>
<span id="cb63-836"><a href="#cb63-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-837"><a href="#cb63-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-838"><a href="#cb63-838" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-839"><a href="#cb63-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-842"><a href="#cb63-842" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-843"><a href="#cb63-843" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-power-h3a</span></span>
<span id="cb63-844"><a href="#cb63-844" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (visualize power h3a)"</span></span>
<span id="cb63-845"><a href="#cb63-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-846"><a href="#cb63-846" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated effect vs. true effect (b)</span></span>
<span id="cb63-847"><a href="#cb63-847" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3a, <span class="fu">aes</span>(<span class="at">x =</span> b, <span class="at">y =</span> mean_effect, <span class="at">color =</span> model, <span class="at">alpha =</span> model <span class="sc">==</span> <span class="st">"fit_gam"</span>)) <span class="sc">+</span></span>
<span id="cb63-848"><a href="#cb63-848" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb63-849"><a href="#cb63-849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean_conf.low, <span class="at">ymax =</span> mean_conf.high), <span class="at">width =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb63-850"><a href="#cb63-850" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb63-851"><a href="#cb63-851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb63-852"><a href="#cb63-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect (unstandardized b)"</span>, <span class="at">y =</span> <span class="st">"Estimated Effect"</span>,</span>
<span id="cb63-853"><a href="#cb63-853" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Estimated vs. True Effects by Model and Effect Shape"</span>) <span class="sc">+</span></span>
<span id="cb63-854"><a href="#cb63-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb63-855"><a href="#cb63-855" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect (b/12)"</span>)) <span class="sc">+</span></span>
<span id="cb63-856"><a href="#cb63-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.3</span>), <span class="at">guide =</span> <span class="st">"none"</span>)</span>
<span id="cb63-857"><a href="#cb63-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-858"><a href="#cb63-858" aria-hidden="true" tabindex="-1"></a><span class="co"># Power vs. true effect (b)</span></span>
<span id="cb63-859"><a href="#cb63-859" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3a, <span class="fu">aes</span>(<span class="at">x =</span> b, <span class="at">y =</span> power, <span class="at">color =</span> model, <span class="at">alpha =</span> model <span class="sc">==</span> <span class="st">"fit_gam"</span>)) <span class="sc">+</span></span>
<span id="cb63-860"><a href="#cb63-860" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-861"><a href="#cb63-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb63-862"><a href="#cb63-862" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb63-863"><a href="#cb63-863" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect (unstandardized b)"</span>, <span class="at">y =</span> <span class="st">"Power"</span>,</span>
<span id="cb63-864"><a href="#cb63-864" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Power by Model and Effect Shape"</span>) <span class="sc">+</span></span>
<span id="cb63-865"><a href="#cb63-865" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>, <span class="dv">6</span>),</span>
<span id="cb63-866"><a href="#cb63-866" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect (b/12)"</span>)) <span class="sc">+</span></span>
<span id="cb63-867"><a href="#cb63-867" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb63-868"><a href="#cb63-868" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.3</span>), <span class="at">guide =</span> <span class="st">"none"</span>)</span>
<span id="cb63-869"><a href="#cb63-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-870"><a href="#cb63-870" aria-hidden="true" tabindex="-1"></a><span class="co"># results |&gt;</span></span>
<span id="cb63-871"><a href="#cb63-871" aria-hidden="true" tabindex="-1"></a><span class="co">#   forestplot(mean = estimate,</span></span>
<span id="cb63-872"><a href="#cb63-872" aria-hidden="true" tabindex="-1"></a><span class="co">#              lower = conf.low,</span></span>
<span id="cb63-873"><a href="#cb63-873" aria-hidden="true" tabindex="-1"></a><span class="co">#              upper = conf.high,</span></span>
<span id="cb63-874"><a href="#cb63-874" aria-hidden="true" tabindex="-1"></a><span class="co">#              labeltext = term)</span></span>
<span id="cb63-875"><a href="#cb63-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-876"><a href="#cb63-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-877"><a href="#cb63-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-878"><a href="#cb63-878" aria-hidden="true" tabindex="-1"></a><span class="fu">### Minimum Detectable Effect Sizes at 80% Power</span></span>
<span id="cb63-879"><a href="#cb63-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-882"><a href="#cb63-882" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-883"><a href="#cb63-883" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: h3a-power-table</span></span>
<span id="cb63-884"><a href="#cb63-884" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (minimum detectable effects table)"</span></span>
<span id="cb63-885"><a href="#cb63-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-886"><a href="#cb63-886" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to interpolate minimum detectable effect at 80% power</span></span>
<span id="cb63-887"><a href="#cb63-887" aria-hidden="true" tabindex="-1"></a>find_mde_80 <span class="ot">&lt;-</span> <span class="cf">function</span>(power_data) {</span>
<span id="cb63-888"><a href="#cb63-888" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we already have 80% power or higher at the smallest effect, return that</span></span>
<span id="cb63-889"><a href="#cb63-889" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">min</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;=</span> <span class="fl">0.8</span>) {</span>
<span id="cb63-890"><a href="#cb63-890" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">min</span>(power_data<span class="sc">$</span>b, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb63-891"><a href="#cb63-891" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-892"><a href="#cb63-892" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-893"><a href="#cb63-893" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we never reach 80% power, return NA</span></span>
<span id="cb63-894"><a href="#cb63-894" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&lt;</span> <span class="fl">0.8</span>) {</span>
<span id="cb63-895"><a href="#cb63-895" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb63-896"><a href="#cb63-896" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-897"><a href="#cb63-897" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-898"><a href="#cb63-898" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear interpolation to find effect size at 80% power</span></span>
<span id="cb63-899"><a href="#cb63-899" aria-hidden="true" tabindex="-1"></a>  <span class="fu">approx</span>(<span class="at">x =</span> power_data<span class="sc">$</span>power, <span class="at">y =</span> power_data<span class="sc">$</span>b, <span class="at">xout =</span> <span class="fl">0.8</span>)<span class="sc">$</span>y</span>
<span id="cb63-900"><a href="#cb63-900" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-901"><a href="#cb63-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-902"><a href="#cb63-902" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate minimum detectable effects for each model and effect shape</span></span>
<span id="cb63-903"><a href="#cb63-903" aria-hidden="true" tabindex="-1"></a>mde_table <span class="ot">&lt;-</span> sim_summary_h3a <span class="sc">|&gt;</span></span>
<span id="cb63-904"><a href="#cb63-904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb63-905"><a href="#cb63-905" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb63-906"><a href="#cb63-906" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_unstandardized =</span> <span class="fu">find_mde_80</span>(<span class="fu">cur_data</span>()),</span>
<span id="cb63-907"><a href="#cb63-907" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized =</span> mde_80_unstandardized <span class="sc">/</span> <span class="dv">12</span>,  <span class="co"># Convert to standardized units</span></span>
<span id="cb63-908"><a href="#cb63-908" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power =</span> <span class="fu">max</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-909"><a href="#cb63-909" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb63-910"><a href="#cb63-910" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-911"><a href="#cb63-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(effect_shape, mde_80_standardized) <span class="sc">|&gt;</span></span>
<span id="cb63-912"><a href="#cb63-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-913"><a href="#cb63-913" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up model names for presentation</span></span>
<span id="cb63-914"><a href="#cb63-914" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb63-915"><a href="#cb63-915" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gam"</span> <span class="sc">~</span> <span class="st">"GAM"</span>,</span>
<span id="cb63-916"><a href="#cb63-916" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gam_no_main"</span> <span class="sc">~</span> <span class="st">"GAM (no main effect)"</span>,</span>
<span id="cb63-917"><a href="#cb63-917" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm"</span> <span class="sc">~</span> <span class="st">"MLM"</span>,</span>
<span id="cb63-918"><a href="#cb63-918" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_simple"</span> <span class="sc">~</span> <span class="st">"MLM Simple"</span>,</span>
<span id="cb63-919"><a href="#cb63-919" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gls"</span> <span class="sc">~</span> <span class="st">"GLS"</span>,</span>
<span id="cb63-920"><a href="#cb63-920" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gls_simple"</span> <span class="sc">~</span> <span class="st">"GLS Simple"</span>, </span>
<span id="cb63-921"><a href="#cb63-921" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_gls_spline"</span> <span class="sc">~</span> <span class="st">"GLS Splines"</span>,</span>
<span id="cb63-922"><a href="#cb63-922" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> model</span>
<span id="cb63-923"><a href="#cb63-923" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-924"><a href="#cb63-924" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format effect sizes for display</span></span>
<span id="cb63-925"><a href="#cb63-925" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_unstandardized_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_unstandardized), </span>
<span id="cb63-926"><a href="#cb63-926" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"&gt;6.0"</span>, </span>
<span id="cb63-927"><a href="#cb63-927" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">"%.1f"</span>, mde_80_unstandardized)),</span>
<span id="cb63-928"><a href="#cb63-928" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_standardized), </span>
<span id="cb63-929"><a href="#cb63-929" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"&gt;0.50"</span>, </span>
<span id="cb63-930"><a href="#cb63-930" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, mde_80_standardized)),</span>
<span id="cb63-931"><a href="#cb63-931" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power_fmt =</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, max_power <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb63-932"><a href="#cb63-932" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-933"><a href="#cb63-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-934"><a href="#cb63-934" aria-hidden="true" tabindex="-1"></a><span class="co"># Create formatted table</span></span>
<span id="cb63-935"><a href="#cb63-935" aria-hidden="true" tabindex="-1"></a>mde_table <span class="sc">|&gt;</span></span>
<span id="cb63-936"><a href="#cb63-936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb63-937"><a href="#cb63-937" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Effect Shape</span><span class="st">`</span> <span class="ot">=</span> effect_shape,</span>
<span id="cb63-938"><a href="#cb63-938" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Model</span><span class="st">`</span> <span class="ot">=</span> model_clean,</span>
<span id="cb63-939"><a href="#cb63-939" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Unstandardized)</span><span class="st">`</span> <span class="ot">=</span> mde_80_unstandardized_fmt,</span>
<span id="cb63-940"><a href="#cb63-940" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Standardized)</span><span class="st">`</span> <span class="ot">=</span> mde_80_standardized_fmt,</span>
<span id="cb63-941"><a href="#cb63-941" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Max Power Achieved</span><span class="st">`</span> <span class="ot">=</span> max_power_fmt</span>
<span id="cb63-942"><a href="#cb63-942" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-943"><a href="#cb63-943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb63-944"><a href="#cb63-944" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Minimum Detectable Effect Sizes at 80% Power by Model and Effect Shape"</span>,</span>
<span id="cb63-945"><a href="#cb63-945" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>)</span>
<span id="cb63-946"><a href="#cb63-946" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-947"><a href="#cb63-947" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb63-948"><a href="#cb63-948" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>),</span>
<span id="cb63-949"><a href="#cb63-949" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb63-950"><a href="#cb63-950" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"left"</span></span>
<span id="cb63-951"><a href="#cb63-951" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-952"><a href="#cb63-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Growing Effect"</span>, <span class="dv">1</span>, <span class="fu">sum</span>(mde_table<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb63-953"><a href="#cb63-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Plateau Effect"</span>, <span class="fu">sum</span>(mde_table<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">nrow</span>(mde_table)) <span class="sc">|&gt;</span></span>
<span id="cb63-954"><a href="#cb63-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">footnote</span>(</span>
<span id="cb63-955"><a href="#cb63-955" aria-hidden="true" tabindex="-1"></a>    <span class="at">general =</span> <span class="fu">c</span>(</span>
<span id="cb63-956"><a href="#cb63-956" aria-hidden="true" tabindex="-1"></a>      <span class="st">"MDE = Minimum Detectable Effect size at 80% power"</span>,</span>
<span id="cb63-957"><a href="#cb63-957" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Standardized effects calculated as unstandardized effect / 12"</span>,</span>
<span id="cb63-958"><a href="#cb63-958" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Models ordered by sensitivity (smallest MDE first) within each effect shape"</span>,</span>
<span id="cb63-959"><a href="#cb63-959" aria-hidden="true" tabindex="-1"></a>      <span class="st">"'&gt;6.0' and '&gt;0.50' indicate models that did not achieve 80% power at largest tested effect size"</span></span>
<span id="cb63-960"><a href="#cb63-960" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-961"><a href="#cb63-961" aria-hidden="true" tabindex="-1"></a>    <span class="at">general_title =</span> <span class="st">"Notes:"</span></span>
<span id="cb63-962"><a href="#cb63-962" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-963"><a href="#cb63-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-964"><a href="#cb63-964" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb63-965"><a href="#cb63-965" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== SUMMARY OF MODEL PERFORMANCE ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-966"><a href="#cb63-966" aria-hidden="true" tabindex="-1"></a>best_models <span class="ot">&lt;-</span> mde_table <span class="sc">|&gt;</span></span>
<span id="cb63-967"><a href="#cb63-967" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb63-968"><a href="#cb63-968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(mde_80_standardized, <span class="at">na_rm =</span> <span class="cn">TRUE</span>, <span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb63-969"><a href="#cb63-969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb63-970"><a href="#cb63-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-971"><a href="#cb63-971" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (shape <span class="cf">in</span> <span class="fu">unique</span>(best_models<span class="sc">$</span>effect_shape)) {</span>
<span id="cb63-972"><a href="#cb63-972" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">%s effects - Top 3 most sensitive models:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">str_to_title</span>(shape)))</span>
<span id="cb63-973"><a href="#cb63-973" aria-hidden="true" tabindex="-1"></a>  shape_models <span class="ot">&lt;-</span> best_models <span class="sc">|&gt;</span> <span class="fu">filter</span>(effect_shape <span class="sc">==</span> shape)</span>
<span id="cb63-974"><a href="#cb63-974" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(shape_models)) {</span>
<span id="cb63-975"><a href="#cb63-975" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %d. %s: %.2f standardized effect</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-976"><a href="#cb63-976" aria-hidden="true" tabindex="-1"></a>                i, shape_models<span class="sc">$</span>model_clean[i], shape_models<span class="sc">$</span>mde_80_standardized[i]))</span>
<span id="cb63-977"><a href="#cb63-977" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-978"><a href="#cb63-978" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-979"><a href="#cb63-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-980"><a href="#cb63-980" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall best model</span></span>
<span id="cb63-981"><a href="#cb63-981" aria-hidden="true" tabindex="-1"></a>overall_best <span class="ot">&lt;-</span> mde_table <span class="sc">|&gt;</span></span>
<span id="cb63-982"><a href="#cb63-982" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mde_80_standardized)) <span class="sc">|&gt;</span></span>
<span id="cb63-983"><a href="#cb63-983" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(mde_80_standardized, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb63-984"><a href="#cb63-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-985"><a href="#cb63-985" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Overall most sensitive model: %s (%s effects)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-986"><a href="#cb63-986" aria-hidden="true" tabindex="-1"></a>            overall_best<span class="sc">$</span>model_clean, overall_best<span class="sc">$</span>effect_shape))</span>
<span id="cb63-987"><a href="#cb63-987" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"MDE at 80%% power: %.2f standardized effect (%.1f unstandardized)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb63-988"><a href="#cb63-988" aria-hidden="true" tabindex="-1"></a>            overall_best<span class="sc">$</span>mde_80_standardized, overall_best<span class="sc">$</span>mde_80_unstandardized))</span>
<span id="cb63-989"><a href="#cb63-989" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=====================================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-990"><a href="#cb63-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-991"><a href="#cb63-991" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-992"><a href="#cb63-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-993"><a href="#cb63-993" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulated H3b power analysis</span></span>
<span id="cb63-994"><a href="#cb63-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-995"><a href="#cb63-995" aria-hidden="true" tabindex="-1"></a>Same thing as above, but now looking at power for our per-protocol model.</span>
<span id="cb63-996"><a href="#cb63-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-999"><a href="#cb63-999" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1000"><a href="#cb63-1000" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sim-study-h3b</span></span>
<span id="cb63-1001"><a href="#cb63-1001" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (sim study h3b)"</span></span>
<span id="cb63-1002"><a href="#cb63-1002" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb63-1003"><a href="#cb63-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1004"><a href="#cb63-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1005"><a href="#cb63-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1006"><a href="#cb63-1006" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cached results exist</span></span>
<span id="cb63-1007"><a href="#cb63-1007" aria-hidden="true" tabindex="-1"></a>cache_file_h3b <span class="ot">&lt;-</span> <span class="st">"cache/h3b_simulation_results.rds"</span></span>
<span id="cb63-1008"><a href="#cb63-1008" aria-hidden="true" tabindex="-1"></a>cache_summary_h3b <span class="ot">&lt;-</span> <span class="st">"cache/h3b_simulation_summary.rds"</span></span>
<span id="cb63-1009"><a href="#cb63-1009" aria-hidden="true" tabindex="-1"></a>cache_params_h3b <span class="ot">&lt;-</span> <span class="st">"cache/h3b_simulation_params.rds"</span></span>
<span id="cb63-1010"><a href="#cb63-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1011"><a href="#cb63-1011" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key parameters that would invalidate cache</span></span>
<span id="cb63-1012"><a href="#cb63-1012" aria-hidden="true" tabindex="-1"></a>current_params_h3b <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb63-1013"><a href="#cb63-1013" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_sims =</span> <span class="dv">500</span>,</span>
<span id="cb63-1014"><a href="#cb63-1014" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb63-1015"><a href="#cb63-1015" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb63-1016"><a href="#cb63-1016" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_int =</span> <span class="fl">9.7</span>,</span>
<span id="cb63-1017"><a href="#cb63-1017" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau_slope =</span> <span class="fl">0.8</span>,</span>
<span id="cb63-1018"><a href="#cb63-1018" aria-hidden="true" tabindex="-1"></a>  <span class="at">within_person_sd =</span> <span class="fl">11.8</span>,</span>
<span id="cb63-1019"><a href="#cb63-1019" aria-hidden="true" tabindex="-1"></a>  <span class="at">phi =</span> <span class="fl">0.7</span>,</span>
<span id="cb63-1020"><a href="#cb63-1020" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span>, <span class="st">"fit_mlm_reduction_robust"</span>),</span>
<span id="cb63-1021"><a href="#cb63-1021" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>),</span>
<span id="cb63-1022"><a href="#cb63-1022" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shapes =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>),</span>
<span id="cb63-1023"><a href="#cb63-1023" aria-hidden="true" tabindex="-1"></a>  <span class="at">mediated =</span> <span class="cn">TRUE</span></span>
<span id="cb63-1024"><a href="#cb63-1024" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-1025"><a href="#cb63-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1026"><a href="#cb63-1026" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb63-1027"><a href="#cb63-1027" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare job specifications irrespective of cache status</span></span>
<span id="cb63-1028"><a href="#cb63-1028" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures that variables such as `specs_h3b`, `all_jobs_h3b`, and</span></span>
<span id="cb63-1029"><a href="#cb63-1029" aria-hidden="true" tabindex="-1"></a><span class="co"># related helpers are available even when we load results from cache,</span></span>
<span id="cb63-1030"><a href="#cb63-1030" aria-hidden="true" tabindex="-1"></a><span class="co"># avoiding downstream errors (e.g., `all_jobs_h3b` not found).</span></span>
<span id="cb63-1031"><a href="#cb63-1031" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb63-1032"><a href="#cb63-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1033"><a href="#cb63-1033" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: With two per-protocol models, this simulation will take approximately </span></span>
<span id="cb63-1034"><a href="#cb63-1034" aria-hidden="true" tabindex="-1"></a><span class="co"># twice as long as the original version with just the change score approach</span></span>
<span id="cb63-1035"><a href="#cb63-1035" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Note: Running two per-protocol models - simulation time will be longer"</span>)</span>
<span id="cb63-1036"><a href="#cb63-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1037"><a href="#cb63-1037" aria-hidden="true" tabindex="-1"></a>specs_h3b <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb63-1038"><a href="#cb63-1038" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span>, <span class="st">"fit_mlm_reduction_robust"</span>),  <span class="co"># model names as strings</span></span>
<span id="cb63-1039"><a href="#cb63-1039" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.4</span>, <span class="fl">3.6</span>, <span class="fl">4.8</span>),</span>
<span id="cb63-1040"><a href="#cb63-1040" aria-hidden="true" tabindex="-1"></a>  <span class="at">effect_shape =</span> <span class="fu">c</span>(<span class="st">"grow"</span>, <span class="st">"plateau"</span>)</span>
<span id="cb63-1041"><a href="#cb63-1041" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb63-1042"><a href="#cb63-1042" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the mean of the Kumaraswamy distribution - the expected effect size of the mediated version is b * average compliance</span></span>
<span id="cb63-1043"><a href="#cb63-1043" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-1044"><a href="#cb63-1044" aria-hidden="true" tabindex="-1"></a>    <span class="at">focal_term =</span> <span class="fu">case_when</span>(</span>
<span id="cb63-1045"><a href="#cb63-1045" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span> <span class="sc">~</span> <span class="st">"intervention_activeTRUE:reduction"</span>,</span>
<span id="cb63-1046"><a href="#cb63-1046" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span> <span class="sc">~</span> <span class="st">"intervention_activeTRUE:playtime"</span></span>
<span id="cb63-1047"><a href="#cb63-1047" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-1048"><a href="#cb63-1048" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected_effect =</span> b <span class="sc">*</span> .<span class="dv">1</span><span class="sc">*</span><span class="fu">beta</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>.<span class="dv">05</span>, .<span class="dv">1</span>),</span>
<span id="cb63-1049"><a href="#cb63-1049" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb63-1050"><a href="#cb63-1050" aria-hidden="true" tabindex="-1"></a>  (\(d) { d<span class="sc">$</span>row_id <span class="ot">&lt;-</span> <span class="fu">pmap_chr</span>(d, <span class="sc">~</span> <span class="fu">paste0</span>(<span class="fu">names</span>(<span class="fu">list</span>(...)), <span class="st">"="</span>, <span class="fu">c</span>(...), <span class="at">collapse =</span> <span class="st">"_"</span>)); d })() <span class="sc">|&gt;</span> </span>
<span id="cb63-1051"><a href="#cb63-1051" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">row_number</span>())</span>
<span id="cb63-1052"><a href="#cb63-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1053"><a href="#cb63-1053" aria-hidden="true" tabindex="-1"></a><span class="co"># Create all spec-simulation combinations for better parallelization</span></span>
<span id="cb63-1054"><a href="#cb63-1054" aria-hidden="true" tabindex="-1"></a>all_jobs_h3b <span class="ot">&lt;-</span> specs_h3b <span class="sc">|&gt;</span> </span>
<span id="cb63-1055"><a href="#cb63-1055" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(<span class="at">sim =</span> <span class="dv">1</span><span class="sc">:</span>n_sims) <span class="sc">|&gt;</span> </span>
<span id="cb63-1056"><a href="#cb63-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">job_id =</span> <span class="fu">row_number</span>())</span>
<span id="cb63-1057"><a href="#cb63-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1058"><a href="#cb63-1058" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if cache exists and parameters match</span></span>
<span id="cb63-1059"><a href="#cb63-1059" aria-hidden="true" tabindex="-1"></a>cache_valid_h3b <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb63-1060"><a href="#cb63-1060" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(cache_file_h3b) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_summary_h3b) <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(cache_params_h3b)) {</span>
<span id="cb63-1061"><a href="#cb63-1061" aria-hidden="true" tabindex="-1"></a>  cached_params_h3b <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_params_h3b)</span>
<span id="cb63-1062"><a href="#cb63-1062" aria-hidden="true" tabindex="-1"></a>  cache_valid_h3b <span class="ot">&lt;-</span> <span class="fu">identical</span>(current_params_h3b, cached_params_h3b)</span>
<span id="cb63-1063"><a href="#cb63-1063" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-1064"><a href="#cb63-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1065"><a href="#cb63-1065" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (cache_valid_h3b) {</span>
<span id="cb63-1066"><a href="#cb63-1066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Loading cached H3b simulation results..."</span>)</span>
<span id="cb63-1067"><a href="#cb63-1067" aria-hidden="true" tabindex="-1"></a>  results_h3b <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_file_h3b)</span>
<span id="cb63-1068"><a href="#cb63-1068" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3b <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(cache_summary_h3b)</span>
<span id="cb63-1069"><a href="#cb63-1069" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Cached H3b results loaded successfully!"</span>)</span>
<span id="cb63-1070"><a href="#cb63-1070" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb63-1071"><a href="#cb63-1071" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No cached H3b results found or parameters changed. Running H3b simulations..."</span>)</span>
<span id="cb63-1072"><a href="#cb63-1072" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-1073"><a href="#cb63-1073" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create cache directory if it doesn't exist</span></span>
<span id="cb63-1074"><a href="#cb63-1074" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"cache"</span>)) {</span>
<span id="cb63-1075"><a href="#cb63-1075" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="st">"cache"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1076"><a href="#cb63-1076" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-1077"><a href="#cb63-1077" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-1078"><a href="#cb63-1078" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start timing</span></span>
<span id="cb63-1079"><a href="#cb63-1079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>(<span class="st">"H3b simulation total time"</span>)</span>
<span id="cb63-1080"><a href="#cb63-1080" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-1081"><a href="#cb63-1081" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n_sims is already defined above</span></span>
<span id="cb63-1082"><a href="#cb63-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1083"><a href="#cb63-1083" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Running "</span>, <span class="fu">nrow</span>(all_jobs_h3b), <span class="st">" simulations across "</span>, <span class="fu">nbrOfWorkers</span>(), <span class="st">" cores..."</span>)</span>
<span id="cb63-1084"><a href="#cb63-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1085"><a href="#cb63-1085" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run all simulations in parallel</span></span>
<span id="cb63-1086"><a href="#cb63-1086" aria-hidden="true" tabindex="-1"></a>  results_h3b <span class="ot">&lt;-</span> <span class="fu">future_map_dfr</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(all_jobs_h3b), <span class="cf">function</span>(job_idx) {</span>
<span id="cb63-1087"><a href="#cb63-1087" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load required libraries in each worker</span></span>
<span id="cb63-1088"><a href="#cb63-1088" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(tidyverse)</span>
<span id="cb63-1089"><a href="#cb63-1089" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(nlme)</span>
<span id="cb63-1090"><a href="#cb63-1090" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(broom.mixed)</span>
<span id="cb63-1091"><a href="#cb63-1091" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(extraDistr)</span>
<span id="cb63-1092"><a href="#cb63-1092" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(rms)</span>
<span id="cb63-1093"><a href="#cb63-1093" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-1094"><a href="#cb63-1094" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get job parameters</span></span>
<span id="cb63-1095"><a href="#cb63-1095" aria-hidden="true" tabindex="-1"></a>    job <span class="ot">&lt;-</span> all_jobs_h3b[job_idx, ]</span>
<span id="cb63-1096"><a href="#cb63-1096" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-1097"><a href="#cb63-1097" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb63-1098"><a href="#cb63-1098" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">sim_study</span>(</span>
<span id="cb63-1099"><a href="#cb63-1099" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb63-1100"><a href="#cb63-1100" aria-hidden="true" tabindex="-1"></a>        <span class="at">focal_term =</span> job<span class="sc">$</span>focal_term,</span>
<span id="cb63-1101"><a href="#cb63-1101" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="dv">80</span>,</span>
<span id="cb63-1102"><a href="#cb63-1102" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_days =</span> <span class="dv">28</span>,</span>
<span id="cb63-1103"><a href="#cb63-1103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># effect parameters</span></span>
<span id="cb63-1104"><a href="#cb63-1104" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b, <span class="co"># effect in unstandardized units</span></span>
<span id="cb63-1105"><a href="#cb63-1105" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu =</span> <span class="fl">78.5</span>, <span class="co"># grand mean of the outcome</span></span>
<span id="cb63-1106"><a href="#cb63-1106" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape,</span>
<span id="cb63-1107"><a href="#cb63-1107" aria-hidden="true" tabindex="-1"></a>        <span class="at">k =</span> .<span class="dv">5</span>,</span>
<span id="cb63-1108"><a href="#cb63-1108" aria-hidden="true" tabindex="-1"></a>        <span class="co"># random effects parameters</span></span>
<span id="cb63-1109"><a href="#cb63-1109" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_int =</span> <span class="fl">9.7</span>,   <span class="co"># Random intercept SD (between-person variance)</span></span>
<span id="cb63-1110"><a href="#cb63-1110" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_slope =</span> .<span class="dv">8</span>,  <span class="co"># Random slope SD </span></span>
<span id="cb63-1111"><a href="#cb63-1111" aria-hidden="true" tabindex="-1"></a>        <span class="at">within_person_sd =</span> <span class="fl">11.8</span>, <span class="co"># Within-person SD</span></span>
<span id="cb63-1112"><a href="#cb63-1112" aria-hidden="true" tabindex="-1"></a>        <span class="co"># AR(1) parameters</span></span>
<span id="cb63-1113"><a href="#cb63-1113" aria-hidden="true" tabindex="-1"></a>        <span class="at">phi =</span> <span class="fl">0.7</span>,     <span class="co"># Autocorrelation coefficient</span></span>
<span id="cb63-1114"><a href="#cb63-1114" aria-hidden="true" tabindex="-1"></a>        <span class="at">mediated =</span> <span class="cn">TRUE</span></span>
<span id="cb63-1115"><a href="#cb63-1115" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb63-1116"><a href="#cb63-1116" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb63-1117"><a href="#cb63-1117" aria-hidden="true" tabindex="-1"></a>          <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb63-1118"><a href="#cb63-1118" aria-hidden="true" tabindex="-1"></a>          <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb63-1119"><a href="#cb63-1119" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb63-1120"><a href="#cb63-1120" aria-hidden="true" tabindex="-1"></a>          <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb63-1121"><a href="#cb63-1121" aria-hidden="true" tabindex="-1"></a>          <span class="at">expected_effect =</span> job<span class="sc">$</span>expected_effect,</span>
<span id="cb63-1122"><a href="#cb63-1122" aria-hidden="true" tabindex="-1"></a>          <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb63-1123"><a href="#cb63-1123" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb63-1124"><a href="#cb63-1124" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb63-1125"><a href="#cb63-1125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(result)</span>
<span id="cb63-1126"><a href="#cb63-1126" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb63-1127"><a href="#cb63-1127" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Only show debug messages if debug mode is enabled and in interactive mode</span></span>
<span id="cb63-1128"><a href="#cb63-1128" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"debug_mode"</span>, <span class="cn">FALSE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">interactive</span>()) {</span>
<span id="cb63-1129"><a href="#cb63-1129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Job "</span>, job_idx, <span class="st">" (spec row: "</span>, job<span class="sc">$</span>i, <span class="st">", sim: "</span>, job<span class="sc">$</span>sim, <span class="st">") failed: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb63-1130"><a href="#cb63-1130" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb63-1131"><a href="#cb63-1131" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb63-1132"><a href="#cb63-1132" aria-hidden="true" tabindex="-1"></a>        <span class="at">term =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb63-1133"><a href="#cb63-1133" aria-hidden="true" tabindex="-1"></a>        <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-1134"><a href="#cb63-1134" aria-hidden="true" tabindex="-1"></a>        <span class="at">std.error =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-1135"><a href="#cb63-1135" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.low =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-1136"><a href="#cb63-1136" aria-hidden="true" tabindex="-1"></a>        <span class="at">conf.high =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb63-1137"><a href="#cb63-1137" aria-hidden="true" tabindex="-1"></a>        <span class="at">sim =</span> job<span class="sc">$</span>sim,</span>
<span id="cb63-1138"><a href="#cb63-1138" aria-hidden="true" tabindex="-1"></a>        <span class="at">row_id =</span> job<span class="sc">$</span>row_id,</span>
<span id="cb63-1139"><a href="#cb63-1139" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> job<span class="sc">$</span>model,</span>
<span id="cb63-1140"><a href="#cb63-1140" aria-hidden="true" tabindex="-1"></a>        <span class="at">b =</span> job<span class="sc">$</span>b,</span>
<span id="cb63-1141"><a href="#cb63-1141" aria-hidden="true" tabindex="-1"></a>        <span class="at">expected_effect =</span> job<span class="sc">$</span>expected_effect,</span>
<span id="cb63-1142"><a href="#cb63-1142" aria-hidden="true" tabindex="-1"></a>        <span class="at">effect_shape =</span> job<span class="sc">$</span>effect_shape</span>
<span id="cb63-1143"><a href="#cb63-1143" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-1144"><a href="#cb63-1144" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-1145"><a href="#cb63-1145" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">.progress =</span> <span class="cn">TRUE</span>,</span>
<span id="cb63-1146"><a href="#cb63-1146" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options =</span> <span class="fu">furrr_options</span>(</span>
<span id="cb63-1147"><a href="#cb63-1147" aria-hidden="true" tabindex="-1"></a>    <span class="at">globals =</span> <span class="fu">c</span>(<span class="st">"all_jobs_h3b"</span>, <span class="st">"sim_study"</span>, <span class="st">"sim_data"</span>, <span class="st">"fit_mlm_reduction"</span>, <span class="st">"fit_mlm_reduction_robust"</span>,</span>
<span id="cb63-1148"><a href="#cb63-1148" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sim_dropout"</span>,</span>
<span id="cb63-1149"><a href="#cb63-1149" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gam"</span>, <span class="st">"fit_gam_no_main"</span>, <span class="st">"fit_mlm"</span>, <span class="st">"fit_mlm_simple"</span>, </span>
<span id="cb63-1150"><a href="#cb63-1150" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fit_gls"</span>, <span class="st">"fit_gls_simple"</span>, <span class="st">"fit_gls_spline"</span>, <span class="st">"extract_marginal_effect"</span>),</span>
<span id="cb63-1151"><a href="#cb63-1151" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">TRUE</span></span>
<span id="cb63-1152"><a href="#cb63-1152" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb63-1153"><a href="#cb63-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1154"><a href="#cb63-1154" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3b <span class="ot">&lt;-</span> results_h3b <span class="sc">|&gt;</span> </span>
<span id="cb63-1155"><a href="#cb63-1155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(row_id) <span class="sc">|&gt;</span> </span>
<span id="cb63-1156"><a href="#cb63-1156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb63-1157"><a href="#cb63-1157" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">first</span>(model),</span>
<span id="cb63-1158"><a href="#cb63-1158" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">first</span>(b),</span>
<span id="cb63-1159"><a href="#cb63-1159" aria-hidden="true" tabindex="-1"></a>      <span class="at">expected_effect =</span> <span class="fu">first</span>(expected_effect),</span>
<span id="cb63-1160"><a href="#cb63-1160" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_shape =</span> <span class="fu">first</span>(effect_shape),</span>
<span id="cb63-1161"><a href="#cb63-1161" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_effect =</span> <span class="fu">mean</span>(estimate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1162"><a href="#cb63-1162" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1163"><a href="#cb63-1163" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.low =</span> <span class="fu">mean</span>(conf.low, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1164"><a href="#cb63-1164" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.high =</span> <span class="fu">mean</span>(conf.high, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1165"><a href="#cb63-1165" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Correct power calculation based on model type</span></span>
<span id="cb63-1166"><a href="#cb63-1166" aria-hidden="true" tabindex="-1"></a>      <span class="at">power =</span> <span class="fu">if_else</span>(</span>
<span id="cb63-1167"><a href="#cb63-1167" aria-hidden="true" tabindex="-1"></a>        <span class="fu">first</span>(model) <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>,</span>
<span id="cb63-1168"><a href="#cb63-1168" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.high <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.high)),  <span class="co"># Robust expects negative</span></span>
<span id="cb63-1169"><a href="#cb63-1169" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.low <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.low))     <span class="co"># Change score expects positive</span></span>
<span id="cb63-1170"><a href="#cb63-1170" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-1171"><a href="#cb63-1171" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-1172"><a href="#cb63-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1173"><a href="#cb63-1173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stop timing and display results</span></span>
<span id="cb63-1174"><a href="#cb63-1174" aria-hidden="true" tabindex="-1"></a>  h3b_time <span class="ot">&lt;-</span> <span class="fu">toc</span>()</span>
<span id="cb63-1175"><a href="#cb63-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1176"><a href="#cb63-1176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save results to cache</span></span>
<span id="cb63-1177"><a href="#cb63-1177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_h3b, cache_file_h3b)</span>
<span id="cb63-1178"><a href="#cb63-1178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(sim_summary_h3b, cache_summary_h3b)</span>
<span id="cb63-1179"><a href="#cb63-1179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(current_params_h3b, cache_params_h3b)</span>
<span id="cb63-1180"><a href="#cb63-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"H3b simulation results saved to cache!"</span>)</span>
<span id="cb63-1181"><a href="#cb63-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1182"><a href="#cb63-1182" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End of else block for cached results</span></span>
<span id="cb63-1183"><a href="#cb63-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1184"><a href="#cb63-1184" aria-hidden="true" tabindex="-1"></a><span class="co"># Also print some summary statistics about the simulation</span></span>
<span id="cb63-1185"><a href="#cb63-1185" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"=== H3B SIMULATION SUMMARY ==="</span>)</span>
<span id="cb63-1186"><a href="#cb63-1186" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Total number of jobs: "</span>, <span class="fu">nrow</span>(all_jobs_h3b))</span>
<span id="cb63-1187"><a href="#cb63-1187" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of successful results: "</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3b<span class="sc">$</span>estimate)))</span>
<span id="cb63-1188"><a href="#cb63-1188" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Number of failed jobs: "</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(results_h3b<span class="sc">$</span>estimate)))</span>
<span id="cb63-1189"><a href="#cb63-1189" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Success rate: "</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(results_h3b<span class="sc">$</span>estimate)) <span class="sc">/</span> <span class="fu">nrow</span>(results_h3b), <span class="dv">1</span>), <span class="st">"%"</span>)</span>
<span id="cb63-1190"><a href="#cb63-1190" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"==============================="</span>)</span>
<span id="cb63-1191"><a href="#cb63-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1192"><a href="#cb63-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1193"><a href="#cb63-1193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1194"><a href="#cb63-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1197"><a href="#cb63-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1198"><a href="#cb63-1198" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualize-power-h3b</span></span>
<span id="cb63-1199"><a href="#cb63-1199" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (visualize power h3b)"</span></span>
<span id="cb63-1200"><a href="#cb63-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1201"><a href="#cb63-1201" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated effect vs. true effect (b)</span></span>
<span id="cb63-1202"><a href="#cb63-1202" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3b, <span class="fu">aes</span>(<span class="at">x =</span> expected_effect, </span>
<span id="cb63-1203"><a href="#cb63-1203" aria-hidden="true" tabindex="-1"></a>                            <span class="at">y =</span> <span class="fu">ifelse</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>, </span>
<span id="cb63-1204"><a href="#cb63-1204" aria-hidden="true" tabindex="-1"></a>                                      <span class="sc">-</span>mean_effect, mean_effect), </span>
<span id="cb63-1205"><a href="#cb63-1205" aria-hidden="true" tabindex="-1"></a>                            <span class="at">color =</span> model, <span class="at">shape =</span> model)) <span class="sc">+</span></span>
<span id="cb63-1206"><a href="#cb63-1206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb63-1207"><a href="#cb63-1207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="fu">ifelse</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>, </span>
<span id="cb63-1208"><a href="#cb63-1208" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">-</span>mean_conf.high, mean_conf.low), </span>
<span id="cb63-1209"><a href="#cb63-1209" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax =</span> <span class="fu">ifelse</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>, </span>
<span id="cb63-1210"><a href="#cb63-1210" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">-</span>mean_conf.low, mean_conf.high)), </span>
<span id="cb63-1211"><a href="#cb63-1211" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.01</span>) <span class="sc">+</span></span>
<span id="cb63-1212"><a href="#cb63-1212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb63-1213"><a href="#cb63-1213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb63-1214"><a href="#cb63-1214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect Magnitude (expected effect)"</span>, </span>
<span id="cb63-1215"><a href="#cb63-1215" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Estimated Effect Magnitude"</span>,</span>
<span id="cb63-1216"><a href="#cb63-1216" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Estimated vs. True Effects by Per-Protocol Model and Effect Shape"</span>,</span>
<span id="cb63-1217"><a href="#cb63-1217" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Effects shown as absolute magnitudes for comparison"</span>,</span>
<span id="cb63-1218"><a href="#cb63-1218" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Per-Protocol Model"</span>, <span class="at">shape =</span> <span class="st">"Per-Protocol Model"</span>) <span class="sc">+</span></span>
<span id="cb63-1219"><a href="#cb63-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>),</span>
<span id="cb63-1220"><a href="#cb63-1220" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect"</span>)) <span class="sc">+</span></span>
<span id="cb63-1221"><a href="#cb63-1221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"#2E8B57"</span>, </span>
<span id="cb63-1222"><a href="#cb63-1222" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"#FF6347"</span>),</span>
<span id="cb63-1223"><a href="#cb63-1223" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb63-1224"><a href="#cb63-1224" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>)) <span class="sc">+</span></span>
<span id="cb63-1225"><a href="#cb63-1225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="dv">16</span>, </span>
<span id="cb63-1226"><a href="#cb63-1226" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="dv">17</span>),</span>
<span id="cb63-1227"><a href="#cb63-1227" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb63-1228"><a href="#cb63-1228" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>))</span>
<span id="cb63-1229"><a href="#cb63-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1230"><a href="#cb63-1230" aria-hidden="true" tabindex="-1"></a><span class="co"># Power vs. true effect (b)</span></span>
<span id="cb63-1231"><a href="#cb63-1231" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_summary_h3b, <span class="fu">aes</span>(<span class="at">x =</span> expected_effect, <span class="at">y =</span> power, </span>
<span id="cb63-1232"><a href="#cb63-1232" aria-hidden="true" tabindex="-1"></a>                            <span class="at">color =</span> model, <span class="at">shape =</span> model, <span class="at">linetype =</span> model)) <span class="sc">+</span></span>
<span id="cb63-1233"><a href="#cb63-1233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb63-1234"><a href="#cb63-1234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb63-1235"><a href="#cb63-1235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> effect_shape) <span class="sc">+</span></span>
<span id="cb63-1236"><a href="#cb63-1236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True Effect (expected effect)"</span>, <span class="at">y =</span> <span class="st">"Power"</span>,</span>
<span id="cb63-1237"><a href="#cb63-1237" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Power by Per-Protocol Model and Effect Shape"</span>,</span>
<span id="cb63-1238"><a href="#cb63-1238" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Per-Protocol Model"</span>, <span class="at">shape =</span> <span class="st">"Per-Protocol Model"</span>, <span class="at">linetype =</span> <span class="st">"Per-Protocol Model"</span>) <span class="sc">+</span></span>
<span id="cb63-1239"><a href="#cb63-1239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>),</span>
<span id="cb63-1240"><a href="#cb63-1240" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> <span class="dv">12</span>, <span class="at">name =</span> <span class="st">"Standardized Effect"</span>)) <span class="sc">+</span></span>
<span id="cb63-1241"><a href="#cb63-1241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb63-1242"><a href="#cb63-1242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"#2E8B57"</span>, </span>
<span id="cb63-1243"><a href="#cb63-1243" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"#FF6347"</span>),</span>
<span id="cb63-1244"><a href="#cb63-1244" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb63-1245"><a href="#cb63-1245" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>)) <span class="sc">+</span></span>
<span id="cb63-1246"><a href="#cb63-1246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="dv">16</span>, </span>
<span id="cb63-1247"><a href="#cb63-1247" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="dv">17</span>),</span>
<span id="cb63-1248"><a href="#cb63-1248" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb63-1249"><a href="#cb63-1249" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>)) <span class="sc">+</span></span>
<span id="cb63-1250"><a href="#cb63-1250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"solid"</span>, </span>
<span id="cb63-1251"><a href="#cb63-1251" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"dashed"</span>),</span>
<span id="cb63-1252"><a href="#cb63-1252" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"fit_mlm_reduction"</span> <span class="ot">=</span> <span class="st">"Change Score Approach"</span>, </span>
<span id="cb63-1253"><a href="#cb63-1253" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"fit_mlm_reduction_robust"</span> <span class="ot">=</span> <span class="st">"Robust Approach"</span>))</span>
<span id="cb63-1254"><a href="#cb63-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1255"><a href="#cb63-1255" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics comparing the two per-protocol approaches</span></span>
<span id="cb63-1256"><a href="#cb63-1256" aria-hidden="true" tabindex="-1"></a>protocol_comparison <span class="ot">&lt;-</span> sim_summary_h3b <span class="sc">|&gt;</span></span>
<span id="cb63-1257"><a href="#cb63-1257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb63-1258"><a href="#cb63-1258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb63-1259"><a href="#cb63-1259" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_power =</span> <span class="fu">mean</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1260"><a href="#cb63-1260" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power =</span> <span class="fu">max</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1261"><a href="#cb63-1261" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_power =</span> <span class="fu">min</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1262"><a href="#cb63-1262" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_bias =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(mean_effect <span class="sc">-</span> expected_effect), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1263"><a href="#cb63-1263" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb63-1264"><a href="#cb63-1264" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-1265"><a href="#cb63-1265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-1266"><a href="#cb63-1266" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_name =</span> <span class="fu">case_when</span>(</span>
<span id="cb63-1267"><a href="#cb63-1267" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span> <span class="sc">~</span> <span class="st">"Change Score Approach"</span>,</span>
<span id="cb63-1268"><a href="#cb63-1268" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span> <span class="sc">~</span> <span class="st">"Robust Approach"</span></span>
<span id="cb63-1269"><a href="#cb63-1269" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-1270"><a href="#cb63-1270" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-1271"><a href="#cb63-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1272"><a href="#cb63-1272" aria-hidden="true" tabindex="-1"></a><span class="co"># Display comparison table</span></span>
<span id="cb63-1273"><a href="#cb63-1273" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb63-1274"><a href="#cb63-1274" aria-hidden="true" tabindex="-1"></a>  protocol_comparison,</span>
<span id="cb63-1275"><a href="#cb63-1275" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">"Comparison of Per-Protocol Approaches for Wellbeing Analysis"</span>,</span>
<span id="cb63-1276"><a href="#cb63-1276" aria-hidden="true" tabindex="-1"></a>  <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Effect Shape"</span>, <span class="st">"Mean Power"</span>, <span class="st">"Max Power"</span>, <span class="st">"Min Power"</span>, <span class="st">"Mean Bias"</span>, <span class="st">"Model Name"</span>),</span>
<span id="cb63-1277"><a href="#cb63-1277" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">3</span></span>
<span id="cb63-1278"><a href="#cb63-1278" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-1279"><a href="#cb63-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1280"><a href="#cb63-1280" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary comparison</span></span>
<span id="cb63-1281"><a href="#cb63-1281" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== PER-PROTOCOL APPROACH COMPARISON ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1282"><a href="#cb63-1282" aria-hidden="true" tabindex="-1"></a>change_score_power <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_summary_h3b<span class="sc">$</span>power[sim_summary_h3b<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1283"><a href="#cb63-1283" aria-hidden="true" tabindex="-1"></a>robust_power <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_summary_h3b<span class="sc">$</span>power[sim_summary_h3b<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1284"><a href="#cb63-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1285"><a href="#cb63-1285" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Change Score Approach - Mean Power: %.3f</span><span class="sc">\n</span><span class="st">"</span>, change_score_power))</span>
<span id="cb63-1286"><a href="#cb63-1286" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Robust Approach - Mean Power: %.3f</span><span class="sc">\n</span><span class="st">"</span>, robust_power))</span>
<span id="cb63-1287"><a href="#cb63-1287" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Difference: %.3f (robust approach is %.1f%% %s)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-1288"><a href="#cb63-1288" aria-hidden="true" tabindex="-1"></a>            robust_power <span class="sc">-</span> change_score_power,</span>
<span id="cb63-1289"><a href="#cb63-1289" aria-hidden="true" tabindex="-1"></a>            <span class="fu">abs</span>(robust_power <span class="sc">-</span> change_score_power) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb63-1290"><a href="#cb63-1290" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(robust_power <span class="sc">&gt;</span> change_score_power, <span class="st">"higher"</span>, <span class="st">"lower"</span>)))</span>
<span id="cb63-1291"><a href="#cb63-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1292"><a href="#cb63-1292" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== IMPORTANT NOTE ON INTERPRETATION ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1293"><a href="#cb63-1293" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The two per-protocol models test subtly different hypotheses:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1294"><a href="#cb63-1294" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Change Score Model: Tests if reduction in playtime improves wellbeing (positive coefficient expected)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1295"><a href="#cb63-1295" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Robust Model: Tests if lower playtime is associated with better wellbeing during intervention (negative coefficient expected)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1296"><a href="#cb63-1296" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Both approaches test the same underlying phenomenon but from different angles.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1297"><a href="#cb63-1297" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=========================================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1298"><a href="#cb63-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1299"><a href="#cb63-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1300"><a href="#cb63-1300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1301"><a href="#cb63-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1302"><a href="#cb63-1302" aria-hidden="true" tabindex="-1"></a><span class="fu">### Minimum Detectable Effect Sizes at 80% Power (H3b - Per-Protocol)</span></span>
<span id="cb63-1303"><a href="#cb63-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1306"><a href="#cb63-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1307"><a href="#cb63-1307" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: h3b-power-table</span></span>
<span id="cb63-1308"><a href="#cb63-1308" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (H3b minimum detectable effects table)"</span></span>
<span id="cb63-1309"><a href="#cb63-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1310"><a href="#cb63-1310" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to interpolate minimum detectable effect at 80% power for H3b</span></span>
<span id="cb63-1311"><a href="#cb63-1311" aria-hidden="true" tabindex="-1"></a>find_mde_80_h3b <span class="ot">&lt;-</span> <span class="cf">function</span>(power_data) {</span>
<span id="cb63-1312"><a href="#cb63-1312" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we already have 80% power or higher at the smallest effect, return that</span></span>
<span id="cb63-1313"><a href="#cb63-1313" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">min</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;=</span> <span class="fl">0.8</span>) {</span>
<span id="cb63-1314"><a href="#cb63-1314" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">min</span>(power_data<span class="sc">$</span>expected_effect, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb63-1315"><a href="#cb63-1315" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-1316"><a href="#cb63-1316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-1317"><a href="#cb63-1317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If we never reach 80% power, return NA</span></span>
<span id="cb63-1318"><a href="#cb63-1318" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(power_data<span class="sc">$</span>power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&lt;</span> <span class="fl">0.8</span>) {</span>
<span id="cb63-1319"><a href="#cb63-1319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb63-1320"><a href="#cb63-1320" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-1321"><a href="#cb63-1321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-1322"><a href="#cb63-1322" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear interpolation to find effect size at 80% power</span></span>
<span id="cb63-1323"><a href="#cb63-1323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">approx</span>(<span class="at">x =</span> power_data<span class="sc">$</span>power, <span class="at">y =</span> power_data<span class="sc">$</span>expected_effect, <span class="at">xout =</span> <span class="fl">0.8</span>)<span class="sc">$</span>y</span>
<span id="cb63-1324"><a href="#cb63-1324" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-1325"><a href="#cb63-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1326"><a href="#cb63-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate minimum detectable effects for each H3b model and effect shape</span></span>
<span id="cb63-1327"><a href="#cb63-1327" aria-hidden="true" tabindex="-1"></a>mde_table_h3b <span class="ot">&lt;-</span> sim_summary_h3b <span class="sc">|&gt;</span></span>
<span id="cb63-1328"><a href="#cb63-1328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model, effect_shape) <span class="sc">|&gt;</span></span>
<span id="cb63-1329"><a href="#cb63-1329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb63-1330"><a href="#cb63-1330" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_expected =</span> <span class="fu">find_mde_80_h3b</span>(<span class="fu">cur_data</span>()),</span>
<span id="cb63-1331"><a href="#cb63-1331" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized =</span> mde_80_expected <span class="sc">/</span> <span class="dv">12</span>,  <span class="co"># Convert to standardized units</span></span>
<span id="cb63-1332"><a href="#cb63-1332" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power =</span> <span class="fu">max</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1333"><a href="#cb63-1333" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_power =</span> <span class="fu">mean</span>(power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1334"><a href="#cb63-1334" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb63-1335"><a href="#cb63-1335" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-1336"><a href="#cb63-1336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(effect_shape, mde_80_standardized) <span class="sc">|&gt;</span></span>
<span id="cb63-1337"><a href="#cb63-1337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-1338"><a href="#cb63-1338" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up model names for presentation</span></span>
<span id="cb63-1339"><a href="#cb63-1339" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb63-1340"><a href="#cb63-1340" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span> <span class="sc">~</span> <span class="st">"MLM Reduction (Change Score)"</span>,</span>
<span id="cb63-1341"><a href="#cb63-1341" aria-hidden="true" tabindex="-1"></a>      model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span> <span class="sc">~</span> <span class="st">"MLM Reduction (Robust)"</span>,</span>
<span id="cb63-1342"><a href="#cb63-1342" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> model</span>
<span id="cb63-1343"><a href="#cb63-1343" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-1344"><a href="#cb63-1344" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format effect sizes for display</span></span>
<span id="cb63-1345"><a href="#cb63-1345" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_expected_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_expected), </span>
<span id="cb63-1346"><a href="#cb63-1346" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"&gt;0.50"</span>, </span>
<span id="cb63-1347"><a href="#cb63-1347" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, mde_80_expected)),</span>
<span id="cb63-1348"><a href="#cb63-1348" aria-hidden="true" tabindex="-1"></a>    <span class="at">mde_80_standardized_fmt =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(mde_80_standardized), </span>
<span id="cb63-1349"><a href="#cb63-1349" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"&gt;0.042"</span>, </span>
<span id="cb63-1350"><a href="#cb63-1350" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, mde_80_standardized)),</span>
<span id="cb63-1351"><a href="#cb63-1351" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_power_fmt =</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, max_power <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb63-1352"><a href="#cb63-1352" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_power_fmt =</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, mean_power <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb63-1353"><a href="#cb63-1353" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-1354"><a href="#cb63-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1355"><a href="#cb63-1355" aria-hidden="true" tabindex="-1"></a><span class="co"># Create formatted table for H3b</span></span>
<span id="cb63-1356"><a href="#cb63-1356" aria-hidden="true" tabindex="-1"></a>mde_table_h3b <span class="sc">|&gt;</span></span>
<span id="cb63-1357"><a href="#cb63-1357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb63-1358"><a href="#cb63-1358" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Effect Shape</span><span class="st">`</span> <span class="ot">=</span> effect_shape,</span>
<span id="cb63-1359"><a href="#cb63-1359" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Model</span><span class="st">`</span> <span class="ot">=</span> model_clean,</span>
<span id="cb63-1360"><a href="#cb63-1360" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Expected Effect)</span><span class="st">`</span> <span class="ot">=</span> mde_80_expected_fmt,</span>
<span id="cb63-1361"><a href="#cb63-1361" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">MDE (Standardized)</span><span class="st">`</span> <span class="ot">=</span> mde_80_standardized_fmt,</span>
<span id="cb63-1362"><a href="#cb63-1362" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Mean Power</span><span class="st">`</span> <span class="ot">=</span> mean_power_fmt,</span>
<span id="cb63-1363"><a href="#cb63-1363" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Max Power Achieved</span><span class="st">`</span> <span class="ot">=</span> max_power_fmt</span>
<span id="cb63-1364"><a href="#cb63-1364" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-1365"><a href="#cb63-1365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb63-1366"><a href="#cb63-1366" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Minimum Detectable Effect Sizes at 80% Power - H3b Per-Protocol Models"</span>,</span>
<span id="cb63-1367"><a href="#cb63-1367" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>)</span>
<span id="cb63-1368"><a href="#cb63-1368" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-1369"><a href="#cb63-1369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(</span>
<span id="cb63-1370"><a href="#cb63-1370" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>),</span>
<span id="cb63-1371"><a href="#cb63-1371" aria-hidden="true" tabindex="-1"></a>    <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb63-1372"><a href="#cb63-1372" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"left"</span></span>
<span id="cb63-1373"><a href="#cb63-1373" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-1374"><a href="#cb63-1374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Growing Effect"</span>, <span class="dv">1</span>, <span class="fu">sum</span>(mde_table_h3b<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb63-1375"><a href="#cb63-1375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pack_rows</span>(<span class="st">"Plateau Effect"</span>, <span class="fu">sum</span>(mde_table_h3b<span class="sc">$</span>effect_shape <span class="sc">==</span> <span class="st">"grow"</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">nrow</span>(mde_table_h3b)) <span class="sc">|&gt;</span></span>
<span id="cb63-1376"><a href="#cb63-1376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">footnote</span>(</span>
<span id="cb63-1377"><a href="#cb63-1377" aria-hidden="true" tabindex="-1"></a>    <span class="at">general =</span> <span class="fu">c</span>(</span>
<span id="cb63-1378"><a href="#cb63-1378" aria-hidden="true" tabindex="-1"></a>      <span class="st">"MDE = Minimum Detectable Effect size at 80% power"</span>,</span>
<span id="cb63-1379"><a href="#cb63-1379" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Expected Effect = b × average compliance (accounting for Kumaraswamy distribution)"</span>, </span>
<span id="cb63-1380"><a href="#cb63-1380" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Standardized effects calculated as expected effect / 12"</span>,</span>
<span id="cb63-1381"><a href="#cb63-1381" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Change Score Model tests if reduction improves wellbeing (positive effect)"</span>,</span>
<span id="cb63-1382"><a href="#cb63-1382" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Robust Model tests if lower playtime improves wellbeing (negative effect)"</span>,</span>
<span id="cb63-1383"><a href="#cb63-1383" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Both models are testing the same underlying hypothesis from different angles"</span></span>
<span id="cb63-1384"><a href="#cb63-1384" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-1385"><a href="#cb63-1385" aria-hidden="true" tabindex="-1"></a>    <span class="at">general_title =</span> <span class="st">"Notes:"</span></span>
<span id="cb63-1386"><a href="#cb63-1386" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-1387"><a href="#cb63-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1388"><a href="#cb63-1388" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics for H3b</span></span>
<span id="cb63-1389"><a href="#cb63-1389" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== H3B MODEL SENSITIVITY COMPARISON ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1390"><a href="#cb63-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1391"><a href="#cb63-1391" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare models within each effect shape</span></span>
<span id="cb63-1392"><a href="#cb63-1392" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (shape <span class="cf">in</span> <span class="fu">unique</span>(mde_table_h3b<span class="sc">$</span>effect_shape)) {</span>
<span id="cb63-1393"><a href="#cb63-1393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">%s effects:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">str_to_title</span>(shape)))</span>
<span id="cb63-1394"><a href="#cb63-1394" aria-hidden="true" tabindex="-1"></a>  shape_models <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span> <span class="fu">filter</span>(effect_shape <span class="sc">==</span> shape)</span>
<span id="cb63-1395"><a href="#cb63-1395" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(shape_models)) {</span>
<span id="cb63-1396"><a href="#cb63-1396" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(shape_models<span class="sc">$</span>mde_80_standardized[i])) {</span>
<span id="cb63-1397"><a href="#cb63-1397" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %s: %.3f standardized effect (%.1f%% mean power)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-1398"><a href="#cb63-1398" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>model_clean[i], </span>
<span id="cb63-1399"><a href="#cb63-1399" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>mde_80_standardized[i],</span>
<span id="cb63-1400"><a href="#cb63-1400" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>mean_power[i] <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb63-1401"><a href="#cb63-1401" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb63-1402"><a href="#cb63-1402" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %s: &gt;0.042 standardized effect (%.1f%% max power achieved)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-1403"><a href="#cb63-1403" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>model_clean[i],</span>
<span id="cb63-1404"><a href="#cb63-1404" aria-hidden="true" tabindex="-1"></a>                  shape_models<span class="sc">$</span>max_power[i] <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb63-1405"><a href="#cb63-1405" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-1406"><a href="#cb63-1406" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-1407"><a href="#cb63-1407" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-1408"><a href="#cb63-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1409"><a href="#cb63-1409" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall comparison</span></span>
<span id="cb63-1410"><a href="#cb63-1410" aria-hidden="true" tabindex="-1"></a>overall_best_h3b <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span></span>
<span id="cb63-1411"><a href="#cb63-1411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mde_80_standardized)) <span class="sc">|&gt;</span></span>
<span id="cb63-1412"><a href="#cb63-1412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(mde_80_standardized, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb63-1413"><a href="#cb63-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1414"><a href="#cb63-1414" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(overall_best_h3b) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb63-1415"><a href="#cb63-1415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Most sensitive H3b model: %s (%s effects)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-1416"><a href="#cb63-1416" aria-hidden="true" tabindex="-1"></a>              overall_best_h3b<span class="sc">$</span>model_clean, overall_best_h3b<span class="sc">$</span>effect_shape))</span>
<span id="cb63-1417"><a href="#cb63-1417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"MDE at 80%% power: %.3f standardized effect (%.2f expected effect)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb63-1418"><a href="#cb63-1418" aria-hidden="true" tabindex="-1"></a>              overall_best_h3b<span class="sc">$</span>mde_80_standardized, overall_best_h3b<span class="sc">$</span>mde_80_expected))</span>
<span id="cb63-1419"><a href="#cb63-1419" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb63-1420"><a href="#cb63-1420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Note: No H3b models achieved 80% power within the tested effect range.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1421"><a href="#cb63-1421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"All models have high sensitivity for detecting per-protocol effects.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1422"><a href="#cb63-1422" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-1423"><a href="#cb63-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1424"><a href="#cb63-1424" aria-hidden="true" tabindex="-1"></a><span class="co"># Power comparison between approaches</span></span>
<span id="cb63-1425"><a href="#cb63-1425" aria-hidden="true" tabindex="-1"></a>change_score_data <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span>)</span>
<span id="cb63-1426"><a href="#cb63-1426" aria-hidden="true" tabindex="-1"></a>robust_data <span class="ot">&lt;-</span> mde_table_h3b <span class="sc">|&gt;</span> <span class="fu">filter</span>(model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>)</span>
<span id="cb63-1427"><a href="#cb63-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1428"><a href="#cb63-1428" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Approach Comparison (averaged across effect shapes):</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb63-1429"><a href="#cb63-1429" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Change Score Approach - Mean Power: %.1f%%, Max Power: %.1f%%</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-1430"><a href="#cb63-1430" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(change_score_data<span class="sc">$</span>mean_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb63-1431"><a href="#cb63-1431" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(change_score_data<span class="sc">$</span>max_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb63-1432"><a href="#cb63-1432" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Robust Approach - Mean Power: %.1f%%, Max Power: %.1f%%</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb63-1433"><a href="#cb63-1433" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(robust_data<span class="sc">$</span>mean_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb63-1434"><a href="#cb63-1434" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(robust_data<span class="sc">$</span>max_power, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb63-1435"><a href="#cb63-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1436"><a href="#cb63-1436" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"==========================================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1437"><a href="#cb63-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1438"><a href="#cb63-1438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1439"><a href="#cb63-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1440"><a href="#cb63-1440" aria-hidden="true" tabindex="-1"></a><span class="fu">## Recalculating H3b Power with Corrected Interpretation</span></span>
<span id="cb63-1441"><a href="#cb63-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1442"><a href="#cb63-1442" aria-hidden="true" tabindex="-1"></a>If you have already run the simulations and need to recalculate the power with the correct interpretation:</span>
<span id="cb63-1443"><a href="#cb63-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1446"><a href="#cb63-1446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1447"><a href="#cb63-1447" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: recalculate-h3b-power</span></span>
<span id="cb63-1448"><a href="#cb63-1448" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb63-1449"><a href="#cb63-1449" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Recalculate H3b power with corrected interpretation"</span></span>
<span id="cb63-1450"><a href="#cb63-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1451"><a href="#cb63-1451" aria-hidden="true" tabindex="-1"></a><span class="co"># If you already have results_h3b from a previous simulation run:</span></span>
<span id="cb63-1452"><a href="#cb63-1452" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"results_h3b"</span>)) {</span>
<span id="cb63-1453"><a href="#cb63-1453" aria-hidden="true" tabindex="-1"></a>  sim_summary_h3b_corrected <span class="ot">&lt;-</span> results_h3b <span class="sc">|&gt;</span> </span>
<span id="cb63-1454"><a href="#cb63-1454" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(row_id) <span class="sc">|&gt;</span> </span>
<span id="cb63-1455"><a href="#cb63-1455" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb63-1456"><a href="#cb63-1456" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">first</span>(model),</span>
<span id="cb63-1457"><a href="#cb63-1457" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">first</span>(b),</span>
<span id="cb63-1458"><a href="#cb63-1458" aria-hidden="true" tabindex="-1"></a>      <span class="at">expected_effect =</span> <span class="fu">first</span>(expected_effect),</span>
<span id="cb63-1459"><a href="#cb63-1459" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_shape =</span> <span class="fu">first</span>(effect_shape),</span>
<span id="cb63-1460"><a href="#cb63-1460" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_effect =</span> <span class="fu">mean</span>(estimate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1461"><a href="#cb63-1461" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_se =</span> <span class="fu">mean</span>(std.error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1462"><a href="#cb63-1462" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.low =</span> <span class="fu">mean</span>(conf.low, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1463"><a href="#cb63-1463" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_conf.high =</span> <span class="fu">mean</span>(conf.high, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-1464"><a href="#cb63-1464" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Correct power calculation based on model type</span></span>
<span id="cb63-1465"><a href="#cb63-1465" aria-hidden="true" tabindex="-1"></a>      <span class="at">power =</span> <span class="fu">if_else</span>(</span>
<span id="cb63-1466"><a href="#cb63-1466" aria-hidden="true" tabindex="-1"></a>        <span class="fu">first</span>(model) <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>,</span>
<span id="cb63-1467"><a href="#cb63-1467" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.high <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.high)),  <span class="co"># Robust expects negative</span></span>
<span id="cb63-1468"><a href="#cb63-1468" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(conf.low <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(conf.low))     <span class="co"># Change score expects positive</span></span>
<span id="cb63-1469"><a href="#cb63-1469" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-1470"><a href="#cb63-1470" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-1471"><a href="#cb63-1471" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-1472"><a href="#cb63-1472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Recalculated H3b summary with corrected power calculation"</span>)</span>
<span id="cb63-1473"><a href="#cb63-1473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Change Score Approach - Mean Power: "</span>, </span>
<span id="cb63-1474"><a href="#cb63-1474" aria-hidden="true" tabindex="-1"></a>          <span class="fu">round</span>(<span class="fu">mean</span>(sim_summary_h3b_corrected<span class="sc">$</span>power[sim_summary_h3b_corrected<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>))</span>
<span id="cb63-1475"><a href="#cb63-1475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Robust Approach - Mean Power: "</span>, </span>
<span id="cb63-1476"><a href="#cb63-1476" aria-hidden="true" tabindex="-1"></a>          <span class="fu">round</span>(<span class="fu">mean</span>(sim_summary_h3b_corrected<span class="sc">$</span>power[sim_summary_h3b_corrected<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"fit_mlm_reduction_robust"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>))</span>
<span id="cb63-1477"><a href="#cb63-1477" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-1478"><a href="#cb63-1478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1479"><a href="#cb63-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1480"><a href="#cb63-1480" aria-hidden="true" tabindex="-1"></a><span class="fu">## Timing Summary</span></span>
<span id="cb63-1481"><a href="#cb63-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1484"><a href="#cb63-1484" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1485"><a href="#cb63-1485" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: timing-summary</span></span>
<span id="cb63-1486"><a href="#cb63-1486" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb63-1487"><a href="#cb63-1487" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show code (timing summary)"</span></span>
<span id="cb63-1488"><a href="#cb63-1488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1489"><a href="#cb63-1489" aria-hidden="true" tabindex="-1"></a><span class="co"># Print timing summary if timing objects exist from tictoc</span></span>
<span id="cb63-1490"><a href="#cb63-1490" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"h3a_time"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"h3b_time"</span>)) {</span>
<span id="cb63-1491"><a href="#cb63-1491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== SIMULATION TIMING SUMMARY ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1492"><a href="#cb63-1492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"H3a simulations took: %.2f minutes</span><span class="sc">\n</span><span class="st">"</span>, (h3a_time<span class="sc">$</span>toc <span class="sc">-</span> h3a_time<span class="sc">$</span>tic) <span class="sc">/</span> <span class="dv">60</span>))</span>
<span id="cb63-1493"><a href="#cb63-1493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"H3b simulations took: %.2f minutes</span><span class="sc">\n</span><span class="st">"</span>, (h3b_time<span class="sc">$</span>toc <span class="sc">-</span> h3b_time<span class="sc">$</span>tic) <span class="sc">/</span> <span class="dv">60</span>))</span>
<span id="cb63-1494"><a href="#cb63-1494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Total simulation time: %.2f minutes</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb63-1495"><a href="#cb63-1495" aria-hidden="true" tabindex="-1"></a>              ((h3a_time<span class="sc">$</span>toc <span class="sc">-</span> h3a_time<span class="sc">$</span>tic) <span class="sc">+</span> (h3b_time<span class="sc">$</span>toc <span class="sc">-</span> h3b_time<span class="sc">$</span>tic)) <span class="sc">/</span> <span class="dv">60</span>))</span>
<span id="cb63-1496"><a href="#cb63-1496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"================================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb63-1497"><a href="#cb63-1497" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-1498"><a href="#cb63-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1499"><a href="#cb63-1499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1500"><a href="#cb63-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1501"><a href="#cb63-1501" aria-hidden="true" tabindex="-1"></a><span class="fu">## Planned Sensitivity Analyses</span></span>
<span id="cb63-1502"><a href="#cb63-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1503"><a href="#cb63-1503" aria-hidden="true" tabindex="-1"></a>We have preregistered several sensitivity analyses to test the robustness of any effects we find. These include:</span>
<span id="cb63-1504"><a href="#cb63-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1505"><a href="#cb63-1505" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>*Day 21 only:* We will estimate the effect of the intervention on day 21 only, to see what the difference between groups is at the end of the intervention period</span>
<span id="cb63-1506"><a href="#cb63-1506" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>*Marginal means:* In H3a, we will use the <span class="in">`emmeans`</span> package to calculate marginal means for each condition and produce a single parameter by integrating across the 14-day period</span>
<span id="cb63-1507"><a href="#cb63-1507" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>*Multilevel model:* We will fit the MLM as defined in Table 1 above, as the second-highest performing model in the simulations (having higher power for linear effects, but lower for non-linear)</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>